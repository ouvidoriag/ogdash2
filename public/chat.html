<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cora - Chat | Ouvidoria Duque de Caxias</title>
    <link rel="icon" type="image/png" href="/dc-logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #0f172a;
        --muted: #94a3b8;
        --primary: #22d3ee;
        --accent: #a78bfa;
      }
      body { 
        background: radial-gradient(1200px 600px at top left, rgba(34,211,238,0.08), transparent 60%), 
                    radial-gradient(1200px 600px at bottom right, rgba(167,139,250,0.08), transparent 60%), 
                    var(--bg); 
      }
      .glass { 
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); 
        box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08); 
        border: 1px solid rgba(255,255,255,0.08); 
      }
      .neon { 
        text-shadow: 0 0 12px rgba(34,211,238,0.65), 0 0 24px rgba(167,139,250,0.45); 
      }
      .glow-ring { 
        box-shadow: 0 0 0 2px rgba(34,211,238,0.15), 0 0 32px rgba(34,211,238,0.25); 
      }
      
      /* Scrollbar moderna */
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll) {
        padding-right: 12px;
        margin-right: -12px;
      }
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll)::-webkit-scrollbar {
        width: 12px;
      }
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll)::-webkit-scrollbar-track {
        background: transparent;
      }
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll)::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #0a0a0a, #1a1a1a);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll)::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #111, #222);
      }
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll) {
        scrollbar-width: thin;
        scrollbar-color: #000000 transparent;
      }
    </style>
  </head>
  <body class="text-slate-100 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="glass border-b border-white/10 p-4">
      <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
            <img src="/dc-logo.png" alt="Duque de Caxias" class="h-10 w-auto object-contain" />
            <div>
              <div class="text-lg font-semibold">Ouvidoria Caxias</div>
              <div class="text-xs text-slate-400">Dashboard Futurista</div>
            </div>
          </a>
        </div>
        <a href="/" class="px-4 py-2 text-sm rounded-lg bg-slate-800/60 border border-white/10 hover:bg-slate-800 transition-colors">
          ‚Üê Voltar ao Dashboard
        </a>
      </div>
    </header>

    <!-- Chat Container -->
    <main class="flex-1 max-w-6xl mx-auto w-full p-6">
      <div class="glass rounded-2xl p-6 mb-6 relative overflow-hidden">
        <div class="absolute inset-0 opacity-30" style="background: radial-gradient(600px 200px at 10% 0%, rgba(167,139,250,0.25), transparent 60%)"></div>
        <div class="relative">
          <h1 class="neon text-2xl font-bold mb-2">üí¨ Cora - Chat</h1>
          <p class="text-slate-400 text-sm">Assistente virtual especialista em an√°lises de ouvidoria</p>
        </div>
      </div>

      <div class="glass rounded-2xl p-5">
        <div id="chatContainer" class="flex flex-col h-[calc(100vh-280px)] min-h-[600px] bg-slate-900/30 rounded-xl border border-white/10 overflow-hidden">
          <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- Mensagens ser√£o preenchidas dinamicamente -->
          </div>
          <div class="border-t border-white/10 p-4">
            <form id="chatForm" class="flex gap-2">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Digite sua mensagem..." 
                class="flex-1 bg-slate-800/60 border border-white/10 rounded-lg px-4 py-2 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50"
                autocomplete="off"
              />
              <button 
                type="submit" 
                id="chatSubmitBtn"
                class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-white font-semibold hover:from-purple-600 hover:to-pink-600 transition-all glow-ring"
              >
                Enviar
              </button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <script>
      // ========== CORA CHAT - Sistema Completo ==========
      let chatMessages = [];
      
      // Fun√ß√£o para formatar data/hora
      function formatChatTime(date) {
        const now = new Date();
        const msgDate = new Date(date);
        const diffMs = now - msgDate;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'Agora';
        if (diffMins < 60) return `${diffMins}min atr√°s`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h atr√°s`;
        return msgDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
      }
      
      // Fun√ß√£o para renderizar mensagens
      function renderMessages() {
        const container = document.getElementById('chatMessages');
        if (!container) return;
        
        container.innerHTML = chatMessages.map(msg => {
          const isUser = msg.sender === 'user';
          return `
            <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}">
              ${!isUser ? `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-sm font-bold">C</span>
                </div>
              ` : `
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-xs">Voc√™</span>
                </div>
              `}
              <div class="flex-1 ${isUser ? 'text-right' : ''}">
                <div class="bg-slate-800/60 rounded-lg p-3 text-sm text-slate-200 inline-block ${isUser ? 'bg-cyan-500/20' : ''}">
                  ${!isUser ? `<div class="font-semibold text-purple-300 mb-1">Cora</div>` : ''}
                  <div>${msg.text}</div>
                </div>
                <div class="text-xs text-slate-500 mt-1 ${isUser ? 'text-right' : 'ml-1'}">${formatChatTime(msg.createdAt)}</div>
              </div>
            </div>
          `;
        }).join('');
        
        // Scroll para o final
        container.scrollTop = container.scrollHeight;
      }
      
      // Fun√ß√£o para enviar mensagem
      async function sendMessage(text) {
        console.log('üöÄ sendMessage chamada', { text });
        if (!text.trim()) {
          console.warn('‚ö†Ô∏è Texto vazio, ignorando');
          return;
        }
        
        const message = {
          text: text.trim(),
          sender: 'user',
          createdAt: new Date().toISOString()
        };
        
        console.log('üí¨ Adicionando mensagem do usu√°rio', message);
        
        // Adicionar mensagem do usu√°rio
        chatMessages.push(message);
        renderMessages();
        
        // Limpar input
        const input = document.getElementById('chatInput');
        if (input) {
          input.value = '';
          input.focus();
        }
        
        try {
          console.log('üì° Enviando para backend...', { text: text.trim() });
          // Salvar no backend
          const response = await fetch('/api/chat/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text.trim() })
          });
          
          console.log('üì• Status da resposta:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erro na resposta do backend', response.status, errorText);
            throw new Error(`Erro ao enviar mensagem: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('‚úÖ Resposta recebida do backend', { 
            hasMessage: !!data.message, 
            hasResponse: !!data.response,
            responsePreview: data.response?.substring(0, 100) + '...' || 'sem resposta'
          });
          
          // Adicionar resposta da Cora
          const coraMessage = {
            text: data.response || 'Obrigada pela sua mensagem! Como posso ajudar?',
            sender: 'cora',
            createdAt: new Date().toISOString()
          };
          
          console.log('ü§ñ Adicionando resposta da Cora', coraMessage);
          chatMessages.push(coraMessage);
          renderMessages();
          
          // Salvar resposta tamb√©m
          console.log('üíæ Salvando resposta da Cora no banco...');
          await fetch('/api/chat/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: coraMessage.text, sender: 'cora' })
          });
          console.log('‚úÖ Resposta da Cora salva no banco');
        } catch (error) {
          console.error('‚ùå Erro ao enviar mensagem:', error);
          const errorMsg = {
            text: 'Desculpe, ocorreu um erro. Tente novamente.',
            sender: 'cora',
            createdAt: new Date().toISOString()
          };
          chatMessages.push(errorMsg);
          renderMessages();
        }
      }
      
      // Fun√ß√£o para carregar mensagens do banco
      async function loadChatMessages() {
        try {
          console.log('üì• Carregando mensagens do banco...');
          const response = await fetch('/api/chat/messages');
          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Mensagens recebidas:', data.messages?.length || 0, 'mensagens');
            chatMessages = data.messages || [];
            if (chatMessages.length === 0) {
              console.log('‚ÑπÔ∏è Nenhuma mensagem encontrada, adicionando mensagem inicial');
              // Mensagem inicial (n√£o salvar no banco, apenas mostrar)
              chatMessages.push({
                text: 'Ol√°, Gestor Municipal! üëã Sou a Cora, sua assistente virtual. Como posso ajudar voc√™ hoje?',
                sender: 'cora',
                createdAt: new Date().toISOString()
              });
            } else {
              console.log('‚úÖ Mensagens carregadas do banco:', chatMessages.length);
            }
          } else {
            console.error('‚ùå Erro ao carregar mensagens:', response.status);
            chatMessages = [{
              text: 'Ol√°, Gestor Municipal! üëã Sou a Cora, sua assistente virtual. Como posso ajudar voc√™ hoje?',
              sender: 'cora',
              createdAt: new Date().toISOString()
            }];
          }
        } catch (error) {
          console.error('‚ùå Erro ao carregar mensagens:', error);
          chatMessages = [{
            text: 'Ol√°! Sou a Cora, sua assistente virtual. Como posso ajudar voc√™ hoje Prefeito?',
            sender: 'cora',
            createdAt: new Date().toISOString()
          }];
        }
        renderMessages();
      }
      
      // Inicializar quando o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', () => {
        console.log('‚úÖ P√°gina de chat carregada');
        
        const form = document.getElementById('chatForm');
        const input = document.getElementById('chatInput');
        const submitBtn = document.getElementById('chatSubmitBtn');
        
        if (!form || !input) {
          console.error('‚ùå Elementos do formul√°rio n√£o encontrados');
          return;
        }
        
        console.log('‚úÖ Elementos encontrados', { form: !!form, input: !!input, submitBtn: !!submitBtn });
        
        const sendPageMessage = (e) => {
          console.log('üì§ Tentando enviar mensagem', input.value);
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          const text = input.value.trim();
          console.log('üìù Texto capturado:', text);
          if (text) {
            console.log('‚úÖ Chamando sendMessage...');
            sendMessage(text);
          } else {
            console.warn('‚ö†Ô∏è Texto vazio, n√£o enviando');
          }
          return false;
        };
        
        // Adicionar listeners
        form.onsubmit = sendPageMessage;
        
        if (submitBtn) {
          submitBtn.onclick = (e) => {
            console.log('üñ±Ô∏è Bot√£o Enviar clicado');
            sendPageMessage(e);
          };
        }
        
        input.onkeydown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            console.log('‚å®Ô∏è Enter pressionado');
            e.preventDefault();
            e.stopPropagation();
            sendPageMessage(e);
          }
        };
        
        // Focar no input
        input.focus();
        
        // Carregar mensagens
        loadChatMessages();
      });
    </script>
  </body>
</html>


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Record {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  data      Json     // Armazena o JSON completo da planilha
  createdAt DateTime @default(now())
  
  // Campos normalizados baseados nas colunas exatas da planilha
  protocolo              String? // protocolo
  dataDaCriacao          String? // data_da_criacao
  statusDemanda          String? // status_demanda
  prazoRestante          String? // prazo_restante
  dataDaConclusao        String? // data_da_conclusao
  tempoDeResolucaoEmDias String? // tempo_de_resolucao_em_dias
  prioridade             String? // prioridade
  tipoDeManifestacao     String? // tipo_de_manifestacao
  tema                   String? // tema
  assunto                String? // assunto
  canal                  String? // canal
  endereco               String? // endereco
  unidadeCadastro        String? // unidade_cadastro
  unidadeSaude           String? // unidade_saude
  status                 String? // status
  servidor               String? // servidor
  responsavel            String? // responsavel
  verificado             String? // verificado
  orgaos                 String? // orgaos
  
  // Campos ISO para queries de data (normalizados de data_da_criacao e data_da_conclusao)
  dataCriacaoIso    String? // YYYY-MM-DD
  dataConclusaoIso  String? // YYYY-MM-DD

  // Índices simples
  @@index([protocolo])
  @@index([statusDemanda])
  @@index([tipoDeManifestacao])
  @@index([tema])
  @@index([assunto])
  @@index([canal])
  @@index([unidadeCadastro])
  @@index([unidadeSaude])
  @@index([status])
  @@index([servidor])
  @@index([responsavel])
  @@index([prioridade])
  @@index([orgaos])
  @@index([dataCriacaoIso])
  @@index([dataConclusaoIso])
  
  // Índices compostos para queries comuns (otimização)
  @@index([dataCriacaoIso, status])
  @@index([dataCriacaoIso, tema])
  @@index([dataCriacaoIso, orgaos])
  @@index([tema, orgaos])
  @@index([status, tema])
  @@index([unidadeCadastro, dataCriacaoIso])
  @@index([servidor, dataCriacaoIso])
  // OTIMIZAÇÃO: Índices adicionais para queries frequentes
  @@index([servidor, dataCriacaoIso, status])
  @@index([orgaos, status, dataCriacaoIso])
  @@index([tema, dataCriacaoIso, status])
  @@index([unidadeCadastro, status, dataCriacaoIso])
  
  @@map("records")
}

model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  text      String
  sender    String   // 'user' ou 'cora'
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@map("chat_messages")
}

// Cache de agregações pré-computadas no banco de dados
model AggregationCache {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique // Chave única do cache (ex: "countBy:status:v2")
  data      Json     // Dados agregados pré-computados
  expiresAt DateTime // Data de expiração do cache
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([expiresAt])
  @@map("aggregation_cache")
}

// Modelo para dados de Zeladoria
model Zeladoria {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  data      Json     // Armazena o JSON completo do CSV
  createdAt DateTime @default(now())
  
  // Campos normalizados baseados nas colunas do CSV
  origem                String? // Origem
  status                String? // Status
  protocoloEmpresa      String? // Protocolo da Empresa
  categoria             String? // Categoria
  responsavel           String? // Responsável
  endereco              String? // Endereço
  bairro                String? // Bairro
  cidade                String? // Cidade
  estado                String? // Estado
  dataCriacao           String? // Data de criação
  dataConclusao         String? // Data de conclusão
  apoios                Int?    // Apoios
  latitude              String? // Latitude
  longitude             String? // Longitude
  departamento          String? // Departamento
  canal                 String? // Canal
  prazo                 String? // Prazo
  
  // Campos ISO para queries de data
  dataCriacaoIso        String? // YYYY-MM-DD
  dataConclusaoIso      String? // YYYY-MM-DD
  
  // Índices simples
  @@index([origem])
  @@index([status])
  @@index([protocoloEmpresa])
  @@index([categoria])
  @@index([responsavel])
  @@index([bairro])
  @@index([departamento])
  @@index([canal])
  @@index([dataCriacaoIso])
  @@index([dataConclusaoIso])
  
  // Índices compostos para queries comuns
  @@index([status, categoria])
  @@index([dataCriacaoIso, status])
  @@index([dataCriacaoIso, categoria])
  @@index([departamento, status])
  @@index([bairro, categoria])
  
  @@map("zeladoria")
}

// Modelo para rastrear notificações de email enviadas
model NotificacaoEmail {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  protocolo         String   // Protocolo da demanda
  secretaria        String   // Secretaria/órgão responsável
  emailSecretaria   String   // Email da secretaria
  tipoNotificacao   String   // '15_dias' | 'vencimento' | '60_dias_vencido'
  dataVencimento    String   // Data de vencimento em formato YYYY-MM-DD
  diasRestantes     Int      // Dias restantes no momento do envio
  enviadoEm         DateTime @default(now()) // Data/hora do envio
  status            String   @default("enviado") // 'enviado' | 'erro' | 'pendente'
  mensagemErro      String?  // Mensagem de erro se houver
  messageId         String?  // ID da mensagem no Gmail (para rastreamento)
  
  // Índices para consultas eficientes
  @@index([protocolo])
  @@index([secretaria])
  @@index([tipoNotificacao])
  @@index([dataVencimento])
  @@index([enviadoEm])
  @@index([status])
  @@index([protocolo, tipoNotificacao]) // Evitar duplicatas
  
  @@map("notificacoes_email")
}

/// Informações de contato das Secretarias (dados vindos da planilha "Dados e emails.xlsx")
model SecretariaInfo {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  /// Nome da secretaria / órgão
  name            String?
  /// Sigla da secretaria (se existir)
  acronym         String?
  /// Email principal da secretaria
  email           String?
  /// Email alternativo / cópia
  alternateEmail  String?
  /// Telefone principal
  phone           String?
  /// Telefone alternativo
  phoneAlt        String?
  /// Endereço completo
  address         String?
  /// Bairro
  bairro          String?
  /// Distrito (quando aplicável)
  district        String?
  /// Observações gerais
  notes           String?
  /// Linha completa original da planilha
  rawData         Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
  @@index([district])
  @@index([email])

  @@map("secretarias_info")
}


// Modelo para usuários do sistema
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique // Nome de usuário único (já cria índice automaticamente)
  password  String   // Senha (hash bcrypt)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}


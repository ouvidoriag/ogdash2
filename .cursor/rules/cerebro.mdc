---
alwaysApply: true
---
# ğŸ¯ FUNÃ‡Ã•ES PRINCIPAIS DO ASSISTENTE

## 1. Reconhecer o Sistema

**IMPORTANTE:** O sistema foi completamente refatorado. Sempre verifique:

- âœ… **Backend:** Estrutura modular em `NOVO/src/`
- âœ… **Frontend:** Estrutura modular em `NOVO/public/scripts/`
- âœ… **Sistema Antigo:** EstÃ¡ em `ANTIGO/` (apenas para referÃªncia)
- âœ… **Sistema Novo:** EstÃ¡ em `NOVO/` (sistema ativo)

**Nunca modifique o sistema antigo!** Sempre trabalhe no sistema novo.

## 2. Analisar Dados (Planilhas em Imagem ou Arquivo)

### Processo de AnÃ¡lise:
1. **Ler dados e cabeÃ§alhos** (usando OCR mental se for imagem)
2. **Entender significado de cada coluna:**
   - Protocolo, Data, Secretaria, Setor, Tipo, Categoria, Bairro, Status, etc.
   - Campos normalizados: `protocolo`, `dataDaCriacao`, `statusDemanda`, `tipoDeManifestacao`, `tema`, `assunto`, `bairro`, etc.
3. **Detectar padrÃµes e relaÃ§Ãµes** entre colunas
4. **Mapear para estrutura do banco** usando `fieldMapper.js`

### Campos Normalizados (Prisma Schema):
- `protocolo` - Protocolo da manifestaÃ§Ã£o
- `dataDaCriacao` / `dataCriacaoIso` - Data de criaÃ§Ã£o
- `dataDaConclusao` / `dataConclusaoIso` - Data de conclusÃ£o
- `statusDemanda` / `status` - Status da demanda
- `tipoDeManifestacao` - Tipo (ReclamaÃ§Ã£o, DenÃºncia, etc.)
- `tema` - Tema da manifestaÃ§Ã£o
- `assunto` - Assunto especÃ­fico
- `categoria` - Categoria normalizada
- `bairro` - Bairro normalizado
- `orgaos` / `Secretaria` - Ã“rgÃ£o/Secretaria responsÃ¡vel
- `unidadeSaude` - Unidade de saÃºde (se aplicÃ¡vel)
- `servidor` - Servidor responsÃ¡vel
- `responsavel` - ResponsÃ¡vel pelo tratamento

## 3. Criar/Estruturar Dados

### Ao adicionar novos campos ou segmentos:

1. **Verificar `fieldMapper.js`** - Adicionar mapeamento se necessÃ¡rio
2. **Atualizar Prisma Schema** - Adicionar campos normalizados
3. **Criar Controller** - Em `src/api/controllers/` se for novo endpoint
4. **Criar Rota** - Em `src/api/routes/` apropriado
5. **Criar PÃ¡gina Frontend** - Em `public/scripts/pages/` se for nova visualizaÃ§Ã£o
6. **Usar Sistemas Globais:**
   - `window.dataLoader.load()` para carregar dados
   - `window.dataStore.get/set()` para cache
   - `window.chartFactory.create*Chart()` para grÃ¡ficos
   - `window.chartCommunication.applyFilter()` para filtros

## 4. Adaptar o Sistema Automaticamente

### PadrÃµes a Seguir:

#### Backend (Controllers):
```javascript
import { withCache } from '../../utils/responseHelper.js';

export async function minhaFuncao(req, res, prisma) {
  return withCache('chave-cache', 3600, res, async () => {
    // LÃ³gica aqui
    return { dados: [...] };
  }, prisma);
}
```

#### Frontend (PÃ¡ginas):
```javascript
async function loadMinhaPagina() {
  const page = document.getElementById('page-minha-pagina');
  if (!page || page.style.display === 'none') return;
  
  try {
    const data = await window.dataLoader?.load('/api/meu-endpoint', {
      useDataStore: true,
      ttl: 10 * 60 * 1000
    });
    
    // Renderizar dados
    renderDados(data);
    
    // Criar grÃ¡ficos
    await window.chartFactory?.createBarChart('meuChart', labels, values, {
      onClick: true // Habilitar comunicaÃ§Ã£o entre grÃ¡ficos
    });
  } catch (error) {
    window.Logger?.error('Erro:', error);
  }
}

window.loadMinhaPagina = loadMinhaPagina;
```

## 5. Gerar Insights

- Identificar tendÃªncias (ex: aumento de reclamaÃ§Ãµes em determinado bairro)
- Detectar campos inconsistentes ou dados ausentes
- Sugerir novas visualizaÃ§Ãµes ou segmentos
- Usar `/api/ai/insights` para insights automÃ¡ticos (Gemini AI)

---

# ğŸ”§ SISTEMAS GLOBAIS E COMO USAR

## Global Data Store (`window.dataStore`)

**Uso:** Cache centralizado com reatividade

```javascript
// Obter dados (com cache automÃ¡tico)
const data = window.dataStore.get('chave', ttl);

// Armazenar dados
window.dataStore.set('chave', dados, deepCopy = true);

// Inscrever-se para mudanÃ§as
const unsubscribe = window.dataStore.subscribe('chave', (newData) => {
  atualizarUI(newData);
});

// Invalidar dados
window.dataStore.invalidate(['chave1', 'chave2']);
```

## Data Loader (`window.dataLoader`)

**Uso:** Carregamento unificado com deduplicaÃ§Ã£o

```javascript
// Carregar dados
const data = await window.dataLoader.load('/api/endpoint', {
  useDataStore: true,
  ttl: 10 * 60 * 1000,
  timeout: 30000
});

// Carregar mÃºltiplos endpoints em paralelo
const [data1, data2] = await window.dataLoader.loadMany([
  '/api/endpoint1',
  '/api/endpoint2'
]);
```

## Chart Factory (`window.chartFactory`)

**Uso:** CriaÃ§Ã£o padronizada de grÃ¡ficos

```javascript
// GrÃ¡fico de barras
await window.chartFactory.createBarChart('canvasId', labels, values, {
  horizontal: true,
  colorIndex: 1,
  onClick: true // Habilitar comunicaÃ§Ã£o
});

// GrÃ¡fico de linha
await window.chartFactory.createLineChart('canvasId', labels, values, {
  colorIndex: 0
});

// GrÃ¡fico de rosca
await window.chartFactory.createDoughnutChart('canvasId', labels, values, {
  onClick: true
});
```

## Chart Communication (`window.chartCommunication`)

**Uso:** ComunicaÃ§Ã£o entre grÃ¡ficos e filtros globais

```javascript
// Aplicar filtro (todos os grÃ¡ficos reagem)
window.chartCommunication.applyFilter('Status', 'ConcluÃ­do', 'chartId');

// Limpar filtros
window.chartCommunication.clearFilters();

// Registrar grÃ¡fico
window.chartCommunication.registerChart('chartId', {
  type: 'bar',
  field: 'Status',
  operator: 'equals'
});
```

## Advanced Charts (`window.advancedCharts`)

**Uso:** GrÃ¡ficos avanÃ§ados com Plotly.js

```javascript
// Carregar grÃ¡ficos avanÃ§ados
await window.advancedCharts.loadAdvancedCharts(temas, orgaos);

// Sankey
await window.advancedCharts.loadSankeyChart(temas, orgaos, status);

// TreeMap
await window.advancedCharts.loadTreeMapChart(temas);

// Mapa geogrÃ¡fico
await window.advancedCharts.loadGeographicMap(bairros);
```

---

# ğŸ“Š ESTRUTURA DE PÃGINAS

## PÃ¡ginas Existentes (21 principais + 18 dinÃ¢micas)

### Principais:
1. `overview.js` - VisÃ£o Geral
2. `orgao-mes.js` - Por Ã“rgÃ£o e MÃªs
3. `tempo-medio.js` - Tempo MÃ©dio de Atendimento
4. `tema.js` - Por Tema
5. `assunto.js` - Por Assunto
6. `tipo.js` - Tipos de ManifestaÃ§Ã£o
7. `setor.js` - AnÃ¡lise por Setor
8. `categoria.js` - Por Categoria
9. `status.js` - Status
10. `bairro.js` - AnÃ¡lise por Bairro
11. `uac.js` - Unidades de Atendimento ao CidadÃ£o
12. `responsavel.js` - ResponsÃ¡veis
13. `canal.js` - Canais de Atendimento
14. `prioridade.js` - Prioridades
15. `cadastrante.js` - Por Cadastrante/Unidade
16. `reclamacoes.js` - ReclamaÃ§Ãµes e DenÃºncias
17. `secretaria.js` - Secretarias
18. `secretarias-distritos.js` - Secretarias e Distritos
19. `projecao-2026.js` - ProjeÃ§Ã£o 2026
20. `cora-chat.js` - Cora Chat
21. `unit.js` - Unidades de SaÃºde (dinÃ¢mico)

### DinÃ¢micas (18 unidades de saÃºde):
- Geradas automaticamente via `generate-unit-pages.js`

---

# ğŸš¨ REGRAS IMPORTANTES

## âœ… SEMPRE FAÃ‡A:

1. **Trabalhe no sistema NOVO** (`NOVO/`), nunca no antigo (`ANTIGO/`)
2. **Use os sistemas globais** (dataLoader, dataStore, chartFactory, etc.)
3. **Siga os padrÃµes estabelecidos** (estrutura modular, cache, etc.)
4. **Valide dados** antes de usar (verificar se Ã© array, se existe, etc.)
5. **Use tratamento de erros** (try/catch, validaÃ§Ãµes)
6. **Documente cÃ³digo** (JSDoc quando apropriado)
7. **Teste localmente** antes de sugerir mudanÃ§as

## âŒ NUNCA FAÃ‡A:

1. **Modificar sistema antigo** (`ANTIGO/`)
2. **Criar cÃ³digo duplicado** (use sistemas globais)
3. **Ignorar cache** (sempre use dataStore/dataLoader)
4. **Criar grÃ¡ficos diretamente** (use chartFactory)
5. **Hardcode de valores** (use config.js)
6. **Esquecer validaÃ§Ãµes** (sempre valide dados)

---

# ğŸ“ FORMATO DE RESPOSTA ESPERADO

Ao analisar dados ou propor mudanÃ§as, sempre inclua:

1. **ğŸ” DiagnÃ³stico** - O que foi detectado/analisado
2. **ğŸ—‚ï¸ Estrutura** - Como os dados se mapeiam para o sistema
3. **ğŸ“Š Segmentos** - VisualizaÃ§Ãµes sugeridas
4. **ğŸ§© Ajustes** - MudanÃ§as necessÃ¡rias no cÃ³digo
5. **ğŸ’¡ Insights** - ObservaÃ§Ãµes Ãºteis

---

# ğŸ¯ EXEMPLO DE USO

**CenÃ¡rio:** "Analisar planilha e adaptar dashboard"

**Resposta esperada:**

1. **ğŸ” DiagnÃ³stico:**
   - Colunas detectadas: Protocolo, Data, Secretaria, Status, Bairro
   - PadrÃµes: 15.000 registros, perÃ­odo 2024-2025

2. **ğŸ—‚ï¸ Estrutura:**
   - Mapeamento: `protocolo`, `dataCriacaoIso`, `Secretaria`, `status`, `bairro`
   - Campos jÃ¡ normalizados no schema

3. **ğŸ“Š Segmentos:**
   - "ReclamaÃ§Ãµes por Secretaria" â†’ `/api/aggregate/count-by?field=Secretaria`
   - "Demandas por Bairro" â†’ `/api/aggregate/count-by?field=Bairro`
   - "Status por MÃªs" â†’ `/api/aggregate/by-month?field=Status`

4. **ğŸ§© Ajustes:**
   - Usar `window.dataLoader.load()` para carregar dados
   - Criar grÃ¡ficos com `window.chartFactory.createBarChart()`
   - Habilitar comunicaÃ§Ã£o com `onClick: true`

5. **ğŸ’¡ Insights:**
   - Maior concentraÃ§Ã£o em Secretaria X
   - TendÃªncia de aumento em Bairro Y
   - Sugerir nova pÃ¡gina de anÃ¡lise geogrÃ¡fica

---

# ğŸ”„ MIGRAÃ‡ÃƒO COMPLETA REALIZADA

## O que foi migrado:

- âœ… **Backend:** 58 endpoints (100%)
- âœ… **Frontend:** 21 pÃ¡ginas principais + 18 dinÃ¢micas (100%)
- âœ… **GrÃ¡ficos:** Chart.js + Plotly.js (100%)
- âœ… **Sistemas Globais:** dataStore, dataLoader, chartFactory, chartCommunication (100%)
- âœ… **UtilitÃ¡rios:** queryOptimizer, fieldMapper, dbCache, dateUtils (100%)

## Melhorias implementadas:

- âœ… Estrutura modular (antes: monolÃ­tica)
- âœ… Cache hÃ­brido (banco + memÃ³ria)
- âœ… ComunicaÃ§Ã£o entre grÃ¡ficos
- âœ… Carregamento lazy de bibliotecas
- âœ… Tratamento de erros robusto
- âœ… Performance otimizada

---

**InstruÃ§Ã£o final:** Ao receber uma foto de planilha ou solicitaÃ§Ã£o de mudanÃ§a, siga o protocolo acima, sempre trabalhando no sistema NOVO, usando os sistemas globais e seguindo os padrÃµes estabelecidos.

---
alwaysApply: true
---

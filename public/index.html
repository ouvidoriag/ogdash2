<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ouvidoria - Duque de Caxias - Dashboard</title>
    <link rel="icon" type="image/png" href="/dc-logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #0f172a;
        --muted: #94a3b8;
        --primary: #22d3ee; /* cyan */
        --accent: #a78bfa;  /* violet */
        --success: #34d399; /* green */
        --danger: #fb7185;  /* rose */
      }
      body { background: radial-gradient(1200px 600px at top left, rgba(34,211,238,0.08), transparent 60%), radial-gradient(1200px 600px at bottom right, rgba(167,139,250,0.08), transparent 60%), var(--bg); }
      .glass { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.08); }
      .neon { text-shadow: 0 0 12px rgba(34,211,238,0.65), 0 0 24px rgba(167,139,250,0.45); }
      .glow-ring { box-shadow: 0 0 0 2px rgba(34,211,238,0.15), 0 0 32px rgba(34,211,238,0.25); }
      .skeleton { background: rgba(255,255,255,0.06); }
      canvas { max-height: 340px; }
      
      /* Estilos do menu lateral */
      nav[id="sideMenu"] div[data-page].active {
        background: linear-gradient(90deg, rgba(34,211,238,0.15) 0%, rgba(34,211,238,0.05) 100%);
        border-left: 3px solid #22d3ee;
        color: #22d3ee;
        font-weight: 600;
      }
      
      nav[id="sideMenu"] div[data-page]:hover:not(.active) {
        background: rgba(255,255,255,0.05);
      }
      
      nav[id="sideMenu"] .unit-category-header:hover {
        background: rgba(255,255,255,0.05);
      }
      
      nav[id="sideMenu"] .unit-category-header[data-category].expanded .unit-category-arrow {
        transform: rotate(90deg);
      }
      
      nav[id="sideMenu"] .unit-category-content[data-category-content] {
        animation: slideDown 0.2s ease-out;
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* AnimaÃ§Ãµes removidas para melhor performance */
      .cora-avatar {
        position: relative;
      }
      .cora-avatar::before {
        content: '';
        position: absolute;
        inset: -10px;
        border-radius: 50%;
        background: linear-gradient(45deg, rgba(34,211,238,0.3), rgba(167,139,250,0.3));
        filter: blur(20px);
        z-index: -1;
      }
      .glow-text {
        text-shadow: 0 0 20px rgba(34,211,238,0.5), 0 0 40px rgba(167,139,250,0.3);
      }

      /* Scrollbar moderna global: preta e levemente deslocada para fora dos cards */
      :where(.overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll) {
        padding-right: 12px;
        margin-right: -12px;
      }
      body { scrollbar-gutter: stable; }

      /* WebKit (Chrome, Safari, Edge) */
      :where(html, body, .overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll)::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }
      :where(html, body, .overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll)::-webkit-scrollbar-track {
        background: transparent;
      }
      :where(html, body, .overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll)::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #0a0a0a, #1a1a1a);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }
      :where(html, body, .overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll)::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #111, #222);
      }

      /* Firefox */
      :where(html, body, .overflow-y-auto, .overflow-auto, .overflow-y-scroll, .overflow-x-auto, .overflow-x-scroll) {
        scrollbar-width: thin;
        scrollbar-color: #000000 transparent;
      }
    </style>
  </head>
  <body class="text-slate-100">
    <div class="min-h-screen grid grid-cols-12 gap-6 p-6">
      <aside class="col-span-12 lg:col-span-3 xl:col-span-2 glass rounded-2xl p-5 ">
        <div class="flex items-center gap-3 mb-6">
          <img src="/dc-logo.png" alt="Duque de Caxias" class="h-12 w-auto object-contain" />
          <div>
            <div class="text-lg font-semibold">Ouvidoria Caxias</div>
            <div class="text-xs text-slate-400">Dashboard Futurista</div>
          </div>
        </div>
        <nav id="sideMenu" class="space-y-3 text-sm">
          <!-- ğŸ  SEÃ‡ÃƒO: INÃCIO -->
          <div class="space-y-1">
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 mb-2">ğŸ  InÃ­cio</div>
            <div data-page="home" class="active px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ  Home</div>
            <div data-page="main" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“Š VisÃ£o Geral</div>
            <a href="/chat" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer block transition-colors">ğŸ’¬ Cora - Chat</a>
          </div>
          
          <!-- ğŸ“Š SEÃ‡ÃƒO: ANÃLISES PRINCIPAIS -->
          <div class="space-y-1 pt-2 border-t border-white/10">
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 mb-2">ğŸ“Š AnÃ¡lises Principais</div>
            <div data-page="orgao-mes" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ¢ Por Ã“rgÃ£o e MÃªs</div>
            <div data-page="tempo-medio" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">â±ï¸ Tempo MÃ©dio</div>
            <div data-page="tema" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“‘ Por Tema</div>
            <div data-page="assunto" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“ Por Assunto</div>
            <div data-page="cadastrante" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ‘¤ Por Cadastrante</div>
            <div data-page="reclamacoes" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸš¨ ReclamaÃ§Ãµes e DenÃºncias</div>
            <div data-page="projecao-2026" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“ˆ ProjeÃ§Ã£o 2026</div>
          </div>
          
          <!-- ğŸ¥ SEÃ‡ÃƒO: UNIDADES DE SAÃšDE -->
          <div class="space-y-1 pt-2 border-t border-white/10">
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 mb-2">ğŸ¥ Unidades de SaÃºde</div>
            
            <!-- Hospitais -->
            <div class="mb-1">
              <div class="unit-category-header text-xs text-slate-300 px-3 py-1.5 font-medium hover:bg-white/5 rounded-lg cursor-pointer flex items-center justify-between transition-colors" data-category="hospitais">
                <span>ğŸ¥ Hospitais</span>
                <span class="unit-category-arrow transition-transform duration-200 text-slate-500">â–¶</span>
              </div>
              <div class="unit-category-content pl-2 space-y-0.5 mt-1" data-category-content="hospitais" style="display: none;">
                <div data-page="unit-hospital-olho" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital do Olho</div>
                <div data-page="unit-hospital-duque" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital Duque</div>
                <div data-page="unit-hospital-infantil" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital Infantil</div>
                <div data-page="unit-hospital-moacyr" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital Moacyr</div>
                <div data-page="unit-hospital-veterinario" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital VeterinÃ¡rio</div>
                <div data-page="unit-maternidade-santa-cruz" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Maternidade Santa Cruz</div>
              </div>
            </div>
            
            <!-- UPH -->
            <div class="mb-1">
              <div class="unit-category-header text-xs text-slate-300 px-3 py-1.5 font-medium hover:bg-white/5 rounded-lg cursor-pointer flex items-center justify-between transition-colors" data-category="uph">
                <span>ğŸ¥ UPH</span>
                <span class="unit-category-arrow transition-transform duration-200 text-slate-500">â–¶</span>
              </div>
              <div class="unit-category-content pl-2 space-y-0.5 mt-1" data-category-content="uph" style="display: none;">
                <div data-page="unit-uph-pilar" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH Pilar</div>
                <div data-page="unit-uph-saracuruna" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH Saracuruna</div>
                <div data-page="unit-uph-xerem" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH XerÃ©m</div>
                <div data-page="unit-uph-campos-eliseos" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH Campos ElÃ­seos</div>
                <div data-page="unit-uph-parque-equitativa" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH Parque Equitativa</div>
                <div data-page="unit-uph-imbarie" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPH ImbariÃª</div>
              </div>
            </div>
            
            <!-- UPA -->
            <div class="mb-1">
              <div class="unit-category-header text-xs text-slate-300 px-3 py-1.5 font-medium hover:bg-white/5 rounded-lg cursor-pointer flex items-center justify-between transition-colors" data-category="upa">
                <span>ğŸš‘ UPA</span>
                <span class="unit-category-arrow transition-transform duration-200 text-slate-500">â–¶</span>
              </div>
              <div class="unit-category-content pl-2 space-y-0.5 mt-1" data-category-content="upa" style="display: none;">
                <div data-page="unit-upa-beira-mar" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPA Beira Mar</div>
                <div data-page="unit-upa-walter-garcia" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPA Walter Garcia</div>
                <div data-page="unit-upa-sarapui" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UPA SarapuÃ­</div>
              </div>
            </div>
            
            <!-- Outros -->
            <div class="mb-1">
              <div class="unit-category-header text-xs text-slate-300 px-3 py-1.5 font-medium hover:bg-white/5 rounded-lg cursor-pointer flex items-center justify-between transition-colors" data-category="outros">
                <span>ğŸ“ Outros</span>
                <span class="unit-category-arrow transition-transform duration-200 text-slate-500">â–¶</span>
              </div>
              <div class="unit-category-content pl-2 space-y-0.5 mt-1" data-category-content="outros" style="display: none;">
                <div data-page="unit-adao" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">Hospital AdÃ£o</div>
                <div data-page="unit-cer-iv" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">CER IV</div>
                <div data-page="unit-ubs-antonio-granja" class="px-3 py-1.5 rounded-lg hover:bg-white/5 cursor-pointer text-xs transition-colors">UBS Antonio Granja</div>
              </div>
            </div>
          </div>
          
          <!-- ğŸ“ˆ SEÃ‡ÃƒO: RELATÃ“RIOS POR DIMENSÃƒO -->
          <div class="space-y-1 pt-2 border-t border-white/10">
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 mb-2">ğŸ“ˆ RelatÃ³rios por DimensÃ£o</div>
            <div data-page="secretaria" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ›ï¸ Secretarias</div>
            <div data-page="secretarias-distritos" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ—ºï¸ Secretarias e Distritos</div>
            <div data-page="tipo" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“‹ Tipos de ManifestaÃ§Ã£o</div>
            <div data-page="status" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“Š Status</div>
            <div data-page="categoria" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“‚ Tema</div>
            <div data-page="setor" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ¢ Unidade de Cadastro</div>
            <div data-page="responsavel" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ‘¥ ResponsÃ¡veis</div>
            <div data-page="canal" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">ğŸ“¡ Canais</div>
            <div data-page="prioridade" class="px-3 py-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">âš¡ Prioridades</div>
          </div>
        </nav>
        <div class="mt-8 pt-6 border-t border-white/10">
          <div class="text-xs font-semibold text-slate-300 mb-4 uppercase tracking-wider">Equipe ResponsÃ¡vel</div>
          <div class="space-y-3 text-xs">
            <div class="pb-2 border-b border-white/5">
              <div class="text-slate-400 mb-1">Ouvidoria Geral</div>
              <div class="text-slate-200 font-medium">Edrisio Avelino</div>
              <div class="text-slate-500 text-[10px] mt-0.5">Ouvidor Geral</div>
            </div>
            <div class="space-y-2">
              <div>
                <div class="text-slate-200 font-medium">Nilton Quaresma</div>
                <div class="text-slate-500 text-[10px]">Diretor de Ouvidoria</div>
              </div>
              <div>
                <div class="text-slate-200 font-medium">David Freitas</div>
                <div class="text-slate-500 text-[10px]">Diretor de AnÃ¡lise de Dados</div>
              </div>
            </div>
            <div class="pt-2 mt-2 border-t border-white/5">
              <div class="text-slate-400 mb-2 text-[10px] uppercase tracking-wide">Analistas EstratÃ©gicos da Ouvidoria</div>
              <div class="space-y-1 text-slate-300">
                <div class="text-[11px]">â€¢ Nikolas Brian</div>
                <div class="text-[11px]">â€¢ Rildo Luiz</div>
                <div class="text-[11px]">â€¢ Wellington Ribeiro</div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <main id="pages" class="col-span-12 lg:col-span-9 xl:col-span-10 space-y-6">
        <!-- Indicador de Filtros Ativos -->
        <div id="filterIndicator" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50"></div>
        
        <!-- PÃ¡gina Home: ApresentaÃ§Ã£o da Cora -->
        <section id="page-home" class="">
          <div class="glass rounded-2xl p-8 md:p-12 text-center">
            <!-- Logo/Ãcone da Cora com animaÃ§Ã£o -->
            <div class="mb-8">
              <div class="inline-block relative">
                <div class="cora-avatar w-32 h-32 md:w-40 md:h-40 mx-auto rounded-full bg-gradient-to-br from-cyan-400 via-purple-500 to-pink-500 flex items-center justify-center text-6xl md:text-7xl">
                  ğŸ¤–
                </div>
                <div class="absolute inset-0 rounded-full bg-cyan-400/20 blur-2xl"></div>
              </div>
            </div>
            
            <!-- TÃ­tulo principal -->
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 neon">
              OlÃ¡, Gestor Municipal! ğŸ‘‹
            </h1>
            <h2 class="text-2xl md:text-4xl font-bold text-cyan-300 mb-8">
              Eu sou a <span class="text-purple-400">Cora</span>
            </h2>
            
            <!-- SubtÃ­tulo -->
            <p class="text-lg md:text-xl text-slate-300 mb-12 max-w-3xl mx-auto ">
              Sua assistente virtual inteligente especializada em anÃ¡lises de ouvidoria
            </p>
            
            <!-- Cards de funcionalidades -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
              <!-- Card 1: Chat Inteligente -->
              <div class="glass rounded-xl p-6 hover:scale-105 transition-transform duration-100">
                <div class="text-4xl mb-4">ğŸ’¬</div>
                <h3 class="text-xl font-bold text-cyan-300 mb-2">Chat Inteligente</h3>
                <p class="text-sm text-slate-400">
                  FaÃ§a perguntas em linguagem natural e receba respostas precisas baseadas em dados reais do banco de dados
                </p>
              </div>
              
              <!-- Card 2: AnÃ¡lises em Tempo Real -->
              <div class="glass rounded-xl p-6 hover:scale-105 transition-transform duration-100">
                <div class="text-4xl mb-4">ğŸ“Š</div>
                <h3 class="text-xl font-bold text-purple-300 mb-2">AnÃ¡lises em Tempo Real</h3>
                <p class="text-sm text-slate-400">
                  Acesso direto ao banco de dados para fornecer informaÃ§Ãµes atualizadas e precisas
                </p>
              </div>
              
              <!-- Card 3: Processamento Inteligente -->
              <div class="glass rounded-xl p-6 hover:scale-105 transition-transform duration-100">
                <div class="text-4xl mb-4">ğŸ§ </div>
                <h3 class="text-xl font-bold text-pink-300 mb-2">Processamento Inteligente</h3>
                <p class="text-sm text-slate-400">
                  AnÃ¡lise avanÃ§ada de dados com capacidade de cÃ¡lculos matemÃ¡ticos e anÃ¡lises estatÃ­sticas
                </p>
              </div>
            </div>
            
            <!-- Como funciona -->
            <div class="glass rounded-xl p-8 mb-8 max-w-4xl mx-auto ">
              <h3 class="text-2xl font-bold text-cyan-300 mb-6 flex items-center justify-center gap-2">
                <span>âš¡</span> Como Funciona
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-300 font-bold text-lg">
                    1
                  </div>
                  <div>
                    <h4 class="font-semibold text-white mb-1">VocÃª faz uma pergunta</h4>
                    <p class="text-sm text-slate-400">
                      Pergunte sobre secretarias, setores, temas, protocolos, bairros, ou qualquer informaÃ§Ã£o da ouvidoria
                    </p>
                  </div>
                </div>
                
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300 font-bold text-lg">
                    2
                  </div>
                  <div>
                    <h4 class="font-semibold text-white mb-1">Cora busca no banco</h4>
                    <p class="text-sm text-slate-400">
                      Sistema inteligente identifica palavras-chave e busca dados relevantes automaticamente no banco de dados
                    </p>
                  </div>
                </div>
                
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-300 font-bold text-lg">
                    3
                  </div>
                  <div>
                    <h4 class="font-semibold text-white mb-1">Sistema processa e responde</h4>
                    <p class="text-sm text-slate-400">
                      AnÃ¡lise inteligente dos dados, faz cÃ¡lculos quando necessÃ¡rio e formata uma resposta clara e objetiva
                    </p>
                  </div>
                </div>
                
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-300 font-bold text-lg">
                    4
                  </div>
                  <div>
                    <h4 class="font-semibold text-white mb-1">Resposta formatada</h4>
                    <p class="text-sm text-slate-400">
                      Receba respostas em Markdown com formataÃ§Ã£o profissional, nÃºmeros destacados e informaÃ§Ãµes organizadas
                    </p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Exemplos de perguntas -->
            <div class="glass rounded-xl p-8 max-w-4xl mx-auto mb-8 ">
              <h3 class="text-xl font-bold text-purple-300 mb-4">ğŸ’¡ Exemplos de Perguntas</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                <div class="bg-slate-800/50 rounded-lg p-4 border border-cyan-500/20">
                  <p class="text-sm text-cyan-200">"Qual a secretaria com mais reclamaÃ§Ãµes?"</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 border border-purple-500/20">
                  <p class="text-sm text-purple-200">"Quantas UPAs temos?"</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 border border-pink-500/20">
                  <p class="text-sm text-pink-200">"O que tem no protocolo C-0000.0000.0000.0000/25?"</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 border border-emerald-500/20">
                  <p class="text-sm text-emerald-200">"Qual o bairro com mais reclamaÃ§Ãµes?"</p>
                </div>
              </div>
            </div>
            
            <!-- BotÃ£o de aÃ§Ã£o -->
            <div class="Up">
              <a href="/chat" class="inline-block px-8 py-4 bg-gradient-to-r from-cyan-500 to-purple-500 rounded-xl font-bold text-lg hover:scale-105 transition-transform duration-100 glow-ring">
                ğŸš€ ComeÃ§ar a Conversar com a Cora
              </a>
            </div>
          </div>
        </section>
        
        <!-- Painel principal: VisÃ£o Geral (refatorado) -->
        <section id="page-main" style="display: none;">
          <!-- Header -->
          <header class="glass rounded-2xl p-6 mb-6 relative overflow-hidden">
            <div class="absolute inset-0 opacity-30" style="background: radial-gradient(600px 220px at 8% 0%, rgba(34,211,238,0.22), transparent 60%), radial-gradient(600px 220px at 92% 100%, rgba(167,139,250,0.22), transparent 60%)"></div>
            <div class="relative flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-4">
                <img src="/dc-logo.png" alt="Duque de Caxias" class="h-14 w-auto object-contain" />
                <div>
                  <h1 class="text-xl md:text-2xl font-bold neon">VisÃ£o Geral â€¢ InteligÃªncia EstratÃ©gicas</h1>
                  <div class="text-slate-400 text-xs">Dados interligados: clique para filtrar todo o painel</div>
                </div>
              </div>
            </div>
          </header>

          <!-- ========== SEÃ‡ÃƒO 1: KPIs PRINCIPAIS ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-cyan-400 uppercase tracking-wider px-3">ğŸ“Š Indicadores Principais</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 md:col-span-4 glass rounded-2xl p-5 hover:scale-[1.02] transition-transform">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-slate-400 text-sm font-medium">Total de ManifestaÃ§Ãµes</div>
                  <div class="text-2xl">ğŸ“ˆ</div>
                </div>
                <div class="flex items-end gap-3 mt-2">
                  <div id="kpiTotal" class="text-3xl font-extrabold text-cyan-300">â€”</div>
                  <div id="kpiTotalDelta" class="text-xs text-slate-400 mb-1">â€”</div>
                </div>
                <canvas id="sparkTotal" height="32" class="mt-3"></canvas>
              </div>
              <div class="col-span-12 md:col-span-4 glass rounded-2xl p-5 hover:scale-[1.02] transition-transform">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-slate-400 text-sm font-medium">Ãšltimos 7 dias</div>
                  <div class="text-2xl">ğŸ“…</div>
                </div>
                <div class="flex items-end gap-3 mt-2">
                  <div id="kpi7" class="text-3xl font-extrabold text-violet-300">â€”</div>
                  <div id="kpi7Delta" class="text-xs text-slate-400 mb-1">â€”</div>
                </div>
                <canvas id="spark7" height="32" class="mt-3"></canvas>
              </div>
              <div class="col-span-12 md:col-span-4 glass rounded-2xl p-5 hover:scale-[1.02] transition-transform">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-slate-400 text-sm font-medium">Ãšltimos 30 dias</div>
                  <div class="text-2xl">ğŸ“Š</div>
                </div>
                <div class="flex items-end gap-3 mt-2">
                  <div id="kpi30" class="text-3xl font-extrabold text-emerald-300">â€”</div>
                  <div id="kpi30Delta" class="text-xs text-slate-400 mb-1">â€”</div>
                </div>
                <canvas id="spark30" height="32" class="mt-3"></canvas>
              </div>
            </div>
          </section>

          <!-- ========== SEÃ‡ÃƒO 2: INSIGHTS E ANÃLISES ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-emerald-400 uppercase tracking-wider px-3">ğŸ’¡ Insights e AnÃ¡lises</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 xl:col-span-8 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-emerald-300 text-lg">ğŸ¤– AnÃ¡lise Inteligente com IA</h3>
                  <button id="btnRefreshInsights" class="px-3 py-1.5 text-xs rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 hover:bg-emerald-500/30 transition-colors">
                    ğŸ”„ Atualizar
                  </button>
                </div>
                
                <!-- Insights gerados pela IA -->
                <div id="insightsAIBox" class="space-y-3 mb-4">
                  <div class="flex items-center justify-center py-4">
                    <div class="text-slate-400">Gerando insights...</div>
                  </div>
                </div>
                
                <!-- Insights bÃ¡sicos -->
                <div class="border-t border-white/10 pt-4">
                  <div class="text-xs text-slate-400 mb-2 font-medium">ğŸ“Š Resumo RÃ¡pido</div>
                  <div id="insightsBox" class="text-sm text-slate-300 space-y-2">
                    <div class="flex items-center justify-center py-4">
                      <div class="text-slate-400">Carregando...</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Status Overview -->
              <div class="col-span-12 xl:col-span-4 glass rounded-2xl p-5">
                <h3 class="font-semibold text-cyan-300 text-lg mb-4">ğŸ“Š Status Atual</h3>
                <div id="statusOverviewCards" class="space-y-3">
                  <div class="text-center text-slate-400 py-4">Carregando...</div>
                </div>
              </div>
            </div>
          </section>

          <!-- ========== SEÃ‡ÃƒO 3: TENDÃŠNCIAS E DISTRIBUIÃ‡Ã•ES ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-blue-400 uppercase tracking-wider px-3">ğŸ“ˆ TendÃªncias e DistribuiÃ§Ãµes</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-cyan-300">ğŸ“Š TendÃªncia Mensal (12M)</h3>
                </div>
                <div class="rounded-xl overflow-hidden bg-slate-900/30 p-2">
                  <canvas id="chartTrend"></canvas>
                </div>
              </div>
              <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-violet-300">ğŸ¯ Funil por Status</h3>
                </div>
                <div class="rounded-xl overflow-hidden bg-slate-900/30 p-2">
                  <canvas id="chartFunnelStatus"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- ========== SEÃ‡ÃƒO 4: RANKINGS PRINCIPAIS ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-purple-400 uppercase tracking-wider px-3">ğŸ† Rankings Principais</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-cyan-300">ğŸ›ï¸ Top Ã“rgÃ£os (Top 10)</h3>
                </div>
                <div class="rounded-xl overflow-hidden bg-slate-900/30 p-2">
                  <canvas id="chartTopOrgaos"></canvas>
                </div>
              </div>
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-emerald-300">ğŸ“‘ Top Temas</h3>
                </div>
                <div class="rounded-xl overflow-hidden bg-slate-900/30 p-2">
                  <canvas id="chartTopTemas"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- ========== SEÃ‡ÃƒO 5: HEATMAP E ANÃLISES AVANÃ‡ADAS ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-amber-400 uppercase tracking-wider px-3">ğŸ”¥ AnÃ¡lises AvanÃ§adas</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-amber-300">ğŸ—ºï¸ Heatmap: MÃªs Ã— DimensÃ£o</h3>
                  <div>
                    <select id="heatmapDim" class="bg-slate-900/60 border border-white/10 rounded-lg px-3 py-2 text-sm glow-ring hover:border-amber-500/50 transition-colors">
                      <option>Categoria</option>
                      <option>Secretaria</option>
                      <option>Setor</option>
                      <option>Tipo</option>
                      <option>Status</option>
                      <option>Bairro</option>
                      <option>UAC</option>
                      <option>Responsavel</option>
                      <option>Canal</option>
                      <option>Prioridade</option>
                    </select>
                  </div>
                </div>
                <div id="heatmap" class="overflow-auto rounded-xl border border-white/10 bg-slate-900/20"></div>
              </div>
            </div>
          </section>
          <!-- ========== SEÃ‡ÃƒO 6: DISTRIBUIÃ‡ÃƒO POR STATUS ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-rose-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-rose-400 uppercase tracking-wider px-3">ğŸ“‹ DistribuiÃ§Ã£o Detalhada</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-rose-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-rose-300">ğŸ“Š DistribuiÃ§Ã£o por Status</h3>
                <div class="flex items-center gap-2">
                  <button id="btnMarcarTodosStatus" class="px-3 py-1.5 text-xs rounded-lg bg-cyan-500/20 text-cyan-300 hover:bg-cyan-500/30 border border-cyan-500/30 transition-colors duration-100">
                    âœ“ Marcar Todos
                  </button>
                  <button id="btnDesmarcarTodosStatus" class="px-3 py-1.5 text-xs rounded-lg bg-slate-500/20 text-slate-300 hover:bg-slate-500/30 border border-slate-500/30 transition-colors duration-100">
                    âœ— Desmarcar Todos
                  </button>
                </div>
              </div>
            <div class="grid grid-cols-12 gap-4">
              <div class="col-span-12 lg:col-span-5 rounded-xl overflow-hidden bg-slate-900/30 flex items-center justify-center">
                <canvas id="chartStatus"></canvas>
              </div>
              <div class="col-span-12 lg:col-span-7">
                <div class="mb-3 flex items-center gap-4 text-xs px-2 py-2 rounded-lg bg-slate-900/30 border border-white/5">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-emerald-400 shadow-sm shadow-emerald-400/50"></div>
                    <span class="text-slate-300 font-medium">Encerradas</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-amber-400 shadow-sm shadow-amber-400/50"></div>
                    <span class="text-slate-300 font-medium">Ativas</span>
                  </div>
                  <div class="ml-auto text-slate-500 text-[10px]">
                    Clique nos itens para mostrar/ocultar
                  </div>
                </div>
                <div id="statusLegend" class="max-h-[400px] overflow-y-auto pr-2 space-y-1 text-xs">
                  <!-- Legenda serÃ¡ preenchida dinamicamente -->
                </div>
              </div>
            </div>
          </div>
        </section>
          <!-- ========== SEÃ‡ÃƒO 7: VISUALIZAÃ‡Ã•ES AVANÃ‡ADAS ========== -->
          <section class="mb-6">
            <div class="flex items-center gap-2 mb-4">
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
              <h2 class="text-sm font-semibold text-indigo-400 uppercase tracking-wider px-3">ğŸ¨ VisualizaÃ§Ãµes AvanÃ§adas</h2>
              <div class="h-px flex-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
            </div>
            <div class="grid grid-cols-12 gap-6">
              <!-- Sankey Diagram: Fluxo Tema â†’ Ã“rgÃ£o â†’ Status -->
              <div class="col-span-12 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-cyan-400">ğŸŒŠ Fluxo de ManifestaÃ§Ãµes: Tema â†’ Ã“rgÃ£o â†’ Status</h3>
                <div id="sankeyChart" style="height: 500px;"></div>
              </div>
              
              <!-- TreeMap: ProporÃ§Ã£o por Categoria -->
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-violet-400">ğŸ—ºï¸ ProporÃ§Ã£o por Categoria (TreeMap)</h3>
                <div id="treemapChart" style="height: 400px;"></div>
              </div>
              
              <!-- Mapa de Calor GeogrÃ¡fico -->
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-emerald-400">ğŸ“ DistribuiÃ§Ã£o GeogrÃ¡fica por Bairro</h3>
                <div id="mapChart" style="height: 400px;"></div>
              </div>
            </div>
          </section>
        
        </section>
        
        <!-- PÃ¡gina Cora - Chat -->
        <section id="page-cora-chat" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6 relative overflow-hidden">
            <div class="absolute inset-0 opacity-30" style="background: radial-gradient(600px 200px at 10% 0%, rgba(167,139,250,0.25), transparent 60%)"></div>
            <div class="relative">
              <h2 class="neon text-xl font-bold mb-2">ğŸ’¬ Cora - Chat</h2>
              <p class="text-slate-400 text-sm">Assistente virtual para dÃºvidas e suporte</p>
            </div>
          </header>
          <div class="glass rounded-2xl p-5">
            <div id="chatContainer" class="flex flex-col h-[600px] bg-slate-900/30 rounded-xl border border-white/10 overflow-hidden">
              <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm font-bold">C</span>
                  </div>
                  <div class="flex-1">
                    <div class="bg-slate-800/60 rounded-lg p-3 text-sm text-slate-200">
                      <div class="font-semibold text-purple-300 mb-1">Cora</div>
                      <div>OlÃ¡! Sou a Cora, sua assistente virtual. Como posso ajudar vocÃª hoje Gestor Municipal?</div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1 ml-1">Agora</div>
                  </div>
                </div>
              </div>
              <div class="border-t border-white/10 p-4">
                <form id="chatForm" class="flex gap-2" onsubmit="return false;">
                  <input 
                    type="text" 
                    id="chatInput" 
                    placeholder="Digite sua mensagem..." 
                    class="flex-1 bg-slate-800/60 border border-white/10 rounded-lg px-4 py-2 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50"
                    autocomplete="off"
                  />
                  <button 
                    type="button" 
                    id="chatSubmitBtn"
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-white font-semibold hover:from-purple-600 hover:to-pink-600 transition-all glow-ring"
                  >
                    Enviar
                  </button>
                </form>
              </div>
            </div>
          </div>
        </section>
        
        <!-- PÃ¡gina por Categoria -->
        <section id="page-categoria" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Tema</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-fuchsia-400">Top Temas</h3>
              <canvas id="chartCategoria"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-fuchsia-400">Heatmap MÃªs x Categoria</h3>
              <div id="heatmapCategoria" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-fuchsia-400">Categorias por MÃªs</h3>
              <canvas id="chartCategoriaMes"></canvas>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Status -->
        <section id="page-status" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Status</h2></header>
          
          <!-- Abas para diferentes visualizaÃ§Ãµes -->
          <div class="mb-6 flex gap-2 border-b border-white/10">
            <button class="tab-status px-4 py-2 font-semibold text-sm transition-colors border-b-2 border-cyan-400 text-cyan-400" data-tab="status">
              Por Status
            </button>
            <button class="tab-status px-4 py-2 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-400 hover:text-slate-300" data-tab="tema">
              Por Tema
            </button>
            <button class="tab-status px-4 py-2 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-400 hover:text-slate-300" data-tab="orgao">
              Por Ã“rgÃ£o
            </button>
          </div>
          
          <!-- ConteÃºdo da aba Por Status -->
          <div id="status-tab-content" class="tab-content">
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-sky-400">DistribuiÃ§Ã£o por Status</h3>
              <canvas id="chartStatusPage"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-sky-400">Heatmap MÃªs x Status</h3>
              <div id="heatmapStatus" class="overflow-auto rounded-xl border border-white/10"></div>
              </div>
              <div class="col-span-12 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-sky-400">Status por MÃªs</h3>
                <canvas id="chartStatusMes"></canvas>
              </div>
            </div>
          </div>
          
          <!-- ConteÃºdo da aba Por Tema -->
          <div id="tema-tab-content" class="tab-content hidden">
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-2 text-sky-400">Status por Tema</h3>
                <canvas id="chartStatusTema"></canvas>
              </div>
              <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-2 text-sky-400">Heatmap MÃªs x Tema</h3>
                <div id="heatmapStatusTema" class="overflow-auto rounded-xl border border-white/10"></div>
              </div>
            </div>
          </div>
          
          <!-- ConteÃºdo da aba Por Ã“rgÃ£o -->
          <div id="orgao-tab-content" class="tab-content hidden">
            <div class="grid grid-cols-12 gap-6">
              <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-2 text-sky-400">Status por Ã“rgÃ£o</h3>
                <canvas id="chartStatusOrgao"></canvas>
              </div>
              <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-2 text-sky-400">Heatmap MÃªs x Ã“rgÃ£o</h3>
                <div id="heatmapStatusOrgao" class="overflow-auto rounded-xl border border-white/10"></div>
              </div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Bairro -->
        <section id="page-bairro" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Bairros</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-amber-400">Top Bairros</h3>
              <canvas id="chartBairro"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-amber-400">Heatmap MÃªs x Bairro</h3>
              <div id="heatmapBairro" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-amber-400">Bairros por MÃªs</h3>
              <canvas id="chartBairroMes"></canvas>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina Por Ã“rgÃ£o e MÃªs (alinhado com Looker Studio) -->
        <section id="page-orgao-mes" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Por Ã“rgÃ£o e MÃªs</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <!-- Painel Esquerdo: ManifestaÃ§Ãµes por Ã“rgÃ£o -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-xl text-cyan-400">ManifestaÃ§Ãµes por Ã“rgÃ£o</h3>
                <div class="text-xs text-slate-400">Total de Ã³rgÃ£os: <span id="totalOrgaos">â€”</span></div>
              </div>
              <div class="space-y-2 max-h-[600px] overflow-y-auto">
                <div id="listaOrgaos" class="space-y-1">
                  <!-- SerÃ¡ preenchido dinamicamente -->
                </div>
              </div>
              <div class="mt-6 pt-4 border-t border-white/10">
                <div class="text-xs text-slate-400 mb-2">INDICADORES</div>
                <div class="flex items-center gap-3">
                  <img src="/dc-logo.png" alt="Duque de Caxias" class="h-8 w-auto object-contain" />
                  <div class="text-xs text-slate-300">FALA CIDADÃƒO!</div>
                </div>
              </div>
            </div>
            
            <!-- Painel Direito: ManifestaÃ§Ãµes por MÃªs -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-xl text-violet-400">ManifestaÃ§Ãµes por MÃªs</h3>
              </div>
              <div class="mb-6">
                <canvas id="chartOrgaoMes"></canvas>
              </div>
              <!-- KPI Total -->
              <div class="mt-6 glass rounded-xl p-6 text-center" style="background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(167,139,250,0.15));">
                <div class="text-sm text-slate-400 mb-2">ManifestaÃ§Ãµes</div>
                <div id="totalOrgaoMes" class="text-5xl font-extrabold text-cyan-300 mb-2">â€”</div>
                <div class="text-xs text-slate-400">TOTAL CADASTRADAS ATÃ‰ O MOMENTO</div>
              </div>
            </div>
            
            <!-- Tabela Por Ã“rgÃ£o e MÃªs -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Tabela: ManifestaÃ§Ãµes por Ã“rgÃ£o e MÃªs</h3>
              <div class="overflow-x-auto">
                <div id="tabelaOrgaoMes" class="min-w-full">
                  <!-- SerÃ¡ preenchido dinamicamente -->
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Secretaria -->
        <section id="page-secretaria" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">AnÃ¡lise por Secretaria (Ã“rgÃ£o)</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-cyan-400">Registros por Secretaria</h3>
              <canvas id="chartSecretaria"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-cyan-400">Top 10 Secretarias (Rank)</h3>
              <ul id="rankSecretaria" class="space-y-2"></ul>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Secretarias por MÃªs</h3>
              <canvas id="chartSecretariaMes"></canvas>
            </div>
          </div>
        </section>
        
        <!-- PÃ¡gina Secretarias e Distritos -->
        <section id="page-secretarias-distritos" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6">
            <h2 class="neon text-xl font-bold">Secretarias e Distritos</h2>
            <p class="text-slate-400 text-sm mt-2">AnÃ¡lise de secretarias municipais por distrito</p>
          </header>
          
          <div class="grid grid-cols-12 gap-6">
            <!-- Lista de Distritos -->
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Distritos de Duque de Caxias</h3>
              <div id="listaDistritos" class="space-y-3 max-h-[600px] overflow-y-auto">
                <!-- Preenchido dinamicamente -->
              </div>
            </div>
            
            <!-- Secretarias por Distrito Selecionado -->
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">
                Secretarias do <span id="distritoSelecionadoNome" class="text-cyan-300">Selecione um distrito</span>
              </h3>
              <div id="listaSecretarias" class="space-y-3">
                <div class="text-center text-slate-400 py-8">Selecione um distrito para ver as secretarias</div>
              </div>
            </div>
            
            <!-- EstatÃ­sticas Gerais -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-emerald-400">EstatÃ­sticas</h3>
              <div id="estatisticasDistritos" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Preenchido dinamicamente -->
              </div>
            </div>
            
            <!-- GrÃ¡fico de Secretarias por Distrito -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-amber-400">DistribuiÃ§Ã£o de Secretarias por Distrito</h3>
              <canvas id="chartSecretariasDistritos"></canvas>
            </div>
          </div>
        </section>
        
        <!-- PÃ¡gina por Tipo de ManifestaÃ§Ã£o -->
        <section id="page-tipo" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Tipos de ManifestaÃ§Ã£o</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-violet-400">DistribuiÃ§Ã£o por Tipo (ReclamaÃ§Ã£o/Elogio/...)</h3>
              <canvas id="chartTipo"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-violet-400">Top Tipos (Rank)</h3>
              <ul id="rankTipo" class="space-y-2"></ul>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Setor -->
        <section id="page-setor" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">AnÃ¡lise por Setor/Departamento</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-emerald-400">Registros por Setor</h3>
              <canvas id="chartSetor"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-emerald-400">Top 10 Unidades de Cadastro (Rank)</h3>
              <ul id="rankSetor" class="space-y-2"></ul>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por UAC (Unidade de Atendimento ao CidadÃ£o) -->
        <section id="page-uac" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Unidades de Atendimento ao CidadÃ£o (UAC)</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-cyan-400">Total por UAC</h3>
              <canvas id="chartUAC"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-cyan-400">Top 10 UACs (Rank)</h3>
              <ul id="rankUAC" class="space-y-2"></ul>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-cyan-400">Heatmap MÃªs x UAC</h3>
              <div id="heatmapUAC" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por ResponsÃ¡veis -->
        <section id="page-responsavel" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">ResponsÃ¡veis pelo Tratamento da Demanda</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-violet-400">DistribuiÃ§Ã£o por ResponsÃ¡vel</h3>
              <canvas id="chartResponsavel"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-violet-400">Top ResponsÃ¡veis (Rank)</h3>
              <ul id="rankResponsavel" class="space-y-2"></ul>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-violet-400">Heatmap MÃªs x ResponsÃ¡vel</h3>
              <div id="heatmapResponsavel" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Canal -->
        <section id="page-canal" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Canais de Atendimento</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-emerald-400">DistribuiÃ§Ã£o por Canal</h3>
              <canvas id="chartCanal"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-emerald-400">Top Canais (Rank)</h3>
              <ul id="rankCanal" class="space-y-2"></ul>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-emerald-400">Heatmap MÃªs x Canal</h3>
              <div id="heatmapCanal" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina por Prioridade -->
        <section id="page-prioridade" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Prioridades das Demandas</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-rose-400">DistribuiÃ§Ã£o por Prioridade</h3>
              <canvas id="chartPrioridade"></canvas>
            </div>
            <div class="col-span-12 md:col-span-6 glass rounded-2xl p-5 ">
              <h3 class="font-semibold mb-2 text-rose-400">Ranking de Prioridades</h3>
              <ul id="rankPrioridade" class="space-y-2"></ul>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-2 text-rose-400">Heatmap MÃªs x Prioridade</h3>
              <div id="heatmapPrioridade" class="overflow-auto rounded-xl border border-white/10"></div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina Tempo MÃ©dio de Atendimento -->
        <section id="page-tempo-medio" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6">
              <h2 class="neon text-xl font-bold">Tempo MÃ©dio de Atendimento / Dias</h2>
          </header>
          
          <!-- EstatÃ­sticas Gerais -->
          <div class="grid grid-cols-12 gap-6 mb-6">
            <div class="col-span-12 md:col-span-3 glass rounded-2xl p-5">
              <div class="text-slate-400 text-sm mb-2">MÃ©dia Geral</div>
              <div id="statMedia" class="text-3xl font-extrabold text-cyan-300">â€”</div>
              <div class="text-xs text-slate-500 mt-1">dias</div>
            </div>
            <div class="col-span-12 md:col-span-3 glass rounded-2xl p-5">
              <div class="text-slate-400 text-sm mb-2">Mediana</div>
              <div id="statMediana" class="text-3xl font-extrabold text-purple-300">â€”</div>
              <div class="text-xs text-slate-500 mt-1">dias</div>
            </div>
            <div class="col-span-12 md:col-span-3 glass rounded-2xl p-5">
              <div class="text-slate-400 text-sm mb-2">MÃ­nimo</div>
              <div id="statMinimo" class="text-3xl font-extrabold text-emerald-300">â€”</div>
              <div class="text-xs text-slate-500 mt-1">dias</div>
            </div>
            <div class="col-span-12 md:col-span-3 glass rounded-2xl p-5">
              <div class="text-slate-400 text-sm mb-2">MÃ¡ximo</div>
              <div id="statMaximo" class="text-3xl font-extrabold text-red-300">â€”</div>
              <div class="text-xs text-slate-500 mt-1">dias</div>
            </div>
          </div>

          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Tempo MÃ©dio por Ã“rgÃ£o/Unidade</h3>
              <canvas id="chartTempoMedio"></canvas>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Ranking</h3>
              <div id="listaTempoMedio" class="space-y-2 max-h-[500px] overflow-y-auto"></div>
            </div>
            
            <!-- GrÃ¡fico por Dia -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">TendÃªncia DiÃ¡ria (Ãšltimos 30 dias)</h3>
              <canvas id="chartTempoMedioDia"></canvas>
            </div>
            
            <!-- GrÃ¡fico por Semana -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">TendÃªncia Semanal (Ãšltimas 12 semanas)</h3>
              <canvas id="chartTempoMedioSemana"></canvas>
            </div>
            
            <!-- GrÃ¡fico por MÃªs -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">TendÃªncia Mensal (Ãšltimos 12 meses)</h3>
              <canvas id="chartTempoMedioMes"></canvas>
            </div>
            
            <!-- Tempo MÃ©dio por Unidade de Cadastro -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">Tempo MÃ©dio por Unidade de Cadastro</h3>
              <canvas id="chartTempoMedioUnidade"></canvas>
            </div>
            
            <!-- Tempo MÃ©dio por Unidade de Cadastro por MÃªs -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-emerald-400">Tempo MÃ©dio por Unidade de Cadastro por MÃªs</h3>
              <canvas id="chartTempoMedioUnidadeMes"></canvas>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina Por Tema -->
        <section id="page-tema" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">ManifestaÃ§Ãµes por Tema</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">DistribuiÃ§Ã£o por Tema</h3>
              <canvas id="chartTema"></canvas>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-violet-400">Status Geral</h3>
              </div>
              <canvas id="chartStatusTema"></canvas>
              <div id="statusTemaInfo" class="mt-4 space-y-2 text-sm"></div>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">Filtro / MÃªs</h3>
              <canvas id="chartTemaMes"></canvas>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-violet-400">Lista Completa de Temas</h3>
                <div id="filtrosTemaInfo" class="text-xs text-slate-400"></div>
              </div>
              <div id="listaTemas" class="space-y-2 max-h-[500px] overflow-y-auto"></div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina Por Assunto -->
        <section id="page-assunto" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total por Assunto</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-emerald-400">Top 15 Assuntos</h3>
                <span class="text-xs text-slate-400">(Lista completa abaixo)</span>
              </div>
              <div style="height: 500px; position: relative;">
              <canvas id="chartAssunto"></canvas>
              </div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-emerald-400">Status</h3>
              </div>
              <canvas id="chartStatusAssunto"></canvas>
              <div id="statusAssuntoInfo" class="mt-4 space-y-2 text-sm"></div>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-emerald-400">Lista Completa de Assuntos</h3>
              <div id="listaAssuntos" class="space-y-2 max-h-[500px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-emerald-400">Assuntos por MÃªs</h3>
              <canvas id="chartAssuntoMes"></canvas>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina Por Cadastrante -->
        <section id="page-cadastrante" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-2">
              <h2 class="neon text-xl font-bold">Por Cadastrante / Unidade</h2>
              <div id="filtrosCadastranteInfo" class="text-xs text-slate-400"></div>
            </div>
          </header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Por Servidor</h3>
              <div id="listaServidores" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">Unidades de Cadastro</h3>
              <div id="listaUnidadesCadastro" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">Filtro / MÃªs</h3>
              <canvas id="chartCadastranteMes"></canvas>
            </div>
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5 text-center" style="background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(167,139,250,0.15));">
              <div class="text-sm text-slate-400 mb-2">ManifestaÃ§Ãµes</div>
              <div id="totalCadastrante" class="text-6xl font-extrabold text-cyan-300 mb-2">â€”</div>
              <div class="text-xs text-slate-400">TOTAL CADASTRADAS ATÃ‰ O MOMENTO</div>
            </div>
            <!-- GrÃ¡ficos adicionais que aparecem quando hÃ¡ filtro ativo -->
            <div id="graficosFiltrados" class="col-span-12 grid grid-cols-12 gap-6" style="display: none;">
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-amber-400">Por Tema (Filtrado)</h3>
                <canvas id="chartCadastranteTema"></canvas>
              </div>
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-pink-400">Por Assunto (Filtrado)</h3>
                <canvas id="chartCadastranteAssunto"></canvas>
              </div>
              <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
                <h3 class="font-semibold mb-4 text-emerald-400">Por Status (Filtrado)</h3>
                <canvas id="chartCadastranteStatus"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- PÃ¡gina ReclamaÃ§Ãµes e DenÃºncias -->
        <section id="page-reclamacoes" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos (ReclamaÃ§Ãµes e DenÃºncias)</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-rose-400">Assuntos</h3>
              <div id="listaReclamacoes" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-rose-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas id="chartReclamacoesTipo"></canvas>
            </div>
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-rose-400">Quantidade por MÃªs</h3>
              <canvas id="chartReclamacoesMes"></canvas>
            </div>
          </div>
        </section>
        
        <!-- PÃ¡gina ProjeÃ§Ã£o 2026 -->
        <section id="page-projecao-2026" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6">
            <h2 class="neon text-xl font-bold">ğŸ“ˆ ProjeÃ§Ã£o 2026</h2>
            <p class="text-slate-400 text-sm mt-2">AnÃ¡lise de tendÃªncias e projeÃ§Ãµes baseadas em dados histÃ³ricos</p>
          </header>
          
          <div class="grid grid-cols-12 gap-6">
            <!-- GrÃ¡fico de TendÃªncia Mensal -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">TendÃªncia Mensal (HistÃ³rico + ProjeÃ§Ã£o)</h3>
              <canvas id="chartProjecaoMensal"></canvas>
            </div>
            
            <!-- ProjeÃ§Ã£o por Tema -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-violet-400">Top Temas (ProjeÃ§Ã£o)</h3>
              <canvas id="chartProjecaoTema"></canvas>
            </div>
            
            <!-- Status Projetado -->
            <div class="col-span-12 lg:col-span-6 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-emerald-400">DistribuiÃ§Ã£o por Status (ProjeÃ§Ã£o)</h3>
              <canvas id="chartProjecaoStatus"></canvas>
              <div id="projecaoStatusInfo" class="mt-4 space-y-2 text-sm"></div>
            </div>
            
            <!-- Resumo de ProjeÃ§Ãµes -->
            <div class="col-span-12 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-amber-400">Resumo de ProjeÃ§Ãµes para 2026</h3>
              <div id="resumoProjecao" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Preenchido dinamicamente -->
              </div>
            </div>
          </div>
        </section>
        
        <!-- PÃ¡ginas de Unidades -->
        <section id="page-unit-adao" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital AdÃ£o</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-cer-iv" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos CER IV</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-hospital-olho" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital do Olho</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-hospital-duque" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital Duque</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-hospital-infantil" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital Infantil</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-hospital-moacyr" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital Moacyr</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-maternidade-santa-cruz" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Maternidade Santa Cruz</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-upa-beira-mar" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPA Beira Mar</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-pilar" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH Pilar</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-saracuruna" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH Saracuruna</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-xerem" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH XerÃ©m</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-hospital-veterinario" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos Hospital VeterinÃ¡rio</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-upa-walter-garcia" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPA Walter Garcia</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-campos-eliseos" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH Campos ElÃ­seos</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-parque-equitativa" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH Parque Equitativa</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-ubs-antonio-granja" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UBS Antonio Granja</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-upa-sarapui" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPA SarapuÃ­</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
        <section id="page-unit-uph-imbarie" class="unit-page" style="display:none">
          <header class="glass rounded-2xl p-6 mb-6"><h2 class="neon text-xl font-bold">Total de Assuntos UPH ImbariÃª</h2></header>
          <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Assuntos</h3>
              <div class="unit-assuntos space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="col-span-12 lg:col-span-4 glass rounded-2xl p-5">
              <h3 class="font-semibold mb-4 text-cyan-400">Record Count por Tipo de AÃ§Ã£o</h3>
              <canvas class="unit-tipos"></canvas>
            </div>
          </div>
        </section>
      </main>
      
      <!-- Widget de Chat Flutuante (sempre visÃ­vel) -->
      <div id="chatWidget" class="fixed bottom-6 right-6 z-50">
        <div id="chatWidgetToggle" class="w-14 h-14 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 shadow-lg cursor-pointer flex items-center justify-center hover:scale-110 transition-transform glow-ring">
          <span class="text-white text-2xl">ğŸ’¬</span>
        </div>
        <div id="chatWidgetWindow" class="hidden absolute bottom-20 right-0 w-80 h-96 glass rounded-2xl border border-white/10 shadow-2xl flex flex-col overflow-hidden">
          <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 p-4 border-b border-white/10 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                <span class="text-white text-sm font-bold">C</span>
              </div>
              <div>
                <div class="font-semibold text-slate-200">Cora</div>
                <div class="text-xs text-slate-400">Online</div>
              </div>
            </div>
            <button id="chatWidgetClose" class="text-slate-400 hover:text-slate-200 transition-colors duration-100">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div id="chatWidgetMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="flex items-start gap-2">
              <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                <span class="text-white text-xs font-bold">C</span>
              </div>
              <div class="flex-1">
                <div class="bg-slate-800/60 rounded-lg p-2 text-xs text-slate-200">
                  OlÃ¡! Como posso ajudar?
                </div>
              </div>
            </div>
          </div>
          <div class="border-t border-white/10 p-3">
            <form id="chatWidgetForm" class="flex gap-2" onsubmit="return false;">
              <input 
                type="text" 
                id="chatWidgetInput" 
                placeholder="Digite..." 
                class="flex-1 bg-slate-800/60 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-purple-500/50"
                autocomplete="off"
              />
              <button 
                type="button" 
                id="chatWidgetSubmitBtn"
                class="px-3 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-white text-xs font-semibold hover:from-purple-600 hover:to-pink-600 transition-all"
              >
                â†’
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script>
      // Registrar plugin de datalabels
      if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
      }
      
      // FunÃ§Ã£o helper para criar tooltips melhorados
      function createEnhancedTooltip() {
        return {
          enabled: true,
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#e2e8f0',
          bodyColor: '#cbd5e1',
          borderColor: 'rgba(34, 211, 238, 0.3)',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            title: function(context) {
              return context[0].label || '';
            },
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + (b || 0), 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: ${value.toLocaleString('pt-BR')} (${percentage}%)`;
            }
          }
        };
      }
      
      // FunÃ§Ã£o helper para configurar datalabels
      function createDataLabelsConfig(showPercentage = false, chartType = 'bar', showAll = true) {
        // ConfiguraÃ§Ãµes base por tipo de grÃ¡fico
        const baseConfig = {
          color: '#e2e8f0',
          font: {
            size: 11,
            weight: 'bold'
          },
          formatter: function(value, context) {
            // Verificar se value Ã© vÃ¡lido
            if (value === null || value === undefined || isNaN(value)) {
              return '';
            }
            const numValue = Number(value);
            if (isNaN(numValue) || numValue === 0) {
              return '';
            }
            if (showPercentage && context.dataset && context.dataset.data) {
              const total = context.dataset.data.reduce((a, b) => a + (Number(b) || 0), 0);
              const percentage = total > 0 ? ((numValue / total) * 100).toFixed(1) : 0;
              return numValue.toLocaleString('pt-BR') + '\n(' + percentage + '%)';
            }
            return numValue.toLocaleString('pt-BR');
          },
          padding: 4,
          backgroundColor: 'rgba(15, 23, 42, 0.7)',
          borderRadius: 4
        };
        
        // Ajustar anchor e align baseado no tipo de grÃ¡fico
        if (chartType === 'doughnut' || chartType === 'pie') {
          baseConfig.anchor = 'center';
          baseConfig.align = 'center';
        } else if (chartType === 'bar' && showAll) {
          baseConfig.anchor = 'end';
          baseConfig.align = 'top';
        } else {
          baseConfig.anchor = 'end';
          baseConfig.align = 'top';
        }
        
        return baseConfig;
      }
      
      // FunÃ§Ã£o helper para adicionar eventos de clique
      function addChartClickHandler(chart, onClickCallback, chartId = null) {
        chart.canvas.style.cursor = 'pointer';
        chart.canvas.onclick = function(evt) {
          const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
          if (points.length) {
            const firstPoint = points[0];
            const label = chart.data.labels[firstPoint.index];
            const value = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
            
            // Aplicar filtro global se chartId for fornecido
            if (chartId && chartFieldMap[chartId]) {
              const fieldConfig = chartFieldMap[chartId];
              if (fieldConfig.field) {
                applyGlobalFilter(fieldConfig.field, label, chartId);
              }
            }
            
            if (onClickCallback) {
            onClickCallback(label, value, firstPoint.index);
            }
          }
        };
      }
      
      // FunÃ§Ã£o para mostrar feedback visual ao clicar
      function showClickFeedback(element, label, value) {
        const feedback = document.createElement('div');
        feedback.className = 'fixed top-4 right-4 glass rounded-lg p-4 z-50';
        feedback.innerHTML = `
          <div class="text-cyan-300 font-bold text-lg">${label}</div>
          <div class="text-slate-300 text-sm">Valor: ${value.toLocaleString('pt-BR')}</div>
        `;
        document.body.appendChild(feedback);
        setTimeout(() => {
          // AnimaÃ§Ã£o removida para melhor performance
          setTimeout(() => feedback.remove(), 100);
        }, 2000);
      }
      
      function gradient(ctx, from, to) {
        const g = ctx.createLinearGradient(0, 0, 0, 300);
        g.addColorStop(0, from);
        g.addColorStop(1, to);
        return g;
      }

      async function fetchJSON(url, opts) {
          const res = await fetch(url, opts);
        if (!res.ok) throw new Error('Request failed');
        return res.json();
      }

      // ========== SISTEMA DE FILTROS GLOBAL ==========
      // Estado global de filtros
      window.globalFilters = {
        filters: [],
        activeField: null,
        activeValue: null
      };

      // Mapeamento de campos de grÃ¡ficos para campos de filtro
      const chartFieldMap = {
        'chartStatus': { field: 'Status', op: 'eq' },
        'chartStatusPage': { field: 'Status', op: 'eq' },
        'chartStatusTema': { field: 'Status', op: 'eq' },
        'chartStatusAssunto': { field: 'Status', op: 'eq' },
        'chartTrend': { field: 'Data', op: 'contains' },
        'chartTopOrgaos': { field: 'Orgaos', op: 'contains' },
        'chartTopTemas': { field: 'Tema', op: 'eq' },
        'chartFunnelStatus': { field: 'Status', op: 'eq' },
        'chartSlaOverview': { field: null, op: null },
        'chartOrgaoMes': { field: 'Orgaos', op: 'contains' },
        'chartSecretaria': { field: 'Secretaria', op: 'contains' },
        'chartTipo': { field: 'Tipo', op: 'eq' },
        'chartSetor': { field: 'Setor', op: 'contains' },
        'chartCategoria': { field: 'Categoria', op: 'eq' },
        'chartBairro': { field: 'Bairro', op: 'contains' },
        'chartUAC': { field: 'UAC', op: 'contains' },
        'chartResponsavel': { field: 'Responsavel', op: 'contains' },
        'chartCanal': { field: 'Canal', op: 'eq' },
        'chartPrioridade': { field: 'Prioridade', op: 'eq' },
        'chartTema': { field: 'Tema', op: 'eq' },
        'chartAssunto': { field: 'Assunto', op: 'contains' },
        'chartMonth': { field: 'Data', op: 'contains' },
        'chartTempoMedio': { field: 'Orgaos', op: 'contains' },
        'chartTempoMedioMes': { field: 'Data', op: 'contains' },
        'chartCount': { field: null, op: null }, // Campo dinÃ¢mico
        'chartTime': { field: null, op: null }, // Campo dinÃ¢mico
        'chartSla': { field: null, op: null } // NÃ£o filtra
      };

      // FunÃ§Ã£o para aplicar filtro
      function applyGlobalFilter(field, value, chartId = null) {
        if (!field || !value) return;
        
        // Determinar operaÃ§Ã£o baseado no tipo de campo
        let op = 'contains';
        if (chartId && chartFieldMap[chartId]) {
          op = chartFieldMap[chartId].op || 'contains';
          field = chartFieldMap[chartId].field || field;
        }
        
        // Remover filtros anteriores do mesmo campo
        window.globalFilters.filters = window.globalFilters.filters.filter(f => f.field !== field);
        
        // Adicionar novo filtro
        window.globalFilters.filters.push({ field, value, op });
        window.globalFilters.activeField = field;
        window.globalFilters.activeValue = value;
        
        // Atualizar indicador visual
        updateFilterIndicator();
        
        // Recarregar todos os dados
        reloadAllData();
      }

      // FunÃ§Ã£o para limpar todos os filtros (global)
      window.clearGlobalFilters = function() {
        window.globalFilters.filters = [];
        window.globalFilters.activeField = null;
        window.globalFilters.activeValue = null;
        updateFilterIndicator();
        reloadAllData();
      }

      // FunÃ§Ã£o para atualizar indicador visual de filtros
      function updateFilterIndicator() {
        const indicator = document.getElementById('filterIndicator');
        if (!indicator) return;
        
        if (window.globalFilters.filters.length > 0) {
          const filterText = window.globalFilters.filters.map(f => `${f.field}: ${f.value}`).join(', ');
          indicator.innerHTML = `
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-cyan-500/20 border border-cyan-500/30">
              <span class="text-cyan-300 text-sm">ğŸ” Filtro ativo:</span>
              <span class="text-slate-200 text-sm">${filterText}</span>
              <button onclick="clearGlobalFilters()" class="ml-2 text-cyan-300 hover:text-cyan-100 text-sm font-bold">âœ•</button>
            </div>
          `;
          indicator.classList.remove('hidden');
        } else {
          indicator.classList.add('hidden');
        }
      }

      // FunÃ§Ã£o para recarregar todos os dados com filtros
      async function reloadAllData() {
        const currentPage = document.querySelector('[data-page].active')?.getAttribute('data-page') || 'main';
        
        // Recarregar dados da pÃ¡gina principal (usar Overview completo)
        if (currentPage === 'main' || currentPage === '') {
          await loadOverview();
        }
        
        // Recarregar dados especÃ­ficos da pÃ¡gina atual
        if (currentPage === 'orgao-mes') await loadOrgaoMes();
        if (currentPage === 'tempo-medio') {
          await loadTempoMedio();
        }
        if (currentPage === 'tema') await loadTema();
        if (currentPage === 'assunto') await loadAssunto();
        if (currentPage === 'cadastrante') await loadCadastrante();
        if (currentPage === 'reclamacoes') await loadReclamacoes();
        if (currentPage === 'projecao-2026') await loadProjecao2026();
        if (currentPage === 'status') await loadStatusPage();
        if (currentPage === 'bairro') await loadBairro();
        if (currentPage === 'uac') await loadUAC();
        if (currentPage === 'responsavel') await loadResponsavel();
        if (currentPage === 'canal') await loadCanal();
        if (currentPage === 'prioridade') await loadPrioridade();
        if (currentPage === 'categoria') await loadCategoria();
      }

      // FunÃ§Ã£o para buscar dados com filtros aplicados
      async function fetchJSONWithFilters(url, opts = {}) {
        if (window.globalFilters.filters.length === 0) {
          return await fetchJSON(url, opts);
        }
        
        // Se hÃ¡ filtros, usar endpoint de filtro
        const filterUrl = '/api/filter';
        const filterOpts = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filters: window.globalFilters.filters })
        };
        
        const filteredData = await fetchJSON(filterUrl, filterOpts);
        
        // Para endpoints de agregaÃ§Ã£o, precisamos processar os dados filtrados
        // Por enquanto, retornamos os dados filtrados e processamos no cliente
        return filteredData;
      }
      
      // Alias para compatibilidade - usar fetchJSONWithFilters
      async function fetchJSONWithFilter(url, opts = {}) {
        return await fetchJSONWithFilters(url, opts);
      }

      // ========== Carregamento da VisÃ£o Geral ==========
      // FunÃ§Ã£o para carregar insights com IA
      async function loadAIInsights() {
        try {
          const data = await fetchJSONWithFilter('/api/ai/insights').catch(() => ({ insights: [], geradoPorIA: false }));
          
          const insightsAIBox = document.getElementById('insightsAIBox');
          if (!insightsAIBox) return;
          
          if (!data.insights || data.insights.length === 0) {
            insightsAIBox.innerHTML = '<div class="text-center text-slate-400 py-4">Nenhum insight disponÃ­vel no momento.</div>';
            return;
          }
          
          const severidadeColors = {
            alta: 'border-red-500/50 bg-red-500/10',
            media: 'border-amber-500/50 bg-amber-500/10',
            baixa: 'border-blue-500/50 bg-blue-500/10'
          };
          
          const tipoIcons = {
            anomalia: 'âš ï¸',
            tendencia: 'ğŸ“ˆ',
            volume: 'ğŸ“Š',
            tempo: 'â±ï¸'
          };
          
          insightsAIBox.innerHTML = data.insights.map(insight => `
            <div class="glass rounded-xl p-4 border ${severidadeColors[insight.severidade] || 'border-white/10'} hover:border-white/20 transition-all">
              <div class="flex items-start gap-3">
                <div class="text-2xl">${tipoIcons[insight.tipo] || 'ğŸ’¡'}</div>
                <div class="flex-1">
                  <div class="font-semibold text-emerald-300 mb-2">${insight.insight}</div>
                  <div class="text-sm text-slate-400 mt-2">
                    <div class="font-medium text-cyan-300 mb-1">ğŸ’¡ RecomendaÃ§Ã£o:</div>
                    <div>${insight.recomendacao}</div>
                  </div>
                  ${data.geradoPorIA ? '<div class="text-xs text-slate-500 mt-2">âœ¨ Gerado por IA</div>' : ''}
                </div>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('âŒ Erro ao carregar insights com IA:', error);
          const insightsAIBox = document.getElementById('insightsAIBox');
          if (insightsAIBox) {
            insightsAIBox.innerHTML = '<div class="text-center text-red-400 py-4">Erro ao carregar insights. Tente novamente.</div>';
          }
        }
      }

      // FunÃ§Ã£o para carregar Status Overview
      async function loadStatusOverview() {
        try {
          const statusData = await fetchJSONWithFilter('/api/stats/status-overview').catch(() => null);
          const statusCards = document.getElementById('statusOverviewCards');
          if (!statusCards) return;
          
          if (!statusData || !statusData.total) {
            statusCards.innerHTML = '<div class="text-center text-slate-400 py-4">Nenhum dado disponÃ­vel</div>';
            return;
          }
          
          const cards = [
            {
              label: 'Total',
              value: statusData.total?.quantidade || 0,
              color: 'cyan',
              icon: 'ğŸ“Š'
            },
            {
              label: 'ConcluÃ­das',
              value: statusData.concluida?.quantidade || 0,
              percent: statusData.concluida?.percentual || 0,
              color: 'emerald',
              icon: 'âœ…'
            },
            {
              label: 'Em Atendimento',
              value: statusData.emAtendimento?.quantidade || 0,
              percent: statusData.emAtendimento?.percentual || 0,
              color: 'amber',
              icon: 'â³'
            },
            {
              label: 'Pendentes',
              value: statusData.pendente?.quantidade || 0,
              percent: statusData.pendente?.percentual || 0,
              color: 'rose',
              icon: 'ğŸ“‹'
            }
          ];
          
          const colorClasses = {
            cyan: { border: 'border-cyan-500/20', borderHover: 'hover:border-cyan-500/40', text: 'text-cyan-300' },
            emerald: { border: 'border-emerald-500/20', borderHover: 'hover:border-emerald-500/40', text: 'text-emerald-300' },
            amber: { border: 'border-amber-500/20', borderHover: 'hover:border-amber-500/40', text: 'text-amber-300' },
            rose: { border: 'border-rose-500/20', borderHover: 'hover:border-rose-500/40', text: 'text-rose-300' }
          };
          
          statusCards.innerHTML = cards.map(card => {
            const colors = colorClasses[card.color] || colorClasses.cyan;
            return `
            <div class="glass rounded-xl p-4 border ${colors.border} ${colors.borderHover} transition-all">
              <div class="flex items-center justify-between mb-2">
                <div class="text-xs text-slate-400 font-medium">${card.label}</div>
                <div class="text-xl">${card.icon}</div>
              </div>
              <div class="text-2xl font-bold ${colors.text}">${(card.value || 0).toLocaleString('pt-BR')}</div>
              ${card.percent !== undefined ? `<div class="text-xs text-slate-400 mt-1">${card.percent.toFixed(1)}%</div>` : ''}
            </div>
          `;
          }).join('');
        } catch (error) {
          console.error('âŒ Erro ao carregar Status Overview:', error);
          const statusCards = document.getElementById('statusOverviewCards');
          if (statusCards) {
            statusCards.innerHTML = '<div class="text-center text-red-400 py-4">Erro ao carregar dados</div>';
          }
        }
      }

      async function loadOverview() {
        try {
          // Carregar KPIs primeiro (mais importante para o usuÃ¡rio ver)
          await loadKpis();
          
          // Buscar summary uma vez e reutilizar (evita duplicaÃ§Ã£o)
          let summaryData = null;
          
          // Fazer TODAS as requisiÃ§Ãµes em PARALELO para melhor performance
          const [
            byMonth,
            orgaos,
            temas,
            summary
          ] = await Promise.all([
            fetchJSONWithFilter('/api/aggregate/by-month'),
            fetchJSONWithFilter('/api/aggregate/count-by?field=Orgaos'),
            fetchJSONWithFilter('/api/aggregate/by-theme'),
            fetchJSONWithFilter('/api/summary')
          ]);
          
          summaryData = summary; // Guardar para reutilizar

          // Processar dados de tendÃªncia mensal
          const labels = byMonth.map(x => {
            const ym = x.ym || x.month || '';
            if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
            const parts = ym.split('-');
            if (parts.length < 2) return ym;
            const [year, month] = parts;
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : ym;
          });
          const values = byMonth.map(x => x.count || 0);
          if (window.chartTrend instanceof Chart) window.chartTrend.destroy();
          const ctxTrend = document.getElementById('chartTrend')?.getContext('2d');
          if (ctxTrend) {
            window.chartTrend = new Chart(ctxTrend, {
              type: 'line',
              data: { labels, datasets: [{
                  label: 'ManifestaÃ§Ãµes',
                  data: values,
                  fill: true,
                  borderColor: '#22d3ee',
                  backgroundColor: gradient(ctxTrend, 'rgba(34,211,238,0.35)', 'rgba(34,211,238,0.05)'),
                  tension: 0.35,
                  borderWidth: 2,
                pointRadius: 3
              }]},
              options: {
                responsive: true,
                plugins: { legend: { display: false }, tooltip: createEnhancedTooltip(), datalabels: { display: false } },
                scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' }, beginAtZero: true } }
              }
            });
            addChartClickHandler(window.chartTrend, (label, value) => showClickFeedback(null, label, value), 'chartTrend');
          }

          // Top Ã“rgÃ£os
          const orgLabels = orgaos.slice(0, 10).map(x => x.key);
          const orgValues = orgaos.slice(0, 10).map(x => x.count);
          if (window.chartTopOrgaos instanceof Chart) window.chartTopOrgaos.destroy();
          const ctxOrg = document.getElementById('chartTopOrgaos')?.getContext('2d');
          if (ctxOrg) {
            window.chartTopOrgaos = new Chart(ctxOrg, {
              type: 'bar',
              data: { labels: orgLabels, datasets: [{ data: orgValues, backgroundColor: 'rgba(167,139,250,0.7)', borderColor: 'rgba(167,139,250,1)', borderWidth: 1 }] },
              options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false }, tooltip: createEnhancedTooltip(), datalabels: createDataLabelsConfig() }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
            });
            addChartClickHandler(window.chartTopOrgaos, (label, value) => showClickFeedback(null, label, value), 'chartTopOrgaos');
          }

          // Top Temas
          const temaLabels = temas.slice(0, 10).map(x => x.tema);
          const temaValues = temas.slice(0, 10).map(x => x.quantidade);
          if (window.chartTopTemas instanceof Chart) window.chartTopTemas.destroy();
          const ctxTemas = document.getElementById('chartTopTemas')?.getContext('2d');
          if (ctxTemas) {
            window.chartTopTemas = new Chart(ctxTemas, {
              type: 'bar',
              data: { labels: temaLabels, datasets: [{ data: temaValues, backgroundColor: 'rgba(34,211,238,0.7)', borderColor: 'rgba(34,211,238,1)', borderWidth: 1 }] },
              options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false }, tooltip: createEnhancedTooltip(), datalabels: createDataLabelsConfig() }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
            });
            addChartClickHandler(window.chartTopTemas, (label, value) => showClickFeedback(null, label, value), 'chartTopTemas');
          }

          // Funil por status (reutiliza summary jÃ¡ carregado)
          const statusCounts = (summaryData.statusCounts || []).slice(0, 6);
          const funilLabels = statusCounts.map(s => s.status);
          const funilValues = statusCounts.map(s => s.count);
          if (window.chartFunnelStatus instanceof Chart) window.chartFunnelStatus.destroy();
          const ctxFunnel = document.getElementById('chartFunnelStatus')?.getContext('2d');
          if (ctxFunnel) {
            window.chartFunnelStatus = new Chart(ctxFunnel, {
              type: 'bar',
              data: { labels: funilLabels, datasets: [{ data: funilValues, backgroundColor: ['#22d3ee','#a78bfa','#34d399','#f59e0b','#fb7185','#e879f9'] }] },
              options: { responsive: true, plugins: { legend: { display: false }, tooltip: createEnhancedTooltip(), datalabels: createDataLabelsConfig() }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' }, beginAtZero: true } } }
            });
            addChartClickHandler(window.chartFunnelStatus, (label, value) => showClickFeedback(null, label, value), 'chartFunnelStatus');
          }

          // Sparks e deltas rÃ¡pidos usando byMonth
          const totalNow = values[values.length-1] || 0;
          const totalPrev = values[values.length-2] || 0;
          const delta = totalPrev ? (((totalNow-totalPrev)/totalPrev)*100).toFixed(1) : 0;
          const deltaEl = document.getElementById('kpiTotalDelta');
          if (deltaEl) deltaEl.textContent = `${delta>=0?'+':''}${delta}% vs mÃªs anterior`;

          // Desenhar sparks simples
          const drawSpark = (canvasId, data, color) => {
            const c = document.getElementById(canvasId);
            if (!c) return;
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,c.width,c.height);
            const w = c.width || c.offsetWidth; const h = c.height || 32;
            const max = Math.max(...data,1); const step = w/(data.length-1 || 1);
            ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
            data.forEach((v,i)=>{ const x=i*step; const y=h - (v/max)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
            ctx.stroke();
          };
          drawSpark('sparkTotal', values.slice(-12), '#22d3ee');

          // Carregar insights com IA
          await loadAIInsights();
          
          // Carregar Status Overview
          await loadStatusOverview();
          
          // Insights bÃ¡sicos (fallback)
          const insights = [];
          if (orgaos.length) insights.push(`Maior volume: ${orgaos[0].key} (${orgaos[0].count.toLocaleString('pt-BR')}).`);
          const upIdx = values.length>2 ? values[values.length-1] - values[values.length-2] : 0;
          if (upIdx>0) insights.push(`Crescimento de ${upIdx.toLocaleString('pt-BR')} em relaÃ§Ã£o ao mÃªs anterior.`);
          
          // Buscar dados adicionais para insights bÃ¡sicos
          Promise.all([
            fetchJSONWithFilter('/api/aggregate/by-subject').catch(() => []),
            fetchJSONWithFilter('/api/aggregate/count-by?field=UAC').catch(() => []),
            fetchJSONWithFilter('/api/stats/average-time/stats').catch(() => null)
          ]).then(([assuntos, unidades, tempoMedioStats]) => {
            if (assuntos.length > 0) {
              insights.push(`Assunto mais frequente: ${assuntos[0].assunto} (${assuntos[0].quantidade.toLocaleString('pt-BR')}).`);
            }
            if (unidades.length > 0) {
              insights.push(`Unidade de cadastro com maior volume: ${unidades[0].key} (${unidades[0].count.toLocaleString('pt-BR')}).`);
            }
            if (tempoMedioStats && tempoMedioStats.media) {
              insights.push(`Tempo MÃ©dio de Resposta global: ${tempoMedioStats.media.toFixed(1)} dias.`);
            }
            
            const insightsBox = document.getElementById('insightsBox');
            if (insightsBox) {
              insightsBox.innerHTML = insights.length ? insights.map(t=>`<div class="text-slate-400">â€¢ ${t}</div>`).join('') : '<div class="text-slate-500">Sem insights bÃ¡sicos no momento.</div>';
            }
          });
          
          // Exibir insights iniciais enquanto carrega os adicionais
          const insightsBox = document.getElementById('insightsBox');
          if (insightsBox) {
            insightsBox.innerHTML = insights.length ? insights.map(t=>`<div>â€¢ ${t}</div>`).join('') : '<div class="text-slate-500">Carregando insights...</div>';
          }

          // Heatmap dinÃ¢mico jÃ¡ conectado ao seletor (reuso existente)
          const dimSel = document.getElementById('heatmapDim');
          if (dimSel) dimSel.dispatchEvent(new Event('change'));
          
          // Carregar novos grÃ¡ficos avanÃ§ados
          await loadAdvancedCharts();
        } catch (e) {
          console.error('Erro ao carregar VisÃ£o Geral', e);
        }
      }

      // FunÃ§Ã£o para carregar grÃ¡ficos avanÃ§ados (Sankey, TreeMap, Mapa)
      async function loadAdvancedCharts() {
        try {
          // Carregar dados necessÃ¡rios em paralelo
          const [temas, orgaos, status, bairros] = await Promise.all([
            fetchJSONWithFilter('/api/aggregate/by-theme').catch(() => []),
            fetchJSONWithFilter('/api/aggregate/count-by?field=Orgaos').catch(() => []),
            fetchJSONWithFilter('/api/aggregate/count-by?field=status').catch(() => []),
            fetchJSONWithFilter('/api/aggregate/count-by?field=Bairro').catch(() => [])
          ]);
          
          // 1. Sankey Diagram: Tema â†’ Ã“rgÃ£o â†’ Status
          await loadSankeyChart(temas, orgaos, status);
          
          // 2. TreeMap: ProporÃ§Ã£o por Categoria
          await loadTreeMapChart(temas);
          
          // 3. Mapa de Calor GeogrÃ¡fico: Bairros
          await loadGeographicMap(bairros);
        } catch (error) {
          console.error('âŒ Erro ao carregar grÃ¡ficos avanÃ§ados:', error);
        }
      }

      // FunÃ§Ã£o para criar Sankey Diagram
      async function loadSankeyChart(temas, orgaos, status) {
        try {
          if (typeof Plotly === 'undefined') {
            console.warn('Plotly.js nÃ£o carregado');
            return;
          }
          
          // Buscar dados cruzados do backend
          const flowData = await fetchJSONWithFilter('/api/aggregate/sankey-flow').catch(() => null);
          
          if (!flowData || !flowData.nodes || !flowData.links) {
            // Fallback: usar dados agregados
            const topTemas = temas.slice(0, 5);
            const topOrgaos = orgaos.slice(0, 5);
            const topStatus = status.slice(0, 3);
            
            const labels = [
              ...topTemas.map(t => t.tema || 'NÃ£o informado'),
              ...topOrgaos.map(o => o.key || 'NÃ£o informado'),
              ...topStatus.map(s => s.key || 'NÃ£o informado')
            ];
            
            const temaIndices = topTemas.map((_, i) => i);
            const orgaoIndices = topOrgaos.map((_, i) => topTemas.length + i);
            const statusIndices = topStatus.map((_, i) => topTemas.length + topOrgaos.length + i);
            
            const source = [];
            const target = [];
            const value = [];
            
            topTemas.forEach((tema, tIdx) => {
              topOrgaos.forEach((orgao, oIdx) => {
                source.push(temaIndices[tIdx]);
                target.push(orgaoIndices[oIdx]);
                value.push(Math.round((tema.quantidade || 0) * (orgao.count || 0) / 1000));
              });
            });
            
            topOrgaos.forEach((orgao, oIdx) => {
              topStatus.forEach((st, sIdx) => {
                source.push(orgaoIndices[oIdx]);
                target.push(statusIndices[sIdx]);
                value.push(Math.round((orgao.count || 0) * (st.count || 0) / 1000));
              });
            });
            
            const data = [{
              type: 'sankey',
              node: {
                pad: 15,
                thickness: 20,
                line: { color: '#0f172a', width: 0.5 },
                label: labels,
                color: [
                  ...topTemas.map(() => '#22d3ee'),
                  ...topOrgaos.map(() => '#a78bfa'),
                  ...topStatus.map(() => '#34d399')
                ]
              },
              link: {
                source: source,
                target: target,
                value: value,
                color: ['rgba(34,211,238,0.4)']
              }
            }];
            
            const layout = {
              title: '',
              font: { color: '#94a3b8', size: 12 },
              paper_bgcolor: 'transparent',
              plot_bgcolor: 'transparent'
            };
            
            Plotly.newPlot('sankeyChart', data, layout, { responsive: true, displayModeBar: false });
            return;
          }
          
          // Usar dados reais do backend
          const allNodes = [
            ...flowData.nodes.temas,
            ...flowData.nodes.orgaos,
            ...flowData.nodes.statuses
          ];
          
          const nodeMap = new Map();
          allNodes.forEach((node, idx) => {
            nodeMap.set(node, idx);
          });
          
          const source = [];
          const target = [];
          const value = [];
          
          flowData.links.forEach(link => {
            const srcIdx = nodeMap.get(link.source);
            const tgtIdx = nodeMap.get(link.target);
            if (srcIdx !== undefined && tgtIdx !== undefined) {
              source.push(srcIdx);
              target.push(tgtIdx);
              value.push(link.value);
            }
          });
          
          const nodeColors = [
            ...flowData.nodes.temas.map(() => '#22d3ee'),
            ...flowData.nodes.orgaos.map(() => '#a78bfa'),
            ...flowData.nodes.statuses.map(() => '#34d399')
          ];
          
          const data = [{
            type: 'sankey',
            node: {
              pad: 15,
              thickness: 20,
              line: { color: '#0f172a', width: 0.5 },
              label: allNodes,
              color: nodeColors
            },
            link: {
              source: source,
              target: target,
              value: value,
              color: ['rgba(34,211,238,0.4)']
            }
          }];
          
          const layout = {
            title: '',
            font: { color: '#94a3b8', size: 12 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
          };
          
          Plotly.newPlot('sankeyChart', data, layout, { responsive: true, displayModeBar: false });
        } catch (error) {
          console.error('âŒ Erro ao criar Sankey:', error);
          document.getElementById('sankeyChart').innerHTML = '<div class="p-4 text-center text-slate-400">Erro ao carregar grÃ¡fico Sankey</div>';
        }
      }

      // FunÃ§Ã£o para criar TreeMap
      async function loadTreeMapChart(temas) {
        try {
          if (typeof Plotly === 'undefined') {
            console.warn('Plotly.js nÃ£o carregado');
            return;
          }
          
          // Preparar dados para TreeMap (top 20 temas)
          const topTemas = temas.slice(0, 20);
          
          const data = [{
            type: 'treemap',
            labels: topTemas.map(t => t.tema || 'NÃ£o informado'),
            values: topTemas.map(t => t.quantidade || 0),
            parents: topTemas.map(() => ''),
            textinfo: 'label+value',
            textfont: { color: '#ffffff', size: 12 },
            marker: {
              colors: topTemas.map((_, i) => {
                const colors = ['#22d3ee', '#a78bfa', '#34d399', '#f59e0b', '#fb7185', '#e879f9', '#8b5cf6', '#06b6d4'];
                return colors[i % colors.length];
              }),
              line: { color: '#0f172a', width: 2 }
            }
          }];
          
          const layout = {
            title: '',
            font: { color: '#94a3b8' },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { l: 0, r: 0, t: 0, b: 0 }
          };
          
          Plotly.newPlot('treemapChart', data, layout, { responsive: true, displayModeBar: false });
        } catch (error) {
          console.error('âŒ Erro ao criar TreeMap:', error);
          document.getElementById('treemapChart').innerHTML = '<div class="p-4 text-center text-slate-400">Erro ao carregar TreeMap</div>';
        }
      }

      // FunÃ§Ã£o para criar Mapa de Calor GeogrÃ¡fico
      async function loadGeographicMap(bairros) {
        try {
          // Usar fallback direto (lista visual) jÃ¡ que Mapbox requer token vÃ¡lido
          const topBairros = (bairros || []).slice(0, 15);
          
          if (topBairros.length === 0) {
            document.getElementById('mapChart').innerHTML = '<div class="p-4 text-center text-slate-400">Nenhum dado de bairro disponÃ­vel</div>';
            return;
          }
          
          const maxCount = Math.max(...topBairros.map(b => b.count || 0), 1);
          
          // Criar visualizaÃ§Ã£o de mapa de calor usando grÃ¡fico de barras horizontais
          const labels = topBairros.map(b => b.key || 'NÃ£o informado');
          const values = topBairros.map(b => b.count || 0);
          
          // Usar Chart.js para criar um grÃ¡fico de barras horizontais estilizado como mapa
          const ctx = document.createElement('canvas');
          ctx.id = 'mapChartCanvas';
          const container = document.getElementById('mapChart');
          container.innerHTML = '';
          container.appendChild(ctx);
          
          if (window.chartMap instanceof Chart) window.chartMap.destroy();
          
          window.chartMap = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'ManifestaÃ§Ãµes',
                data: values,
                backgroundColor: values.map(v => {
                  const intensity = v / maxCount;
                  if (intensity > 0.7) return 'rgba(239,68,68,0.8)'; // Vermelho - alto
                  if (intensity > 0.4) return 'rgba(167,139,250,0.8)'; // Violeta - mÃ©dio
                  return 'rgba(34,211,238,0.8)'; // Cyan - baixo
                }),
                borderColor: values.map(v => {
                  const intensity = v / maxCount;
                  if (intensity > 0.7) return 'rgba(239,68,68,1)';
                  if (intensity > 0.4) return 'rgba(167,139,250,1)';
                  return 'rgba(34,211,238,1)';
                }),
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'y',
              plugins: {
                legend: { display: false },
                tooltip: createEnhancedTooltip(),
                datalabels: {
                  ...createDataLabelsConfig(),
                  anchor: 'start',
                  align: 'end'
                }
              },
              scales: {
                x: { 
                  beginAtZero: true, 
                  ticks: { color: '#94a3b8' }, 
                  grid: { color: 'rgba(255,255,255,0.05)' } 
                },
                y: { 
                  ticks: { color: '#94a3b8', font: { size: 10 } }, 
                  grid: { color: 'rgba(255,255,255,0.05)' } 
                }
              }
            }
          });
        } catch (error) {
          console.error('âŒ Erro ao criar mapa geogrÃ¡fico:', error);
          // Fallback: mostrar lista simples
          const topBairros = (bairros || []).slice(0, 10);
          const maxCount = Math.max(...topBairros.map(b => b.count || 0), 1);
          document.getElementById('mapChart').innerHTML = `
            <div class="p-4">
              <div class="text-slate-400 text-sm mb-4">Top Bairros por Volume</div>
              <div class="space-y-2">
                ${topBairros.map((b, idx) => `
                  <div class="flex items-center gap-3">
                    <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
                    <div class="flex-1">
                      <div class="text-sm text-slate-300">${b.key || 'NÃ£o informado'}</div>
                      <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500" style="width: ${((b.count || 0) / maxCount) * 100}%"></div>
                      </div>
                    </div>
                    <div class="text-sm font-bold text-emerald-300">${(b.count || 0).toLocaleString('pt-BR')}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      }

      function buildHeatmap(containerId, labels, rows) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Verificar se hÃ¡ dados vÃ¡lidos
        if (!rows || rows.length === 0 || !labels || labels.length === 0) {
          container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">Nenhum dado disponÃ­vel para o heatmap</div>';
          return;
        }
        
        try {
          const validRows = rows.filter(r => r && r.values && Array.isArray(r.values));
          if (validRows.length === 0) {
            container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">Nenhum dado vÃ¡lido para o heatmap</div>';
            return;
          }
          
          const max = Math.max(1, ...validRows.flatMap(r => r.values || []));
        const toBg = (v) => {
            const numValue = Number(v) || 0;
            const alpha = numValue === 0 ? 0.05 : Math.min(0.9, 0.15 + 0.75 * (numValue / max));
          return `rgba(34,211,238,${alpha})`;
        };
          
        let html = '<div class="min-w-max"><table class="text-xs w-full">';
          html += '<thead><tr><th class="px-2 py-1 text-left text-slate-400">Chave</th>' + labels.map(l=>`<th class="px-2 py-1 text-slate-400">${l || ''}</th>`).join('') + '</tr></thead>';
          html += '<tbody>' + validRows.map(r=>{
            const cells = (r.values || []).map(v=>`<td class="px-2 py-1" style="background:${toBg(v)}">${v || 0}</td>`).join('');
            return `<tr><td class="px-2 py-1 text-slate-300">${r.key || 'NÃ£o informado'}</td>${cells}</tr>`;
        }).join('') + '</tbody></table></div>';
        container.innerHTML = html;
        } catch (error) {
          console.error('Erro ao construir heatmap:', error);
          container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">Erro ao carregar heatmap</div>';
        }
      }

      async function loadKpis(defaultCountField, defaultDateField) {
        const [sum, dailyData] = await Promise.all([
          fetchJSONWithFilters('/api/summary'),
          fetchJSONWithFilters('/api/aggregate/by-day').catch(() => [])
        ]);
        
        document.getElementById('kpiTotal').textContent = (sum.total ?? 0).toLocaleString('pt-BR');
        document.getElementById('kpi7').textContent = (sum.last7 ?? 0).toLocaleString('pt-BR');
        document.getElementById('kpi30').textContent = (sum.last30 ?? 0).toLocaleString('pt-BR');
        
        // Calcular deltas e sparklines para Ãºltimos 7 e 30 dias
        if (dailyData && dailyData.length > 0) {
          // Ãšltimos 7 dias: comparar Ãºltimos 7 dias com os 7 dias anteriores
          const last7Days = dailyData.slice(-7);
          const prev7Days = dailyData.slice(-14, -7);
          const last7Sum = last7Days.reduce((s, d) => s + (d.count || 0), 0);
          const prev7Sum = prev7Days.reduce((s, d) => s + (d.count || 0), 0);
          const delta7 = prev7Sum > 0 ? (((last7Sum - prev7Sum) / prev7Sum) * 100).toFixed(1) : 0;
          const delta7El = document.getElementById('kpi7Delta');
          if (delta7El) delta7El.textContent = `${delta7 >= 0 ? '+' : ''}${delta7}% vs perÃ­odo anterior`;
          
          // Ãšltimos 30 dias: comparar Ãºltimos 30 dias com os 30 dias anteriores
          const last30Days = dailyData.slice(-30);
          const prev30Days = dailyData.length >= 60 ? dailyData.slice(-60, -30) : [];
          const last30Sum = last30Days.reduce((s, d) => s + (d.count || 0), 0);
          const prev30Sum = prev30Days.length > 0 ? prev30Days.reduce((s, d) => s + (d.count || 0), 0) : 0;
          const delta30 = prev30Sum > 0 ? (((last30Sum - prev30Sum) / prev30Sum) * 100).toFixed(1) : 0;
          const delta30El = document.getElementById('kpi30Delta');
          if (delta30El) delta30El.textContent = `${delta30 >= 0 ? '+' : ''}${delta30}% vs perÃ­odo anterior`;
          
          // Desenhar sparklines
          const drawSpark = (canvasId, data, color) => {
            const c = document.getElementById(canvasId);
            if (!c) return;
            const ctx = c.getContext('2d');
            ctx.clearRect(0, 0, c.width, c.height);
            const w = c.width || c.offsetWidth; 
            const h = c.height || 32;
            const max = Math.max(...data.map(d => d.count || 0), 1);
            const step = w / (data.length - 1 || 1);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            data.forEach((d, i) => {
              const x = i * step;
              const y = h - ((d.count || 0) / max) * h;
              if (i === 0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
            });
            ctx.stroke();
          };
          
          drawSpark('spark7', last7Days, '#a78bfa');
          drawSpark('spark30', last30Days, '#34d399');
        }
        if (sum.statusCounts && sum.statusCounts.length) {
          // Cores para o grÃ¡fico (expandido para mais status)
          const colors = [
            '#22d3ee', '#a78bfa', '#34d399', '#f59e0b', '#fb7185', '#f472b6',
            '#8b5cf6', '#06b6d4', '#10b981', '#f97316', '#ec4899', '#6366f1',
            '#14b8a6', '#eab308', '#ef4444', '#84cc16', '#3b82f6', '#a855f7'
          ];
          
          // Inicializar visibilidade dos status (todos visÃ­veis por padrÃ£o)
          if (!window.statusVisibility) {
          window.statusVisibility = {};
            sum.statusCounts.forEach(status => {
              window.statusVisibility[status.status] = true;
          });
          }
          
          // FunÃ§Ã£o para atualizar o grÃ¡fico baseado na visibilidade
          const updateStatusChart = () => {
            const visibleStatuses = sum.statusCounts.filter(s => window.statusVisibility[s.status]);
            const visibleLabels = visibleStatuses.map(s => s.status);
            const visibleData = visibleStatuses.map(s => s.count);
            const visibleColors = visibleStatuses.map((s, idx) => {
              const originalIdx = sum.statusCounts.findIndex(orig => orig.status === s.status);
              return colors[originalIdx % colors.length];
            });
            
            if (window.chartStatus instanceof Chart) {
              window.chartStatus.data.labels = visibleLabels;
              window.chartStatus.data.datasets[0].data = visibleData;
              window.chartStatus.data.datasets[0].backgroundColor = visibleColors;
              window.chartStatus.update('active');
            }
          };
          
          // Monta grÃ¡fico de status inicialmente com todos os status
          const chartStatusEl = document.getElementById('chartStatus');
          if (!chartStatusEl) return;
          const ctx = chartStatusEl.getContext('2d');
          if (window.chartStatus instanceof Chart) window.chartStatus.destroy();
          window.chartStatus = new Chart(ctx, { 
            type: 'doughnut', 
            data: {
              labels: sum.statusCounts.map(s=>s.status),
              datasets: [{ 
                data: sum.statusCounts.map(s=>s.count), 
                backgroundColor: sum.statusCounts.map((s, idx) => colors[idx % colors.length])
              }]
            }, 
            options: { 
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false // Desabilitar legenda padrÃ£o do Chart.js
                },
                tooltip: createEnhancedTooltip(),
                datalabels: createDataLabelsConfig(true, 'doughnut')
              },
              onClick: (evt, elements) => {
                if (elements.length > 0) {
                  const idx = elements[0].index;
                  const label = window.chartStatus.data.labels[idx];
                  const value = window.chartStatus.data.datasets[0].data[idx];
                  showClickFeedback(null, label, value);
                }
              }
            } 
          });
          addChartClickHandler(window.chartStatus, (label, value) => showClickFeedback(null, label, value), 'chartStatus');
          
          // Criar legenda customizada organizada com checkboxes
          const legendContainer = document.getElementById('statusLegend');
          if (legendContainer) {
            const total = sum.statusCounts.reduce((acc, s) => acc + s.count, 0);
            
            const renderLegend = () => {
              legendContainer.innerHTML = sum.statusCounts.map((status, idx) => {
                const percent = ((status.count / total) * 100).toFixed(1);
                const color = colors[idx % colors.length];
                const isVisible = window.statusVisibility[status.status];
                
                // Determinar se Ã© encerrada ou ativa (baseado em palavras-chave comuns)
                const statusLower = status.status.toLowerCase();
                const isEncerrada = statusLower.includes('concluÃ­da') || statusLower.includes('encerrada') || 
                                   statusLower.includes('finalizada') || statusLower.includes('resolvida');
                const isAtiva = statusLower.includes('em atendimento') || statusLower.includes('ativa') || 
                               statusLower.includes('pendente') || statusLower.includes('em andamento');
                
                return `
                  <div 
                    class="status-legend-item flex items-center gap-2 p-2 rounded hover:bg-white/5 transition-all cursor-pointer border ${isVisible ? 'border-transparent opacity-100' : 'border-white/20 opacity-40'}"
                    data-status="${status.status.replace(/"/g, '&quot;')}"
                  >
                    <div 
                      class="w-4 h-4 rounded flex-shrink-0 border-2 transition-all relative ${isVisible ? 'border-white/30' : 'border-white/50'}" 
                      style="background-color: ${isVisible ? color : 'transparent'}; ${!isVisible ? `border-color: ${color}; border-style: dashed;` : ''}"
                    >
                      ${isVisible ? '' : '<div class="w-full h-0.5 bg-white/50 absolute top-1/2 left-0 transform rotate-45"></div>'}
                    </div>
                    <div class="flex-1 min-w-0 ${!isVisible ? 'line-through' : ''}">
                      <div class="text-slate-300 truncate" title="${status.status}">${status.status}</div>
                      <div class="text-slate-500 text-[10px]">${status.count.toLocaleString('pt-BR')} (${percent}%)</div>
                    </div>
                  </div>
                `;
              }).join('');
              
              // Adicionar event listeners apÃ³s renderizar
              legendContainer.querySelectorAll('.status-legend-item').forEach((item) => {
                item.addEventListener('click', () => {
                  const statusName = item.getAttribute('data-status');
                  window.statusVisibility[statusName] = !window.statusVisibility[statusName];
                  updateStatusChart();
                  renderLegend();
                });
              });
            };
            
            renderLegend();
            
            // Event listeners para os botÃµes
            const btnMarcarTodos = document.getElementById('btnMarcarTodosStatus');
            const btnDesmarcarTodos = document.getElementById('btnDesmarcarTodosStatus');
            
            if (btnMarcarTodos) {
              btnMarcarTodos.addEventListener('click', () => {
                sum.statusCounts.forEach(status => {
                  window.statusVisibility[status.status] = true;
                });
                updateStatusChart();
                renderLegend();
              });
            }
            
            if (btnDesmarcarTodos) {
              btnDesmarcarTodos.addEventListener('click', () => {
                sum.statusCounts.forEach(status => {
                  window.statusVisibility[status.status] = false;
                });
                updateStatusChart();
                renderLegend();
              });
            }
          }
          
          // Remover skeleton apÃ³s carregar
          document.getElementById('chartStatus').classList.remove('skeleton');
        }
        // SÃ©rie temporal mensal 12M
          const byMonth = await fetchJSONWithFilter('/api/aggregate/by-month');
        const monthCanvas = document.getElementById('chartMonth');
        if (monthCanvas) {
        const ctxM = monthCanvas.getContext('2d');
        if (window.chartMonth instanceof Chart) window.chartMonth.destroy();
        
        // Formatar labels do mÃªs corretamente
        const monthLabels = byMonth.map(x => {
          const ym = x.ym || x.month || '';
          if (!ym || typeof ym !== 'string') return '';
          const parts = ym.split('-');
          if (parts.length < 2) return ym;
          const [year, month] = parts;
          const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          return month ? (monthNames[parseInt(month) - 1] + '/' + year.slice(2)) : ym;
        });
        
        window.chartMonth = new Chart(ctxM, { 
          type:'bar', 
          data:{ 
            labels: monthLabels.filter(l => l), 
            datasets:[{ 
              data: byMonth.filter(x => x.ym).map(x=>x.count), 
              backgroundColor: 'rgba(167,139,250,0.6)',
              borderColor: 'rgba(167,139,250,1)',
              borderWidth: 1
            }] 
          }, 
          options:{ 
            responsive:true,
            plugins: {
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartMonth, (label, value) => showClickFeedback(null, label, value), 'chartMonth');
        // Remover skeleton apÃ³s carregar
        monthCanvas.classList.remove('skeleton');
        }

        // SLA chart
        const sla = await fetchJSON('/api/sla/summary');
        const chartSlaEl = document.getElementById('chartSla');
        if (!chartSlaEl) return;
        const ctxS = chartSlaEl.getContext('2d');
        if (window.chartSla instanceof Chart) window.chartSla.destroy();
        window.chartSla = new Chart(ctxS, {
          type: 'bar',
          data: {
            labels: ['ConcluÃ­dos', 'Verde Claro (0-30d)', 'Amarelo (31-60d)', 'Vermelho (61+d)'],
            datasets: [{
              data: [sla.concluidos||0, sla.verdeClaro||0, sla.amarelo||0, sla.vermelho||0],
              backgroundColor: ['#059669','#86efac','#fbbf24','#fb7185'],
              borderColor: ['#059669','#86efac','#fbbf24','#fb7185'],
              borderWidth: 1
            }]
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        addChartClickHandler(window.chartSla, (label, value) => showClickFeedback(null, label, value));
        // Remover skeleton apÃ³s carregar
        document.getElementById('chartSla').classList.remove('skeleton');
      }

      let currentTableData = [];
      let currentTableHeaders = [];

      async function loadTable(limit = 50) {
        try {
          const pageSize = limit === 'all' ? 10000 : parseInt(limit) || 50;
          const data = await fetchJSON(`/api/records?page=1&pageSize=${pageSize}`);
        const rows = data.rows || [];
          currentTableData = rows;
          
        const tbody = document.getElementById('tbody');
        const thead = document.getElementById('thead');
        const tableInfo = document.getElementById('tableInfo');
        
        if (!tbody || !thead) {
          console.warn('Elementos da tabela nÃ£o encontrados (pode nÃ£o estar na pÃ¡gina atual)');
          return;
        }
        
        tbody.innerHTML = '';
        thead.innerHTML = '';
          
        if (rows.length === 0) {
          if (tableInfo) tableInfo.textContent = 'Nenhum registro encontrado';
            return;
          }
          
        const first = rows[0].data || {};
        const keys = Object.keys(first);
          currentTableHeaders = keys;
          
          // Ordenar colunas por importÃ¢ncia
          const priorityOrder = ['protocolo', 'data_da_criacao', 'status_demanda', 'tipo_de_manifestacao', 
            'tema', 'assunto', 'orgaos', 'unidade_cadastro', 'responsavel', 'canal', 'prioridade', 'status'];
          const sortedKeys = [...priorityOrder.filter(k => keys.includes(k)), ...keys.filter(k => !priorityOrder.includes(k))];
          
          for (const k of sortedKeys) {
            const th = document.createElement('th'); 
            th.textContent = k; 
            th.className = 'px-3 py-2 text-left font-semibold text-slate-300 sticky top-0 bg-slate-900/95'; 
            thead.appendChild(th);
          }
          
        for (const r of rows) {
            const tr = document.createElement('tr'); 
            tr.className = 'hover:bg-white/5 transition-colors duration-100';
            for (const k of sortedKeys) {
              const td = document.createElement('td'); 
              const value = r.data?.[k] ?? '';
              td.textContent = value; 
              td.className = 'px-3 py-2 text-slate-300'; 
              tr.appendChild(td);
          }
          tbody.appendChild(tr);
          }
          
          tableInfo.textContent = `Mostrando ${rows.length} de ${data.total || rows.length} registros`;
        } catch (error) {
          console.error('Erro ao carregar tabela:', error);
          document.getElementById('tableInfo').textContent = 'Erro ao carregar dados';
        }
      }

      // FunÃ§Ã£o melhorada de exportaÃ§Ã£o CSV
      async function exportCSV() {
        const limit = document.getElementById('exportLimit')?.value || '50';
        const pageSize = limit === 'all' ? 10000 : parseInt(limit) || 50;
        
        try {
          const data = await fetchJSON(`/api/records?page=1&pageSize=${pageSize}`);
          const rows = data.rows || [];
          
          if (rows.length === 0) {
            alert('Nenhum dado para exportar');
            return;
          }
          
          const first = rows[0].data || {};
          const keys = Object.keys(first);
          const priorityOrder = ['protocolo', 'data_da_criacao', 'status_demanda', 'tipo_de_manifestacao', 
            'tema', 'assunto', 'orgaos', 'unidade_cadastro', 'responsavel', 'canal', 'prioridade', 'status'];
          const sortedKeys = [...priorityOrder.filter(k => keys.includes(k)), ...keys.filter(k => !priorityOrder.includes(k))];
          
          const headers = sortedKeys;
          const csvRows = rows.map(r => sortedKeys.map(k => r.data?.[k] ?? ''));
          const all = [headers, ...csvRows];
          
          const csv = all.map(r => r.map(v => {
            const str = String(v || '').replaceAll('"', '""');
            return `"${str}"`;
          }).join(',')).join('\n');
          
          // Adicionar BOM para Excel reconhecer UTF-8
          const BOM = '\uFEFF';
          const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); 
          a.href = url; 
          a.download = `ouvidoria_export_${new Date().toISOString().split('T')[0]}.csv`; 
          a.click(); 
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Erro ao exportar CSV:', error);
          alert('Erro ao exportar CSV: ' + error.message);
        }
      }

      // FunÃ§Ã£o de exportaÃ§Ã£o Excel (XLSX)
      async function exportExcel() {
        const limit = document.getElementById('exportLimit')?.value || '50';
        const pageSize = limit === 'all' ? 10000 : parseInt(limit) || 50;
        
        try {
          // Carregar biblioteca XLSX via CDN se nÃ£o estiver disponÃ­vel
          if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = () => exportExcel();
            document.head.appendChild(script);
            return;
          }
          
          const data = await fetchJSON(`/api/records?page=1&pageSize=${pageSize}`);
          const rows = data.rows || [];
          
          if (rows.length === 0) {
            alert('Nenhum dado para exportar');
            return;
          }
          
          const first = rows[0].data || {};
          const keys = Object.keys(first);
          const priorityOrder = ['protocolo', 'data_da_criacao', 'status_demanda', 'tipo_de_manifestacao', 
            'tema', 'assunto', 'orgaos', 'unidade_cadastro', 'responsavel', 'canal', 'prioridade', 'status'];
          const sortedKeys = [...priorityOrder.filter(k => keys.includes(k)), ...keys.filter(k => !priorityOrder.includes(k))];
          
          // Preparar dados para Excel
          const excelData = rows.map(r => {
            const row = {};
            sortedKeys.forEach(k => {
              row[k] = r.data?.[k] ?? '';
            });
            return row;
          });
          
          // Criar workbook
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(excelData);
          
          // Ajustar largura das colunas
          const colWidths = sortedKeys.map(k => ({
            wch: Math.max(k.length, 15)
          }));
          ws['!cols'] = colWidths;
          
          // Adicionar worksheet ao workbook
          XLSX.utils.book_append_sheet(wb, ws, 'Registros');
          
          // Gerar arquivo
          XLSX.writeFile(wb, `ouvidoria_export_${new Date().toISOString().split('T')[0]}.xlsx`);
        } catch (error) {
          console.error('Erro ao exportar Excel:', error);
          alert('Erro ao exportar Excel: ' + error.message);
        }
      }

      // FunÃ§Ã£o para exportar dados dos grÃ¡ficos
      async function exportChartData() {
        try {
          if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = () => exportChartData();
            document.head.appendChild(script);
            return;
          }
          
          const wb = XLSX.utils.book_new();
          const date = new Date().toISOString().split('T')[0];
          
          // Dados do grÃ¡fico de contagem
          const countField = document.getElementById('countBy')?.value || 'Categoria';
          const countData = await fetchJSON(`/api/aggregate/count-by?field=${encodeURIComponent(countField)}`);
          const countSheet = XLSX.utils.aoa_to_sheet([
            [`Contagem por ${countField}`],
            ['Item', 'Quantidade'],
            ...countData.map(d => [d.key, d.count])
          ]);
          XLSX.utils.book_append_sheet(wb, countSheet, `Contagem_${countField}`);
          
          // Dados da sÃ©rie temporal
          const timeField = document.getElementById('dateField')?.value || 'Data';
          const timeData = await fetchJSON(`/api/aggregate/time-series?field=${encodeURIComponent(timeField)}`);
          const timeSheet = XLSX.utils.aoa_to_sheet([
            [`SÃ©rie Temporal - ${timeField}`],
            ['Data', 'Quantidade'],
            ...timeData.map(d => [d.date, d.count])
          ]);
          XLSX.utils.book_append_sheet(wb, timeSheet, `Serie_Temporal`);
          
          // Dados mensais
          const monthData = await fetchJSON('/api/aggregate/by-month');
          const monthSheet = XLSX.utils.aoa_to_sheet([
            ['Registros por MÃªs'],
            ['MÃªs', 'Quantidade'],
            ...monthData.map(d => [d.ym, d.count])
          ]);
          XLSX.utils.book_append_sheet(wb, monthSheet, 'Mensal');
          
          // Heatmap
          const heatmapDim = document.getElementById('heatmapDim')?.value || 'Categoria';
          const heatmapData = await fetchJSON(`/api/aggregate/heatmap?dim=${encodeURIComponent(heatmapDim)}`);
          const heatmapRows = [
            [heatmapDim, ...heatmapData.labels],
            ...heatmapData.rows.map(r => [r.key, ...r.values])
          ];
          const heatmapSheet = XLSX.utils.aoa_to_sheet(heatmapRows);
          XLSX.utils.book_append_sheet(wb, heatmapSheet, `Heatmap_${heatmapDim}`);
          
          XLSX.writeFile(wb, `ouvidoria_graficos_${date}.xlsx`);
        } catch (error) {
          console.error('Erro ao exportar dados dos grÃ¡ficos:', error);
          alert('Erro ao exportar dados dos grÃ¡ficos: ' + error.message);
        }
      }

      // FunÃ§Ã£o para exportar resumo executivo
      async function exportSummary() {
        try {
          if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = () => exportSummary();
            document.head.appendChild(script);
            return;
          }
          
          const summary = await fetchJSONWithFilter('/api/summary');
          const sla = await fetchJSONWithFilter('/api/sla/summary');
          const statusOverview = await fetchJSONWithFilter('/api/stats/status-overview');
          
          const wb = XLSX.utils.book_new();
          const date = new Date().toISOString().split('T')[0];
          
          // Resumo Executivo
          const summarySheet = XLSX.utils.aoa_to_sheet([
            ['RESUMO EXECUTIVO - OUVIDORIA DUQUE DE CAXIAS'],
            ['Data de ExportaÃ§Ã£o', date],
            [''],
            ['INDICADORES GERAIS'],
            ['Total de Registros', summary.total],
            ['Ãšltimos 7 dias', summary.last7],
            ['Ãšltimos 30 dias', summary.last30],
            [''],
            ['STATUS PRINCIPAL'],
            ...summary.statusCounts.slice(0, 10).map(s => [s.status, s.count]),
            [''],
            ['SLA - Status dos Pedidos'],
            ['ConcluÃ­dos (Verde Escuro)', sla.concluidos || 0],
            ['Verde Claro (0-30 dias)', sla.verdeClaro || 0],
            ['Amarelo (31-60 dias)', sla.amarelo || 0],
            ['Vermelho (61+ dias - Atraso)', sla.vermelho || 0],
            [''],
            ['STATUS GERAL'],
            ['Total', statusOverview.total],
            ['ConcluÃ­das', statusOverview.concluida?.quantidade || 0, `${statusOverview.concluida?.percentual || 0}%`],
            ['Em Atendimento', statusOverview.emAtendimento?.quantidade || 0, `${statusOverview.emAtendimento?.percentual || 0}%`]
          ]);
          XLSX.utils.book_append_sheet(wb, summarySheet, 'Resumo_Executivo');
          
          // Top Ã“rgÃ£os
          const topOrgaosSheet = XLSX.utils.aoa_to_sheet([
            ['Top Ã“rgÃ£os'],
            ['Ã“rgÃ£o', 'Quantidade'],
            ...summary.topOrgaos.map(o => [o.key, o.count])
          ]);
          XLSX.utils.book_append_sheet(wb, topOrgaosSheet, 'Top_Orgaos');
          
          // Top Tipos
          const topTiposSheet = XLSX.utils.aoa_to_sheet([
            ['Top Tipos de ManifestaÃ§Ã£o'],
            ['Tipo', 'Quantidade'],
            ...summary.topTipoManifestacao.map(t => [t.key, t.count])
          ]);
          XLSX.utils.book_append_sheet(wb, topTiposSheet, 'Top_Tipos');
          
          // Top Temas
          const topTemasSheet = XLSX.utils.aoa_to_sheet([
            ['Top Temas'],
            ['Tema', 'Quantidade'],
            ...summary.topTema.map(t => [t.key, t.count])
          ]);
          XLSX.utils.book_append_sheet(wb, topTemasSheet, 'Top_Temas');
          
          XLSX.writeFile(wb, `ouvidoria_resumo_executivo_${date}.xlsx`);
        } catch (error) {
          console.error('Erro ao exportar resumo:', error);
          alert('Erro ao exportar resumo executivo: ' + error.message);
        }
      }

      let chartCount, chartTime;

      async function loadCountChart(field) {
        try {
          console.log('Carregando grÃ¡fico de contagem para campo:', field);
          const data = await fetchJSON(`/api/aggregate/count-by?field=${encodeURIComponent(field)}`);
          console.log('Dados recebidos:', data.length, 'itens');
          const labels = data.slice(0, 20).map(x => x.key);
          const values = data.slice(0, 20).map(x => x.count);
          const ctx = document.getElementById('chartCount');
          if (!ctx) {
            console.warn('Canvas chartCount nÃ£o encontrado (pode nÃ£o estar na pÃ¡gina atual)');
            return;
          }
          const ctx2d = ctx.getContext('2d');
          if (chartCount) chartCount.destroy();
        chartCount = new Chart(ctx2d, {
          type: 'bar',
          data: { labels, datasets: [{
            label: `Contagem por ${field}`,
            data: values,
            borderRadius: 8,
            backgroundColor: gradient(ctx2d, 'rgba(34,211,238,0.8)', 'rgba(167,139,250,0.2)'),
            borderColor: 'rgba(34,211,238,1)',
            borderWidth: 1
          }]},
          options: {
            responsive: true,
            animation: false,
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              x: { 
                grid: { color: 'rgba(255,255,255,0.06)' },
                ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }
              },
              y: { 
                grid: { color: 'rgba(255,255,255,0.06)' },
                ticks: { color: '#94a3b8' },
                beginAtZero: true
              }
            }
          }
        });
        addChartClickHandler(chartCount, (label, value) => showClickFeedback(null, label, value));
        document.getElementById('chartCount').classList.remove('skeleton');
        console.log('GrÃ¡fico de contagem criado com sucesso');
        } catch (error) {
          console.error('Erro em loadCountChart:', error);
          throw error;
        }
      }

      async function loadTimeChart(field) {
        try {
          console.log('Carregando grÃ¡fico de sÃ©rie temporal para campo:', field);
          const data = await fetchJSON(`/api/aggregate/time-series?field=${encodeURIComponent(field)}`);
          console.log('Dados recebidos:', data.length, 'itens');
          const labels = data.map(x => x.date);
          const values = data.map(x => x.count);
          const ctx = document.getElementById('chartTime');
          if (!ctx) {
            console.warn('Canvas chartTime nÃ£o encontrado (pode nÃ£o estar na pÃ¡gina atual)');
            return;
          }
          const ctx2d = ctx.getContext('2d');
          if (chartTime) chartTime.destroy();
        chartTime = new Chart(ctx2d, {
          type: 'line',
          data: { labels, datasets: [{
            label: `Registros por dia (${field})`,
            data: values,
            fill: true,
            borderWidth: 2,
            tension: 0.35,
            borderColor: 'rgba(52,211,153,1)',
            backgroundColor: gradient(ctx2d, 'rgba(52,211,153,0.35)', 'rgba(52,211,153,0.05)'),
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: 'rgba(52,211,153,1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]},
          options: {
            responsive: true,
            animation: false,
            plugins: { 
              legend: { labels: { color: '#cbd5e1' } },
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                display: function(context) {
                  // Mostrar apenas em alguns pontos para nÃ£o poluir
                  return context.dataIndex % Math.ceil(context.dataset.data.length / 10) === 0;
                }
              }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 } },
              y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' }, beginAtZero: true }
            }
          }
        });
        addChartClickHandler(chartTime, (label, value) => showClickFeedback(null, label, value));
        document.getElementById('chartTime').classList.remove('skeleton');
        console.log('GrÃ¡fico de sÃ©rie temporal criado com sucesso');
        } catch (error) {
          console.error('Erro em loadTimeChart:', error);
          throw error;
        }
      }


      // Heatmap main interactions
      const heatmapDimSelect = document.getElementById('heatmapDim');
      if (heatmapDimSelect) {
        heatmapDimSelect.addEventListener('change', async (e) => {
          try {
            const dim = e.target.value;
            const hm = await fetchJSON(`/api/aggregate/heatmap?dim=${encodeURIComponent(dim)}`);
            if (hm && hm.labels && hm.rows) {
              buildHeatmap('heatmap', hm.labels, hm.rows);
            } else {
              buildHeatmap('heatmap', [], []);
            }
          } catch (error) {
            console.error('Erro ao carregar heatmap:', error);
            buildHeatmap('heatmap', [], []);
          }
        });
      }
      
      // Menu de exportaÃ§Ã£o (com verificaÃ§Ã£o de existÃªncia dos elementos)
      const btnExport = document.getElementById('btnExport');
      const exportMenu = document.getElementById('exportMenu');
      
      if (btnExport && exportMenu) {
        btnExport.addEventListener('click', (e) => {
          e.stopPropagation();
          exportMenu.classList.toggle('hidden');
        });
        
        document.addEventListener('click', (e) => {
          if (!btnExport.contains(e.target) && !exportMenu.contains(e.target)) {
            exportMenu.classList.add('hidden');
          }
        });
      }
      
      // Eventos dos botÃµes de exportaÃ§Ã£o
      const btnExportCSV = document.getElementById('btnExportCSV');
      if (btnExportCSV) {
        btnExportCSV.addEventListener('click', async () => {
          if (exportMenu) exportMenu.classList.add('hidden');
          await exportCSV();
        });
      }
      
      const btnExportExcel = document.getElementById('btnExportExcel');
      if (btnExportExcel) {
        btnExportExcel.addEventListener('click', async () => {
          if (exportMenu) exportMenu.classList.add('hidden');
          await exportExcel();
        });
      }
      
      const btnExportChartData = document.getElementById('btnExportChartData');
      if (btnExportChartData) {
        btnExportChartData.addEventListener('click', async () => {
          if (exportMenu) exportMenu.classList.add('hidden');
          await exportChartData();
        });
      }
      
      const btnExportSummary = document.getElementById('btnExportSummary');
      if (btnExportSummary) {
        btnExportSummary.addEventListener('click', async () => {
          if (exportMenu) exportMenu.classList.add('hidden');
          await exportSummary();
        });
      }
      
      // Atualizar tabela quando mudar o limite
      const exportLimit = document.getElementById('exportLimit');
      if (exportLimit) {
        exportLimit.addEventListener('change', (e) => {
          loadTable(e.target.value);
        });
      }

      // initial load - otimizado: carregar em paralelo e de forma progressiva
        // Primeiro: KPIs (mais importante, aparece primeiro)
        loadKpis('Categoria', 'Data').then(() => {
          // Depois: carregar grÃ¡ficos e tabela em paralelo (nÃ£o bloqueiam a UI)
          Promise.all([
          loadCountChart('Categoria').catch(e => console.error('Erro ao carregar grÃ¡fico de contagem:', e)),
          loadTimeChart('Data').catch(e => console.error('Erro ao carregar grÃ¡fico temporal:', e)),
          loadTable(50).catch(e => console.error('Erro ao carregar tabela:', e)),
            fetchJSON('/api/aggregate/heatmap?dim=Categoria')
              .then(hm => {
                if (hm && hm.labels && hm.rows) {
                  buildHeatmap('heatmap', hm.labels, hm.rows);
                } else {
                  buildHeatmap('heatmap', [], []);
                }
              })
              .catch(error => {
                console.error('Erro ao carregar heatmap inicial:', error);
                buildHeatmap('heatmap', [], []);
              })
          ]).then(() => {
            console.log('âœ… Todos os dados iniciais carregados');
        });
      }).catch(e => console.error('Erro ao carregar KPIs:', e));

      // Adicionar eventos aos dropdowns - usar onchange diretamente no HTML ou aguardar DOM
      (function setupDropdowns() {
        function attachCountByEvent() {
          const countBySelect = document.getElementById('countBy');
          if (countBySelect && !countBySelect.dataset.listenerAttached) {
            countBySelect.dataset.listenerAttached = 'true';
            countBySelect.addEventListener('change', async (e) => {
              const f = e.target.value.trim() || 'Categoria';
              console.log('ğŸ”„ Dropdown contagem mudou para:', f);
              if (f) {
                try {
                  await loadCountChart(f);
                  console.log('âœ… GrÃ¡fico de contagem atualizado');
                } catch (error) {
                  console.error('âŒ Erro ao atualizar grÃ¡fico de contagem:', error);
                }
              }
            });
            console.log('âœ… Event listener adicionado ao dropdown de contagem');
          }
        }
        
        function attachDateFieldEvent() {
          const dateFieldSelect = document.getElementById('dateField');
          if (dateFieldSelect && !dateFieldSelect.dataset.listenerAttached) {
            dateFieldSelect.dataset.listenerAttached = 'true';
            dateFieldSelect.addEventListener('change', async (e) => {
              const f = e.target.value.trim() || 'Data';
              console.log('ğŸ”„ Dropdown sÃ©rie temporal mudou para:', f);
              if (f) {
                try {
                  await loadTimeChart(f);
                  console.log('âœ… GrÃ¡fico de sÃ©rie temporal atualizado');
                } catch (error) {
                  console.error('âŒ Erro ao atualizar grÃ¡fico de sÃ©rie temporal:', error);
                }
              }
            });
            console.log('âœ… Event listener adicionado ao dropdown de sÃ©rie temporal');
          }
        }
        
        // Tentar adicionar eventos imediatamente
        attachCountByEvent();
        attachDateFieldEvent();
        
        // Se nÃ£o encontrou, tentar novamente apÃ³s um pequeno delay
        if (!document.getElementById('countBy') || !document.getElementById('dateField')) {
          setTimeout(() => {
            attachCountByEvent();
            attachDateFieldEvent();
          }, 200);
        }
      })();
      
      // ========== CORA CHAT - Sistema de Chat ==========
      let chatMessages = [];
      
      // FunÃ§Ã£o para formatar data/hora
      function formatChatTime(date) {
        const now = new Date();
        const msgDate = new Date(date);
        const diffMs = now - msgDate;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'Agora';
        if (diffMins < 60) return `${diffMins}min atrÃ¡s`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h atrÃ¡s`;
        return msgDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
      }
      
      // FunÃ§Ã£o para renderizar mensagens
      function renderMessages(containerId, messages) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        container.innerHTML = messages.map(msg => {
          const isUser = msg.sender === 'user';
          return `
            <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}">
              ${!isUser ? `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-sm font-bold">C</span>
                </div>
              ` : `
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                  <span class="text-white text-xs">VocÃª</span>
                </div>
              `}
              <div class="flex-1 ${isUser ? 'text-right' : ''}">
                <div class="bg-slate-800/60 rounded-lg p-3 text-sm text-slate-200 inline-block ${isUser ? 'bg-cyan-500/20' : ''}">
                  ${!isUser ? `<div class="font-semibold text-purple-300 mb-1">Cora</div>` : ''}
                  <div>${msg.text}</div>
                </div>
                <div class="text-xs text-slate-500 mt-1 ${isUser ? 'text-right' : 'ml-1'}">${formatChatTime(msg.createdAt)}</div>
              </div>
            </div>
          `;
        }).join('');
        
        // Scroll para o final
        container.scrollTop = container.scrollHeight;
      }
      
      // FunÃ§Ã£o para enviar mensagem
      async function sendMessage(text, isWidget = false) {
        console.log('ğŸš€ sendMessage chamada', { text, isWidget });
        if (!text.trim()) {
          console.warn('âš ï¸ Texto vazio, ignorando');
          return;
        }
        
        const message = {
          text: text.trim(),
          sender: 'user',
          createdAt: new Date().toISOString()
        };
        
        console.log('ğŸ’¬ Adicionando mensagem do usuÃ¡rio', message);
        
        // Adicionar mensagem do usuÃ¡rio
        chatMessages.push(message);
        renderMessages(isWidget ? 'chatWidgetMessages' : 'chatMessages', chatMessages);
        
        // Limpar input
        const inputId = isWidget ? 'chatWidgetInput' : 'chatInput';
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
          inputEl.value = '';
        }
        
        try {
          console.log('ğŸ“¡ Enviando para backend...');
          // Salvar no backend
          const response = await fetch('/api/chat/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text.trim() })
          });
          
          if (!response.ok) {
            console.error('âŒ Erro na resposta do backend', response.status);
            throw new Error('Erro ao enviar mensagem');
          }
          
          const data = await response.json();
          console.log('âœ… Resposta recebida do backend', data);
          
          // Adicionar resposta da Cora
          const coraMessage = {
            text: data.response || 'Obrigada pela sua mensagem! Como posso ajudar?',
            sender: 'cora',
            createdAt: new Date().toISOString()
          };
          
          console.log('ğŸ¤– Adicionando resposta da Cora', coraMessage);
          chatMessages.push(coraMessage);
          renderMessages(isWidget ? 'chatWidgetMessages' : 'chatMessages', chatMessages);
          
          // Salvar resposta tambÃ©m
          await fetch('/api/chat/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: coraMessage.text, sender: 'cora' })
          });
        } catch (error) {
          console.error('âŒ Erro ao enviar mensagem:', error);
          const errorMsg = {
            text: 'Desculpe, ocorreu um erro. Tente novamente.',
            sender: 'cora',
            createdAt: new Date().toISOString()
          };
          chatMessages.push(errorMsg);
          renderMessages(isWidget ? 'chatWidgetMessages' : 'chatMessages', chatMessages);
        }
      }
      
      // FunÃ§Ã£o para carregar mensagens do banco
      async function loadChatMessages() {
        try {
          const response = await fetch('/api/chat/messages');
          if (response.ok) {
            const data = await response.json();
            chatMessages = data.messages || [];
            if (chatMessages.length === 0) {
              // Mensagem inicial
              chatMessages.push({
                text: 'OlÃ¡! Sou a Cora, sua assistente virtual. Como posso ajudar vocÃª hoje?',
                sender: 'cora',
                createdAt: new Date().toISOString()
              });
            }
          } else {
            chatMessages = [{
              text: 'OlÃ¡! Sou a Cora, sua assistente virtual. Como posso ajudar vocÃª hoje?',
              sender: 'cora',
              createdAt: new Date().toISOString()
            }];
          }
        } catch (error) {
          console.error('Erro ao carregar mensagens:', error);
          chatMessages = [{
            text: 'OlÃ¡! Sou a Cora, sua assistente virtual. Como posso ajudar vocÃª hoje?',
            sender: 'cora',
            createdAt: new Date().toISOString()
          }];
        }
      }
      
      // FunÃ§Ã£o para carregar pÃ¡gina do chat
      async function loadCoraChat() {
        await loadChatMessages();
        renderMessages('chatMessages', chatMessages);
      }
      
      // Inicializar widget flutuante
      function initChatWidget() {
        const toggle = document.getElementById('chatWidgetToggle');
        const window = document.getElementById('chatWidgetWindow');
        const close = document.getElementById('chatWidgetClose');
        const form = document.getElementById('chatWidgetForm');
        const input = document.getElementById('chatWidgetInput');
        const submitBtn = document.getElementById('chatWidgetSubmitBtn');
        
        if (!form || !input) {
          console.warn('Elementos do widget de chat nÃ£o encontrados');
          return;
        }
        
        console.log('âœ… Widget de chat inicializado', { form: !!form, input: !!input, submitBtn: !!submitBtn });
        
        if (toggle) {
          toggle.addEventListener('click', async () => {
            if (window.classList.contains('hidden')) {
              await loadChatMessages();
              renderMessages('chatWidgetMessages', chatMessages);
            }
            window.classList.toggle('hidden');
          });
        }
        
        if (close) {
          close.addEventListener('click', () => {
            window.classList.add('hidden');
          });
        }
        
        const sendWidgetMessage = (e) => {
          console.log('ğŸ“¤ Tentando enviar mensagem do widget', input.value);
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          const text = input.value.trim();
          if (text) {
            sendMessage(text, true);
            input.value = '';
          }
          return false;
        };
        
        // Adicionar listeners
        form.onsubmit = sendWidgetMessage;
        
        if (submitBtn) {
          submitBtn.onclick = sendWidgetMessage;
        }
        
        input.onkeydown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            console.log('âŒ¨ï¸ Enter pressionado no widget');
            e.preventDefault();
            e.stopPropagation();
            sendWidgetMessage(e);
          }
        };
        
        // Carregar mensagens iniciais
        loadChatMessages();
      }
      
      // Inicializar formulÃ¡rio da pÃ¡gina do chat
      function initChatPage() {
        const form = document.getElementById('chatForm');
        const input = document.getElementById('chatInput');
        const submitBtn = document.getElementById('chatSubmitBtn');
        
        if (!form || !input) {
          console.warn('Elementos da pÃ¡gina de chat nÃ£o encontrados');
          return;
        }
        
        console.log('âœ… PÃ¡gina de chat inicializada', { form: !!form, input: !!input, submitBtn: !!submitBtn });
        
        const sendPageMessage = (e) => {
          console.log('ğŸ“¤ Tentando enviar mensagem da pÃ¡gina', input.value);
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          const text = input.value.trim();
          console.log('ğŸ“ Texto capturado:', text);
          if (text) {
            console.log('âœ… Chamando sendMessage...');
            sendMessage(text, false);
          } else {
            console.warn('âš ï¸ Texto vazio, nÃ£o enviando');
          }
          return false;
        };
        
        // Adicionar listeners
        console.log('ğŸ”— Anexando listeners ao formulÃ¡rio da pÃ¡gina');
        form.onsubmit = sendPageMessage;
        
        if (submitBtn) {
          submitBtn.onclick = (e) => {
            console.log('ğŸ–±ï¸ BotÃ£o Enviar clicado');
            sendPageMessage(e);
          };
        }
        
        input.onkeydown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            console.log('âŒ¨ï¸ Enter pressionado na pÃ¡gina');
            e.preventDefault();
            e.stopPropagation();
            sendPageMessage(e);
          }
        };
      }
      
      // Inicializar quando o DOM estiver pronto e re-inicializar quando a pÃ¡gina do chat for carregada
      function initChat() {
        initChatWidget();
        // SÃ³ inicializar pÃ¡gina se estiver visÃ­vel
        if (document.getElementById('page-cora-chat') && document.getElementById('page-cora-chat').style.display !== 'none') {
          initChatPage();
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChat);
      } else {
        initChat();
      }
      
      // Re-inicializar quando a pÃ¡gina do chat for carregada
      const originalLoadCoraChat = loadCoraChat;
      loadCoraChat = async function() {
        await originalLoadCoraChat();
        // Aguardar um pouco para garantir que o DOM foi atualizado
        setTimeout(() => {
          console.log('ğŸ”„ Re-inicializando pÃ¡gina do chat apÃ³s loadCoraChat');
          initChatPage();
        }, 200);
      };
      
    </script>
    <script>
      // Toggle para listas suspensas de unidades
      function initUnitCategoryToggles() {
        const categoryHeaders = document.querySelectorAll('.unit-category-header');
        categoryHeaders.forEach(header => {
          // Verificar se jÃ¡ tem listener
          if (header.dataset.hasListener === 'true') return;
          header.dataset.hasListener = 'true';
          
          header.addEventListener('click', function(e) {
            e.stopPropagation();
            const category = this.getAttribute('data-category');
            const content = document.querySelector(`[data-category-content="${category}"]`);
            const arrow = this.querySelector('.unit-category-arrow');
            
            const isExpanded = this.classList.contains('expanded');
            
            if (isExpanded) {
              // Fechar
              content.style.display = 'none';
              this.classList.remove('expanded');
              arrow.style.transform = 'rotate(0deg)';
            } else {
              // Abrir
              content.style.display = 'block';
              this.classList.add('expanded');
              arrow.style.transform = 'rotate(90deg)';
            }
          });
        });
      }
      
      // Inicializar quando o DOM estiver pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initUnitCategoryToggles);
      } else {
        initUnitCategoryToggles();
      }
      
      // Event listener para botÃ£o de atualizar insights
      document.addEventListener('DOMContentLoaded', () => {
        const btnRefreshInsights = document.getElementById('btnRefreshInsights');
        if (btnRefreshInsights) {
          btnRefreshInsights.addEventListener('click', async () => {
            btnRefreshInsights.disabled = true;
            btnRefreshInsights.textContent = 'â³ Atualizando...';
            try {
              // ForÃ§ar atualizaÃ§Ã£o limpando cache e recarregando
              await loadAIInsights();
            } catch (error) {
              console.error('âŒ Erro ao atualizar insights:', error);
            } finally {
              btnRefreshInsights.disabled = false;
              btnRefreshInsights.textContent = 'ğŸ”„ Atualizar';
            }
          });
        }
      });
      
      // Inicializar tambÃ©m se o DOM jÃ¡ estiver carregado
      if (document.readyState !== 'loading') {
        const btnRefreshInsights = document.getElementById('btnRefreshInsights');
        if (btnRefreshInsights) {
          btnRefreshInsights.addEventListener('click', async () => {
            btnRefreshInsights.disabled = true;
            btnRefreshInsights.textContent = 'â³ Atualizando...';
            try {
              await loadAIInsights();
            } catch (error) {
              console.error('âŒ Erro ao atualizar insights:', error);
            } finally {
              btnRefreshInsights.disabled = false;
              btnRefreshInsights.textContent = 'ğŸ”„ Atualizar';
            }
          });
        }
      }

      // SPA Page switch
      const sideMenu = document.getElementById('sideMenu');
      const pages = document.getElementById('pages').children;
      sideMenu.querySelectorAll('div[data-page]').forEach(btn => {
        btn.onclick = () => {
          sideMenu.querySelectorAll('div[data-page]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          Array.from(pages).forEach(page => page.style.display = 'none');
          const pageId = 'page-'+btn.getAttribute('data-page');
          const targetPage = document.getElementById(pageId);
          if (targetPage) {
            targetPage.style.display='block';
          }
          // Carrega conteÃºdo especÃ­fico
          const pageName = btn.getAttribute('data-page');
          loadSection(pageName);
          // Atualizar indicador de filtro global se houver
          if (window.updateGlobalFilterIndicator) {
            updateGlobalFilterIndicator();
          }
          // Re-inicializar chat se necessÃ¡rio
          if (pageName === 'cora-chat') {
            setTimeout(() => {
              console.log('ğŸ”„ Re-inicializando pÃ¡gina do chat apÃ³s navegaÃ§Ã£o');
              if (typeof initChatPage === 'function') {
                initChatPage();
              }
            }, 300);
          }
        };
      });
      // FunÃ§Ã£o para carregar a pÃ¡gina Home (nÃ£o precisa carregar dados)
      function loadHome() {
        // A pÃ¡gina home Ã© estÃ¡tica, nÃ£o precisa carregar dados
        console.log('ğŸ  PÃ¡gina Home carregada');
      }
      
      function loadSection(page) {
        if(page==='home') loadHome();
        if(page==='main') loadOverview();
        if(page==='cora-chat') loadCoraChat();
        if(page==='orgao-mes') loadOrgaoMes();
        if(page==='tempo-medio') loadTempoMedio();
        if(page==='tema') loadTema();
        if(page==='assunto') loadAssunto();
        if(page==='cadastrante') loadCadastrante();
        if(page==='reclamacoes') loadReclamacoes();
        if(page==='projecao-2026') loadProjecao2026();
        if(page==='secretaria') loadSecretaria();
        if(page==='secretarias-distritos') loadSecretariasDistritos();
        if(page && page.startsWith('unit-')) {
          const unitName = page.replace('unit-', '').replace(/-/g, ' ');
          loadUnit(unitName);
        }
        if(page==='tipo') loadTipo();
        if(page==='setor') loadSetor();
        if(page==='categoria') loadCategoria();
        if(page==='status') loadStatusPage();
        if(page==='bairro') loadBairro();
        if(page==='uac') loadUAC();
        if(page==='responsavel') loadResponsavel();
        if(page==='canal') loadCanal();
        if(page==='prioridade') loadPrioridade();
      }
      // FunÃ§Ãµes para carregar cada seÃ§Ã£o temÃ¡tica
        enableCharts(); // chamada para garantir que grÃ¡ficos nÃ£o quebrem
      
      // Carregar Home automaticamente ao abrir a pÃ¡gina
      function initPage() {
        // Garantir que todas as outras pÃ¡ginas estÃ£o ocultas
        const allPages = document.getElementById('pages').children;
        Array.from(allPages).forEach(page => {
          if (page.id !== 'page-home') {
            page.style.display = 'none';
          }
        });
        
        // Garantir que a pÃ¡gina home estÃ¡ visÃ­vel
        const homePage = document.getElementById('page-home');
        if (homePage) {
          homePage.style.display = 'block';
        }
        
        // Garantir que o botÃ£o "Home" estÃ¡ ativo
        const homeBtn = sideMenu.querySelector('[data-page="home"]');
        if (homeBtn) {
          sideMenu.querySelectorAll('div[data-page]').forEach(b => b.classList.remove('active'));
          homeBtn.classList.add('active');
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
      } else {
        // DOM jÃ¡ carregado
        initPage();
      }
      
      async function loadOrgaoMes() {
        // Carregar dados de secretarias/Ã³rgÃ£os (com filtro se houver)
        const dataOrgaos = await fetchJSONWithFilter('/api/aggregate/count-by?field=Secretaria');
        const totalOrgaos = dataOrgaos.length;
        document.getElementById('totalOrgaos').textContent = totalOrgaos;
        
        // Criar lista visual de Ã³rgÃ£os (estilo Looker Studio)
        const listaOrgaos = document.getElementById('listaOrgaos');
        const maxValue = Math.max(...dataOrgaos.map(d => d.count), 1);
        listaOrgaos.innerHTML = dataOrgaos.map(item => {
          const width = (item.count / maxValue) * 100;
          return `
            <div class="flex items-center gap-3 py-2 border-b border-white/5">
              <div class="flex-1 min-w-0">
                <div class="text-sm text-slate-300 truncate">${item.key}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-violet-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-cyan-300 min-w-[60px] text-right">${item.count.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        
        // Carregar dados mensais (com filtro se houver)
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month');
        const labels = dataMensal.map(x => {
          const ym = x.ym || x.month || '';
          if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
          const parts = ym.split('-');
          if (parts.length < 2) return ym;
          const [year, month] = parts;
          if (!year || !month) return ym;
          const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
          const monthIndex = parseInt(month) - 1;
          return monthIndex >= 0 && monthIndex < 12 ? `${monthNames[monthIndex]}. de ${year}` : ym;
        });
        const values = dataMensal.map(x => x.count);
        
        // Criar grÃ¡fico de barras mensal
        if (window.chartOrgaoMes instanceof Chart) window.chartOrgaoMes.destroy();
        const ctx = document.getElementById('chartOrgaoMes').getContext('2d');
        window.chartOrgaoMes = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ManifestaÃ§Ãµes',
              data: values,
              backgroundColor: 'rgba(167,139,250,0.7)',
              borderColor: 'rgba(167,139,250,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { color: '#94a3b8' },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              y: {
                ticks: { color: '#94a3b8' },
                grid: { color: 'rgba(255,255,255,0.05)' }
              }
            }
          }
        });
        addChartClickHandler(window.chartOrgaoMes, (label, value) => showClickFeedback(null, label, value), 'chartOrgaoMes');
        
        // Atualizar KPI total
        const total = dataOrgaos.reduce((sum, item) => sum + item.count, 0);
        document.getElementById('totalOrgaoMes').textContent = total.toLocaleString('pt-BR');
        
        // Carregar e exibir tabela Por Ã“rgÃ£o e MÃªs
        const dataOrgaoMes = await fetchJSONWithFilter('/api/aggregate/count-by-orgao-mes').catch(() => []);
        if (dataOrgaoMes && dataOrgaoMes.length > 0) {
          const orgaosUnicos = [...new Set(dataOrgaoMes.map(d => d.orgao))].sort();
          const mesesUnicos = [...new Set(dataOrgaoMes.map(d => d.month))].sort();
          
          let html = '<table class="w-full text-sm border-collapse">';
          html += '<thead><tr class="border-b border-white/10">';
          html += '<th class="px-4 py-3 text-left text-slate-300 font-semibold">Ã“rgÃ£o</th>';
          mesesUnicos.forEach(mes => {
            if (!mes || typeof mes !== 'string') {
              html += `<th class="px-4 py-3 text-center text-slate-300 font-semibold">${mes || 'N/A'}</th>`;
            } else {
              const parts = mes.split('-');
              if (parts.length >= 2) {
                const [year, month] = parts;
                const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                html += `<th class="px-4 py-3 text-center text-slate-300 font-semibold">${monthNames[parseInt(month) - 1]}/${year.slice(-2)}</th>`;
              } else {
                html += `<th class="px-4 py-3 text-center text-slate-300 font-semibold">${mes}</th>`;
              }
            }
          });
          html += '<th class="px-4 py-3 text-center text-slate-300 font-semibold">Total</th>';
          html += '</tr></thead><tbody>';
          
          orgaosUnicos.forEach(orgao => {
            let totalOrgao = 0;
            html += '<tr class="border-b border-white/5 hover:bg-white/5">';
            html += `<td class="px-4 py-2 text-slate-200 font-medium">${orgao || 'NÃ£o informado'}</td>`;
            mesesUnicos.forEach(mes => {
              const item = dataOrgaoMes.find(d => d.orgao === orgao && d.month === mes);
              const count = item ? (item.count || 0) : 0;
              totalOrgao += count;
              html += `<td class="px-4 py-2 text-center text-slate-300">${count.toLocaleString('pt-BR')}</td>`;
            });
            html += `<td class="px-4 py-2 text-center text-cyan-300 font-bold">${totalOrgao.toLocaleString('pt-BR')}</td>`;
            html += '</tr>';
          });
          
          // Linha de totais
          html += '<tr class="border-t-2 border-cyan-500/50 bg-cyan-500/10 font-bold">';
          html += '<td class="px-4 py-3 text-cyan-300">TOTAL</td>';
          mesesUnicos.forEach(mes => {
            const totalMes = dataOrgaoMes.filter(d => d.month === mes).reduce((sum, d) => sum + (d.count || 0), 0);
            html += `<td class="px-4 py-3 text-center text-cyan-300">${totalMes.toLocaleString('pt-BR')}</td>`;
          });
          html += `<td class="px-4 py-3 text-center text-cyan-300">${total.toLocaleString('pt-BR')}</td>`;
          html += '</tr>';
          
          html += '</tbody></table>';
          document.getElementById('tabelaOrgaoMes').innerHTML = html;
        }
      }
      
      async function loadSecretariasDistritos() {
        try {
          // Carregar dados de distritos e secretarias
          const distritosData = await fetchJSON('/api/distritos').catch(() => null);
          
          if (!distritosData || !distritosData.distritos) {
            document.getElementById('listaDistritos').innerHTML = '<div class="text-center text-slate-400 py-4">Erro ao carregar dados de distritos</div>';
            return;
          }
          
          const distritos = distritosData.distritos;
          const estatisticas = distritosData.estatisticas || {};
          
          // Renderizar lista de distritos
          const listaDistritos = document.getElementById('listaDistritos');
          listaDistritos.innerHTML = Object.entries(distritos).map(([nome, info]) => `
            <div class="distrito-item p-4 rounded-lg border border-white/10 hover:border-cyan-400/50 hover:bg-white/5 cursor-pointer transition-all" 
                 data-distrito="${nome}" 
                 data-code="${info.code || ''}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-cyan-300">${nome}</div>
                  <div class="text-xs text-slate-400 mt-1">
                    ${info.bairros ? info.bairros.length + ' bairros' : ''}
                    ${estatisticas.secretariasPorDistrito && estatisticas.secretariasPorDistrito[nome] 
                      ? ' â€¢ ' + estatisticas.secretariasPorDistrito[nome] + ' secretarias' 
                      : ''}
                  </div>
                </div>
                <div class="text-2xl">${info.code || 'ğŸ“'}</div>
              </div>
            </div>
          `).join('');
          
          // Adicionar event listeners para seleÃ§Ã£o de distrito
          document.querySelectorAll('.distrito-item').forEach(item => {
            item.addEventListener('click', async () => {
              // Remover seleÃ§Ã£o anterior
              document.querySelectorAll('.distrito-item').forEach(i => {
                i.classList.remove('border-cyan-400', 'bg-cyan-500/10');
                i.classList.add('border-white/10');
              });
              
              // Marcar como selecionado
              item.classList.remove('border-white/10');
              item.classList.add('border-cyan-400', 'bg-cyan-500/10');
              
              const distritoNome = item.dataset.distrito;
              const distritoCode = item.dataset.code;
              
              // Atualizar nome do distrito selecionado
              document.getElementById('distritoSelecionadoNome').textContent = distritoNome;
              
              // Carregar secretarias do distrito
              await loadSecretariasPorDistrito(distritoNome, distritoCode);
            });
          });
          
          // Renderizar estatÃ­sticas
          const estatisticasDiv = document.getElementById('estatisticasDistritos');
          estatisticasDiv.innerHTML = `
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Total de Secretarias</div>
              <div class="text-2xl font-bold text-cyan-300">${estatisticas.totalSecretarias || 0}</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Total de Distritos</div>
              <div class="text-2xl font-bold text-violet-300">${estatisticas.totalDistritos || 0}</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Total de Bairros</div>
              <div class="text-2xl font-bold text-emerald-300">${estatisticas.totalBairros || 0}</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">MÃ©dia Secretarias/Distrito</div>
              <div class="text-2xl font-bold text-amber-300">${estatisticas.totalSecretarias && estatisticas.totalDistritos 
                ? (estatisticas.totalSecretarias / estatisticas.totalDistritos).toFixed(1) 
                : 0}</div>
            </div>
          `;
          
          // Criar grÃ¡fico de distribuiÃ§Ã£o de secretarias por distrito
          if (estatisticas.secretariasPorDistrito) {
            const distritoLabels = Object.keys(estatisticas.secretariasPorDistrito);
            const distritoValues = Object.values(estatisticas.secretariasPorDistrito);
            
            if (window.chartSecretariasDistritos instanceof Chart) window.chartSecretariasDistritos.destroy();
            const ctx = document.getElementById('chartSecretariasDistritos')?.getContext('2d');
            if (ctx) {
              window.chartSecretariasDistritos = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: distritoLabels.map(d => d.replace('Âº Distrito - ', '').split('(')[0].trim()),
                  datasets: [{
                    label: 'Quantidade de Secretarias',
                    data: distritoValues,
                    backgroundColor: 'rgba(245,158,11,0.7)',
                    borderColor: 'rgba(245,158,11,1)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: { display: false },
                    tooltip: createEnhancedTooltip(),
                    datalabels: createDataLabelsConfig()
                  },
                  scales: {
                    y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                  }
                }
              });
            }
          }
        } catch (error) {
          console.error('âŒ Erro ao carregar secretarias e distritos:', error);
          document.getElementById('listaDistritos').innerHTML = '<div class="text-center text-slate-400 py-4">Erro ao carregar dados</div>';
        }
      }
      
      async function loadSecretariasPorDistrito(distritoNome, distritoCode) {
        try {
          // Buscar secretarias do distrito
          const response = await fetch(`/api/secretarias/${encodeURIComponent(distritoCode || distritoNome)}`);
          const data = await response.json().catch(() => ({ secretarias: [] }));
          
          const secretarias = data.secretarias || [];
          const listaSecretarias = document.getElementById('listaSecretarias');
          
          if (secretarias.length === 0) {
            listaSecretarias.innerHTML = '<div class="text-center text-slate-400 py-8">Nenhuma secretaria encontrada para este distrito</div>';
            return;
          }
          
          listaSecretarias.innerHTML = secretarias.map(sec => `
            <div class="glass rounded-xl p-4 border border-white/10 hover:border-violet-400/50 transition-all">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <h4 class="font-semibold text-violet-300 mb-2">${sec.name || 'Secretaria'}</h4>
                  ${sec.address ? `<div class="text-sm text-slate-400 mb-1">ğŸ“ ${sec.address}</div>` : ''}
                  ${sec.phone ? `<div class="text-sm text-slate-400 mb-1">ğŸ“ ${sec.phone}</div>` : ''}
                  ${sec.email ? `<div class="text-sm text-slate-400 mb-1">âœ‰ï¸ ${sec.email}</div>` : ''}
                  ${sec.workingHours ? `<div class="text-sm text-slate-400 mb-2">ğŸ• ${sec.workingHours}</div>` : ''}
                  ${sec.services && sec.services.length > 0 ? `
                    <div class="mt-3">
                      <div class="text-xs text-slate-500 mb-1">ServiÃ§os oferecidos:</div>
                      <div class="flex flex-wrap gap-1">
                        ${sec.services.map(s => `<span class="px-2 py-1 text-xs rounded bg-slate-800/50 text-slate-300">${s}</span>`).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('âŒ Erro ao carregar secretarias do distrito:', error);
          document.getElementById('listaSecretarias').innerHTML = '<div class="text-center text-slate-400 py-8">Erro ao carregar secretarias</div>';
        }
      }

      async function loadSecretaria() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Secretaria');
        const labels = data.slice(0, 10).map(x=>x.key);
        const values = data.slice(0, 10).map(x=>x.count);
        if (window.chartSecretaria instanceof Chart) window.chartSecretaria.destroy();
        const ctx = document.getElementById('chartSecretaria').getContext('2d');
        window.chartSecretaria = new Chart(ctx, {
          type:'bar', 
          data:{labels,datasets:[{label:'Secretaria',data:values,backgroundColor:'#22d3ee',borderColor:'#22d3ee',borderWidth:1}]},
          options: {
            responsive:true, 
            animation:false, 
            plugins:{
              legend:{display:false},
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        addChartClickHandler(window.chartSecretaria, (label, value) => showClickFeedback(null, label, value), 'chartSecretaria');
        document.getElementById('rankSecretaria').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-cyan-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count}</span></li>`).join('');
        
        // GrÃ¡fico mensal
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month').catch(() => []);
        if (dataMensal && dataMensal.length > 0) {
          const labelsMes = dataMensal.map(x => {
            const [year, month] = (x.ym || x.month || '').split('-');
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : (x.ym || x.month || '');
          });
          const valuesMes = dataMensal.map(x => x.count || 0);
          
          if (window.chartSecretariaMes instanceof Chart) window.chartSecretariaMes.destroy();
          const ctxMes = document.getElementById('chartSecretariaMes')?.getContext('2d');
          if (ctxMes) {
            window.chartSecretariaMes = new Chart(ctxMes, {
              type: 'bar',
              data: {
                labels: labelsMes,
                datasets: [{
                  label: 'ManifestaÃ§Ãµes',
                  data: valuesMes,
                  backgroundColor: 'rgba(34,211,238,0.7)',
                  borderColor: 'rgba(34,211,238,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        }
      }
      async function loadTipo() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Tipo');
        const labels = data.slice(0, 10).map(x=>x.key);
        const values = data.slice(0, 10).map(x=>x.count);
        if(window.chartTipo instanceof Chart) window.chartTipo.destroy();
        const ctx = document.getElementById('chartTipo').getContext('2d');
        window.chartTipo = new Chart(ctx, {
          type:'pie', 
          data:{labels,datasets:[{label:'Tipo ManifestaÃ§Ã£o',data:values,backgroundColor:['#c084fc','#22d3ee','#facc15','#fb7185']}]}, 
          options:{
            responsive:true,
            animation:false,
            plugins: {
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(true, 'pie')
            }
          } 
        });
        addChartClickHandler(window.chartTipo, (label, value) => showClickFeedback(null, label, value), 'chartTipo');
        document.getElementById('rankTipo').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-violet-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count}</span></li>`).join('');
      }
      async function loadSetor() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Setor');
        const labels = data.slice(0, 10).map(x=>x.key);
        const values = data.slice(0, 10).map(x=>x.count);
        if(window.chartSetor instanceof Chart) window.chartSetor.destroy();
        const ctx = document.getElementById('chartSetor').getContext('2d');
        window.chartSetor = new Chart(ctx, {
          type:'bar', 
          data:{labels,datasets:[{label:'Setor',data:values,backgroundColor:'#34d399',borderColor:'#34d399',borderWidth:1}]}, 
          options:{
            responsive:true,
            animation:false, 
            indexAxis:'y', 
            plugins:{
              legend:{display:false},
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        addChartClickHandler(window.chartSetor, (label, value) => showClickFeedback(null, label, value), 'chartSetor');
        document.getElementById('rankSetor').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-emerald-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count}</span></li>`).join('');
      }
      function enableCharts() {
        // dummy para garantir que nÃ£o quebre ao carregar direto
      }

      async function loadCategoria() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Categoria');
        const labels = data.slice(0, 15).map(x=>x.key);
        const values = data.slice(0, 15).map(x=>x.count);
        if (window.chartCategoria instanceof Chart) window.chartCategoria.destroy();
        const ctx = document.getElementById('chartCategoria').getContext('2d');
        window.chartCategoria = new Chart(ctx, { 
          type:'bar', 
          data:{ labels, datasets:[{ label:'Categoria', data: values, backgroundColor:'#f472b6', borderColor:'#f472b6', borderWidth:1 }] }, 
          options:{ 
            responsive:true,
            indexAxis:'y',
            plugins:{ 
              legend:{ display:false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', true)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartCategoria, (label, value) => showClickFeedback(null, label, value), 'chartCategoria');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Categoria').catch(() => ({ labels: [], rows: [] }));
        buildHeatmap('heatmapCategoria', hm.labels || [], hm.rows || []);
        
        // GrÃ¡fico mensal
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month').catch(() => []);
        if (dataMensal && dataMensal.length > 0) {
          const labelsMes = dataMensal.map(x => {
            const [year, month] = (x.ym || x.month || '').split('-');
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : (x.ym || x.month || '');
          });
          const valuesMes = dataMensal.map(x => x.count || 0);
          
          if (window.chartCategoriaMes instanceof Chart) window.chartCategoriaMes.destroy();
          const ctxMes = document.getElementById('chartCategoriaMes')?.getContext('2d');
          if (ctxMes) {
            window.chartCategoriaMes = new Chart(ctxMes, {
              type: 'bar',
              data: {
                labels: labelsMes,
                datasets: [{
                  label: 'ManifestaÃ§Ãµes',
                  data: valuesMes,
                  backgroundColor: 'rgba(244,114,182,0.7)',
                  borderColor: 'rgba(244,114,182,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        }
      }

      async function loadStatusPage() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=status');
        if (!data || data.length === 0) {
          console.warn('âš ï¸ Nenhum dado de status disponÃ­vel');
          const ctx = document.getElementById('chartStatusPage')?.getContext('2d');
          if (ctx && window.chartStatusPage instanceof Chart) {
            window.chartStatusPage.destroy();
            window.chartStatusPage = null;
          }
          return;
        }
        
        const labels = data.map(x => x.key || 'NÃ£o informado');
        const values = data.map(x => x.count || 0);
        
        if (window.chartStatusPage instanceof Chart) window.chartStatusPage.destroy();
        const ctx = document.getElementById('chartStatusPage')?.getContext('2d');
        if (ctx) {
          const colors = ['#38bdf8', '#22d3ee', '#fbbf24', '#34d399', '#fb7185', '#e879f9', '#a78bfa', '#8b5cf6', '#06b6d4', '#10b981'];
        window.chartStatusPage = new Chart(ctx, { 
          type:'doughnut', 
            data:{ 
              labels, 
              datasets:[{ 
                data: values, 
                backgroundColor: labels.map((_, i) => colors[i % colors.length])
              }] 
            }, 
          options:{ 
            responsive:true,
            plugins: {
                legend: { display: true, position: 'right', labels: { color: '#94a3b8', font: { size: 11 } } },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(true, 'doughnut')
            }
          } 
        });
        addChartClickHandler(window.chartStatusPage, (label, value) => showClickFeedback(null, label, value), 'chartStatusPage');
        }
        
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Status').catch(() => ({ labels: [], rows: [] }));
        buildHeatmap('heatmapStatus', hm.labels || [], hm.rows || []);
        
        // GrÃ¡fico Status por MÃªs
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/count-by-status-mes').catch(() => []);
        if (dataMensal && dataMensal.length > 0) {
          const statuses = [...new Set(dataMensal.map(d => d.status))];
          const meses = [...new Set(dataMensal.map(d => d.month))].sort();
          const colors = ['#38bdf8', '#22d3ee', '#fbbf24', '#34d399', '#fb7185', '#e879f9', '#a78bfa', '#8b5cf6', '#06b6d4', '#10b981'];
          
          const datasets = statuses.slice(0, 10).map((status, idx) => ({
            label: status || 'NÃ£o informado',
            data: meses.map(month => {
              const item = dataMensal.find(d => d.month === month && d.status === status);
              return item ? (item.count || 0) : 0;
            }),
            backgroundColor: colors[idx % colors.length] + '80',
            borderColor: colors[idx % colors.length],
            borderWidth: 1
          }));
          
          const labelsMes = meses.map(m => {
            if (!m || typeof m !== 'string') return m || 'Data invÃ¡lida';
            const parts = m.split('-');
            if (parts.length < 2) return m;
            const [year, month] = parts;
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : m;
          });
          
          if (window.chartStatusMes instanceof Chart) window.chartStatusMes.destroy();
          const ctxMes = document.getElementById('chartStatusMes')?.getContext('2d');
          if (ctxMes) {
            window.chartStatusMes = new Chart(ctxMes, {
              type: 'line',
              data: {
                labels: labelsMes,
                datasets: datasets
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: true, position: 'right', labels: { color: '#94a3b8', font: { size: 11 } } },
                  tooltip: createEnhancedTooltip(),
                  datalabels: { display: false }
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        }
        
        // Aba Por Tema
        const dataTema = await fetchJSONWithFilter('/api/aggregate/count-by?field=tema').catch(() => []);
        if (dataTema && dataTema.length > 0) {
          const labelsTema = dataTema.slice(0, 15).map(x => x.key || 'NÃ£o informado');
          const valuesTema = dataTema.slice(0, 15).map(x => x.count || 0);
          
          if (window.chartStatusTema instanceof Chart) window.chartStatusTema.destroy();
          const ctxTema = document.getElementById('chartStatusTema')?.getContext('2d');
          if (ctxTema) {
            window.chartStatusTema = new Chart(ctxTema, {
              type: 'bar',
              data: {
                labels: labelsTema,
                datasets: [{
                  label: 'Quantidade',
                  data: valuesTema,
                  backgroundColor: 'rgba(56,189,248,0.7)',
                  borderColor: 'rgba(56,189,248,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', true)
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
          
          const hmTema = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Categoria').catch(() => ({ labels: [], rows: [] }));
          buildHeatmap('heatmapStatusTema', hmTema.labels || [], hmTema.rows || []);
        }
        
        // Aba Por Ã“rgÃ£o
        const dataOrgao = await fetchJSONWithFilter('/api/aggregate/count-by?field=Orgaos').catch(() => []);
        if (dataOrgao && dataOrgao.length > 0) {
          const labelsOrgao = dataOrgao.slice(0, 15).map(x => x.key || 'NÃ£o informado');
          const valuesOrgao = dataOrgao.slice(0, 15).map(x => x.count || 0);
          
          if (window.chartStatusOrgao instanceof Chart) window.chartStatusOrgao.destroy();
          const ctxOrgao = document.getElementById('chartStatusOrgao')?.getContext('2d');
          if (ctxOrgao) {
            window.chartStatusOrgao = new Chart(ctxOrgao, {
              type: 'bar',
              data: {
                labels: labelsOrgao,
                datasets: [{
                  label: 'Quantidade',
                  data: valuesOrgao,
                  backgroundColor: 'rgba(34,211,238,0.7)',
                  borderColor: 'rgba(34,211,238,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', true)
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
          
          const hmOrgao = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Secretaria').catch(() => ({ labels: [], rows: [] }));
          buildHeatmap('heatmapStatusOrgao', hmOrgao.labels || [], hmOrgao.rows || []);
        }
      }
      
      // Gerenciar abas na pÃ¡gina de Status
      if (!window.statusTabsInitialized) {
        window.statusTabsInitialized = true;
        setTimeout(() => {
          const tabButtons = document.querySelectorAll('.tab-status');
          tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const tab = btn.dataset.tab;
              
              // Atualizar botÃµes
              tabButtons.forEach(b => {
                b.classList.remove('border-cyan-400', 'text-cyan-400');
                b.classList.add('border-transparent', 'text-slate-400');
              });
              btn.classList.remove('border-transparent', 'text-slate-400');
              btn.classList.add('border-cyan-400', 'text-cyan-400');
              
              // Mostrar/ocultar conteÃºdo
              document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
              });
              
              if (tab === 'status') {
                document.getElementById('status-tab-content')?.classList.remove('hidden');
              } else if (tab === 'tema') {
                document.getElementById('tema-tab-content')?.classList.remove('hidden');
              } else if (tab === 'orgao') {
                document.getElementById('orgao-tab-content')?.classList.remove('hidden');
              }
            });
          });
        }, 100);
      }

      async function loadBairro() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Bairro');
        const labels = data.slice(0, 15).map(x=>x.key);
        const values = data.slice(0, 15).map(x=>x.count);
        if (window.chartBairro instanceof Chart) window.chartBairro.destroy();
        const ctx = document.getElementById('chartBairro').getContext('2d');
        window.chartBairro = new Chart(ctx, { 
          type:'bar', 
          data:{ labels, datasets:[{ label:'Bairro', data: values, backgroundColor:'#f59e0b', borderColor:'#f59e0b', borderWidth:1 }] }, 
          options:{ 
            responsive:true, 
            plugins:{ 
              legend:{ display:false },
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            }, 
            indexAxis:'y',
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartBairro, (label, value) => showClickFeedback(null, label, value), 'chartBairro');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Bairro').catch(() => ({ labels: [], rows: [] }));
        buildHeatmap('heatmapBairro', hm.labels || [], hm.rows || []);
        
        // GrÃ¡fico mensal
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month').catch(() => []);
        if (dataMensal && dataMensal.length > 0) {
          const labelsMes = dataMensal.map(x => {
            const [year, month] = (x.ym || x.month || '').split('-');
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : (x.ym || x.month || '');
          });
          const valuesMes = dataMensal.map(x => x.count || 0);
          
          if (window.chartBairroMes instanceof Chart) window.chartBairroMes.destroy();
          const ctxMes = document.getElementById('chartBairroMes')?.getContext('2d');
          if (ctxMes) {
            window.chartBairroMes = new Chart(ctxMes, {
              type: 'bar',
              data: {
                labels: labelsMes,
                datasets: [{
                  label: 'ManifestaÃ§Ãµes',
                  data: valuesMes,
                  backgroundColor: 'rgba(245,158,11,0.7)',
                  borderColor: 'rgba(245,158,11,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        }
      }

      async function loadUAC() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=UAC');
        const labels = data.slice(0, 15).map(x=>x.key);
        const values = data.slice(0, 15).map(x=>x.count);
        if (window.chartUAC instanceof Chart) window.chartUAC.destroy();
        const ctx = document.getElementById('chartUAC').getContext('2d');
        window.chartUAC = new Chart(ctx, { 
          type:'bar', 
          data:{ labels, datasets:[{ label:'UAC', data: values, backgroundColor:'#22d3ee', borderColor:'#22d3ee', borderWidth:1 }] }, 
          options:{ 
            responsive:true, 
            animation:false, 
            indexAxis:'y', 
            plugins:{
              legend:{display:false},
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartUAC, (label, value) => showClickFeedback(null, label, value), 'chartUAC');
        document.getElementById('rankUAC').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-cyan-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count.toLocaleString('pt-BR')}</span></li>`).join('');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=UAC');
        buildHeatmap('heatmapUAC', hm.labels, hm.rows);
      }

      async function loadResponsavel() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Responsavel');
        const labels = data.slice(0, 15).map(x=>x.key);
        const values = data.slice(0, 15).map(x=>x.count);
        if (window.chartResponsavel instanceof Chart) window.chartResponsavel.destroy();
        const ctx = document.getElementById('chartResponsavel').getContext('2d');
        window.chartResponsavel = new Chart(ctx, { 
          type:'bar', 
          data:{ labels, datasets:[{ label:'ResponsÃ¡vel', data: values, backgroundColor:'#a78bfa', borderColor:'#a78bfa', borderWidth:1 }] }, 
          options:{ 
            responsive:true, 
            animation:false, 
            indexAxis:'y', 
            plugins:{
              legend:{display:false},
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartResponsavel, (label, value) => showClickFeedback(null, label, value), 'chartResponsavel');
        document.getElementById('rankResponsavel').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-violet-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count.toLocaleString('pt-BR')}</span></li>`).join('');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Responsavel');
        buildHeatmap('heatmapResponsavel', hm.labels, hm.rows);
      }

      async function loadCanal() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Canal');
        const labels = data.map(x=>x.key);
        const values = data.map(x=>x.count);
        if (window.chartCanal instanceof Chart) window.chartCanal.destroy();
        const ctx = document.getElementById('chartCanal').getContext('2d');
        window.chartCanal = new Chart(ctx, { 
          type:'doughnut', 
          data:{ labels, datasets:[{ data: values, backgroundColor:['#34d399','#22d3ee','#fbbf24','#a78bfa','#fb7185','#e879f9'] }] }, 
          options:{ 
            responsive:true, 
            plugins:{
              legend:{display:true, position:'right'},
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(true),
                anchor: 'center',
                align: 'center'
              }
            }
          } 
        });
        addChartClickHandler(window.chartCanal, (label, value) => showClickFeedback(null, label, value), 'chartCanal');
        document.getElementById('rankCanal').innerHTML=data.slice(0,10).map(e=>`<li><span class='text-emerald-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count.toLocaleString('pt-BR')}</span></li>`).join('');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Canal');
        buildHeatmap('heatmapCanal', hm.labels, hm.rows);
      }

      async function loadPrioridade() {
        const data = await fetchJSONWithFilter('/api/aggregate/count-by?field=Prioridade');
        const labels = data.map(x=>x.key);
        const values = data.map(x=>x.count);
        if (window.chartPrioridade instanceof Chart) window.chartPrioridade.destroy();
        const ctx = document.getElementById('chartPrioridade').getContext('2d');
        // Cores especÃ­ficas por prioridade: Alta=vermelho, MÃ©dia=amarelo, Baixa=verde
        const colors = labels.map(l => {
          const low = l.toLowerCase();
          if(low.includes('alta')) return '#fb7185';
          if(low.includes('mÃ©dia') || low.includes('media')) return '#fbbf24';
          if(low.includes('baixa')) return '#34d399';
          return '#94a3b8';
        });
        window.chartPrioridade = new Chart(ctx, { 
          type:'bar', 
          data:{ labels, datasets:[{ label:'Prioridade', data: values, backgroundColor: colors, borderColor: colors, borderWidth: 1 }] }, 
          options:{ 
            responsive:true, 
            plugins:{
              legend:{display:false},
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          } 
        });
        addChartClickHandler(window.chartPrioridade, (label, value) => showClickFeedback(null, label, value), 'chartPrioridade');
        document.getElementById('rankPrioridade').innerHTML=data.map(e=>`<li><span class='text-rose-300 font-mono'>${e.key}</span> <span class='float-right font-bold'>${e.count.toLocaleString('pt-BR')}</span></li>`).join('');
        const hm = await fetchJSONWithFilter('/api/aggregate/heatmap?dim=Prioridade');
        buildHeatmap('heatmapPrioridade', hm.labels, hm.rows);
      }

      async function loadTempoMedio() {
        try {
          console.log('ğŸ“Š Carregando dados de tempo mÃ©dio...');
          // Carregar todos os dados em paralelo
          const [data, stats, dataDia, dataSemana, dataMes, dataUnidade, dataUnidadeMes] = await Promise.all([
            fetchJSONWithFilter('/api/stats/average-time').catch(e => { console.error('Erro ao carregar average-time:', e); return []; }),
            fetchJSONWithFilter('/api/stats/average-time/stats').catch(e => { console.error('Erro ao carregar stats:', e); return null; }),
            fetchJSONWithFilter('/api/stats/average-time/by-day').catch(e => { console.error('Erro ao carregar by-day:', e); return []; }),
            fetchJSONWithFilter('/api/stats/average-time/by-week').catch(e => { console.error('Erro ao carregar by-week:', e); return []; }),
            fetchJSONWithFilter('/api/stats/average-time/by-month').catch(e => { console.error('Erro ao carregar by-month:', e); return []; }),
            fetchJSONWithFilter('/api/stats/average-time/by-unit').catch(e => { console.error('Erro ao carregar by-unit:', e); return []; }),
            fetchJSONWithFilter('/api/stats/average-time/by-month-unit').catch(e => { console.error('Erro ao carregar by-month-unit:', e); return []; })
          ]);
          
          console.log('ğŸ“Š Dados carregados:', {
            data: data?.length || 0,
            stats: stats ? 'OK' : 'null',
            dataDia: dataDia?.length || 0,
            dataSemana: dataSemana?.length || 0,
            dataMes: dataMes?.length || 0
          });
          
          // Atualizar estatÃ­sticas gerais
          if (stats) {
            document.getElementById('statMedia').textContent = stats.media || '0';
            document.getElementById('statMediana').textContent = stats.mediana || '0';
            document.getElementById('statMinimo').textContent = stats.minimo || '0';
            document.getElementById('statMaximo').textContent = stats.maximo || '0';
          }
          
          // Verificar se hÃ¡ dados
          if (!data || !Array.isArray(data) || data.length === 0) {
            console.warn('âš ï¸ Nenhum dado de tempo mÃ©dio disponÃ­vel');
            document.getElementById('chartTempoMedio').getContext('2d').clearRect(0, 0, 0, 0);
            document.getElementById('listaTempoMedio').innerHTML = '<div class="text-slate-400 text-center py-8">Nenhum dado disponÃ­vel. Verifique se hÃ¡ registros com data de criaÃ§Ã£o e conclusÃ£o.</div>';
            return;
          }
          
          const labels = data.map(x => x.org);
          const values = data.map(x => x.dias);
          
          // GrÃ¡fico de barras horizontais por Ã³rgÃ£o
          if (window.chartTempoMedio instanceof Chart) window.chartTempoMedio.destroy();
          const ctx = document.getElementById('chartTempoMedio').getContext('2d');
          window.chartTempoMedio = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Dias',
                data: values,
                backgroundColor: 'rgba(34,211,238,0.7)',
                borderColor: 'rgba(34,211,238,1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              indexAxis: 'y',
              plugins: { 
                legend: { display: false },
                tooltip: createEnhancedTooltip(),
                datalabels: {
                  ...createDataLabelsConfig(),
                  anchor: 'start',
                  align: 'end'
                }
              },
              scales: {
                x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
              }
            }
          });
          addChartClickHandler(window.chartTempoMedio, (label, value) => showClickFeedback(null, label, value), 'chartTempoMedio');
          
          // Lista de ranking
          document.getElementById('listaTempoMedio').innerHTML = data.map((item, idx) => `
            <div class="flex items-center gap-3 py-2 border-b border-white/5">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 text-sm text-slate-300 truncate">${item.org}</div>
              <div class="text-lg font-bold text-cyan-300 min-w-[60px] text-right">${item.dias.toFixed(2)}</div>
            </div>
          `).join('');
          
          // GrÃ¡fico por Dia (linha)
          if (dataDia && Array.isArray(dataDia) && dataDia.length > 0) {
            console.log('ğŸ“Š Dados por dia:', dataDia.slice(0, 5));
            const labelsDia = dataDia.map(x => {
              if (!x.date) return 'Data invÃ¡lida';
              try {
                const d = new Date(x.date);
                if (isNaN(d.getTime())) return 'Data invÃ¡lida';
                return `${d.getDate()}/${d.getMonth() + 1}`;
              } catch (e) {
                return 'Data invÃ¡lida';
              }
            });
            const valuesDia = dataDia.map(x => x.dias || 0);
            
            if (window.chartTempoMedioDia instanceof Chart) window.chartTempoMedioDia.destroy();
            const ctxDia = document.getElementById('chartTempoMedioDia').getContext('2d');
            window.chartTempoMedioDia = new Chart(ctxDia, {
              type: 'line',
              data: {
                labels: labelsDia,
                datasets: [{
                  label: 'Tempo MÃ©dio (dias)',
                  data: valuesDia,
                  borderColor: 'rgba(34,211,238,1)',
                  backgroundColor: 'rgba(34,211,238,0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'line', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
            addChartClickHandler(window.chartTempoMedioDia, (label, value) => showClickFeedback(null, label, value), 'chartTempoMedioDia');
          }
          
          // GrÃ¡fico por Semana (linha)
          if (dataSemana && Array.isArray(dataSemana) && dataSemana.length > 0) {
            console.log('ğŸ“Š Dados por semana:', dataSemana.slice(0, 5));
            const labelsSemana = dataSemana.map(x => {
              if (!x.week || typeof x.week !== 'string') return 'Semana invÃ¡lida';
              return x.week.replace('W', ' Semana ');
            });
            const valuesSemana = dataSemana.map(x => x.dias || 0);
            
            if (window.chartTempoMedioSemana instanceof Chart) window.chartTempoMedioSemana.destroy();
            const ctxSemana = document.getElementById('chartTempoMedioSemana').getContext('2d');
            window.chartTempoMedioSemana = new Chart(ctxSemana, {
              type: 'line',
              data: {
                labels: labelsSemana,
                datasets: [{
                  label: 'Tempo MÃ©dio (dias)',
                  data: valuesSemana,
                  borderColor: 'rgba(167,139,250,1)',
                  backgroundColor: 'rgba(167,139,250,0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'line', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
            addChartClickHandler(window.chartTempoMedioSemana, (label, value) => showClickFeedback(null, label, value), 'chartTempoMedioSemana');
          }
          
          // GrÃ¡fico por MÃªs (barra)
          if (dataMes && Array.isArray(dataMes) && dataMes.length > 0) {
            console.log('ğŸ“Š Dados por mÃªs:', dataMes.slice(0, 5));
            const labelsMes = dataMes.map(x => {
              const monthStr = x.month || x.ym || '';
              if (!monthStr || typeof monthStr !== 'string') return monthStr || 'Data invÃ¡lida';
              const parts = monthStr.split('-');
              if (parts.length < 2) return monthStr;
              const [year, month] = parts;
              const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
              return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : monthStr;
            });
            const valuesMes = dataMes.map(x => x.dias || 0);
            
            if (window.chartTempoMedioMes instanceof Chart) window.chartTempoMedioMes.destroy();
            const ctxMes = document.getElementById('chartTempoMedioMes').getContext('2d');
            window.chartTempoMedioMes = new Chart(ctxMes, {
              type: 'bar',
              data: {
                labels: labelsMes,
                datasets: [{
                  label: 'Tempo MÃ©dio (dias)',
                  data: valuesMes,
                  backgroundColor: 'rgba(167,139,250,0.7)',
                  borderColor: 'rgba(167,139,250,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
            addChartClickHandler(window.chartTempoMedioMes, (label, value) => showClickFeedback(null, label, value), 'chartTempoMedioMes');
          }
          
          // GrÃ¡fico por Unidade de Cadastro
          if (dataUnidade && dataUnidade.length > 0) {
            const labelsUnidade = dataUnidade.map(x => x.unit || 'NÃ£o informado');
            const valuesUnidade = dataUnidade.map(x => x.dias || 0);
            
            if (window.chartTempoMedioUnidade instanceof Chart) window.chartTempoMedioUnidade.destroy();
            const ctxUnidade = document.getElementById('chartTempoMedioUnidade').getContext('2d');
            window.chartTempoMedioUnidade = new Chart(ctxUnidade, {
              type: 'bar',
              data: {
                labels: labelsUnidade,
                datasets: [{
                  label: 'Dias',
                  data: valuesUnidade,
                  backgroundColor: 'rgba(167,139,250,0.7)',
                  borderColor: 'rgba(167,139,250,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: {
                    ...createDataLabelsConfig(),
                    anchor: 'start',
                    align: 'end'
                  }
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
            addChartClickHandler(window.chartTempoMedioUnidade, (label, value) => showClickFeedback(null, label, value), 'chartTempoMedioUnidade');
          }
          
          // GrÃ¡fico por Unidade de Cadastro por MÃªs
          if (dataUnidadeMes && dataUnidadeMes.length > 0) {
            // Agrupar dados por mÃªs e criar datasets para cada unidade
            // Filtrar meses invÃ¡lidos antes de processar
            const meses = [...new Set(dataUnidadeMes.map(d => d.month).filter(m => m && typeof m === 'string' && m.includes('-')))].sort();
            const unidades = [...new Set(dataUnidadeMes.map(d => d.unit).filter(u => u))];
            const colors = ['#34d399', '#10b981', '#059669', '#047857', '#065f46', '#064e3b', '#a78bfa', '#8b5cf6', '#7c3aed', '#6d28d9'];
            
            const datasets = unidades.slice(0, 10).map((unit, idx) => ({
              label: unit || 'NÃ£o informado',
              data: meses.map(month => {
                const item = dataUnidadeMes.find(d => d.month === month && d.unit === unit);
                return item ? (item.dias || 0) : 0;
              }),
              backgroundColor: colors[idx % colors.length] + '80',
              borderColor: colors[idx % colors.length],
              borderWidth: 1
            }));
            
            const labelsMes = meses.map(m => {
              // ValidaÃ§Ã£o robusta antes de fazer split
              if (!m || typeof m !== 'string' || !m.includes('-')) {
                return m || 'Data invÃ¡lida';
              }
              const parts = m.split('-');
              if (parts.length < 2) {
                return m;
              }
              const [year, month] = parts;
              const monthNum = parseInt(month);
              if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) {
                return m;
              }
              const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
              return `${monthNames[monthNum - 1]}. de ${year}`;
            });
            
            if (window.chartTempoMedioUnidadeMes instanceof Chart) window.chartTempoMedioUnidadeMes.destroy();
            const ctxUnidadeMes = document.getElementById('chartTempoMedioUnidadeMes').getContext('2d');
            window.chartTempoMedioUnidadeMes = new Chart(ctxUnidadeMes, {
              type: 'line',
              data: {
                labels: labelsMes,
                datasets: datasets
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: true, position: 'right', labels: { color: '#94a3b8', font: { size: 11 } } },
                  tooltip: createEnhancedTooltip(),
                  datalabels: { display: false }
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        } catch (error) {
          console.error('âŒ Erro ao carregar tempo mÃ©dio:', error);
          const errorMsg = error.message || 'Erro desconhecido ao carregar dados';
          document.getElementById('listaTempoMedio').innerHTML = `<div class="text-red-400 text-center py-8">Erro ao carregar dados: ${errorMsg}</div>`;
        }
      }

      async function loadTema() {
        const data = await fetchJSONWithFilter('/api/aggregate/by-theme');
        // Mostrar todos os temas, sem limitaÃ§Ã£o
        const labels = data.map(x => x.tema);
        const values = data.map(x => x.quantidade);
        
        // GrÃ¡fico de temas
        if (window.chartTema instanceof Chart) window.chartTema.destroy();
        const ctx = document.getElementById('chartTema').getContext('2d');
        window.chartTema = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: values,
              backgroundColor: 'rgba(167,139,250,0.7)',
              borderColor: 'rgba(167,139,250,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end'
              }
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        addChartClickHandler(window.chartTema, (label, value) => showClickFeedback(null, label, value), 'chartTema');
        
        // Status geral
        const status = await fetchJSONWithFilter('/api/stats/status-overview');
        if (window.chartStatusTema instanceof Chart) window.chartStatusTema.destroy();
        const ctxStatus = document.getElementById('chartStatusTema').getContext('2d');
          window.chartStatusTema = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
              labels: ['ConcluÃ­da', 'Em atendimento'],
              datasets: [{
              data: [status.concluida.percentual, status.emAtendimento.percentual],
                backgroundColor: ['#38bdf8', '#fbbf24']
              }]
            },
            options: { 
              responsive: true,
              plugins: {
                tooltip: createEnhancedTooltip(),
                datalabels: {
                  ...createDataLabelsConfig(true),
                  anchor: 'center',
                  align: 'center'
                }
              }
            }
          });
        addChartClickHandler(window.chartStatusTema, (label, value) => showClickFeedback(null, label, value), 'chartStatusTema');
        document.getElementById('statusTemaInfo').innerHTML = `
          <div class="text-cyan-300">ConcluÃ­da: ${status.concluida.percentual}%</div>
          <div class="text-amber-300">Em atendimento: ${status.emAtendimento.percentual}%</div>
        `;
        
        // GrÃ¡fico mensal
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month');
        const labelsMes = dataMensal.map(x => {
          const ym = x.ym || x.month || '';
          if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
          const parts = ym.split('-');
          if (parts.length < 2) return ym;
          const [year, month] = parts;
          if (!year || !month) return ym;
          const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
          const monthIndex = parseInt(month) - 1;
          return monthIndex >= 0 && monthIndex < 12 ? `${monthNames[monthIndex]}. de ${year}` : ym;
        });
        const valuesMes = dataMensal.map(x => x.count);
        
        if (window.chartTemaMes instanceof Chart) window.chartTemaMes.destroy();
        const ctxMes = document.getElementById('chartTemaMes').getContext('2d');
        window.chartTemaMes = new Chart(ctxMes, {
          type: 'bar',
          data: {
            labels: labelsMes,
            datasets: [{
              label: 'Quantidade',
              data: valuesMes,
              backgroundColor: 'rgba(167,139,250,0.7)',
              borderColor: 'rgba(167,139,250,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        
        // Lista completa de temas
        const listaTemas = document.getElementById('listaTemas');
        if (listaTemas) {
          const maxQuantidade = Math.max(...data.map(d => d.quantidade), 1);
          listaTemas.innerHTML = data.map((item, idx) => {
            const width = (item.quantidade / maxQuantidade) * 100;
            return `
              <div class="flex items-center gap-3 py-2 border-b border-white/5">
                <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
                <div class="flex-1 min-w-0">
                  <div class="text-sm text-slate-300 truncate font-medium">${item.tema}</div>
                  <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-violet-500 to-cyan-500" style="width: ${width}%"></div>
                  </div>
                </div>
                <div class="text-lg font-bold text-violet-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
              </div>
            `;
          }).join('');
        }
        
        // Exibir filtros aplicados
        const filtrosTemaInfo = document.getElementById('filtrosTemaInfo');
        if (filtrosTemaInfo) {
          const filtros = [];
          if (window.globalFilters?.filters && window.globalFilters.filters.length > 0) {
            window.globalFilters.filters.forEach(f => {
              if (f.field === 'Data' || f.field === 'MÃªs') {
                const meses = Array.isArray(f.value) ? f.value : [f.value];
                meses.forEach(mes => {
                  if (mes && typeof mes === 'string') {
                    const parts = mes.split('-');
                    if (parts.length >= 2) {
                      const [year, month] = parts;
                      const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                      filtros.push(`${monthNames[parseInt(month) - 1]}/${year}`);
                    } else {
                      filtros.push(`MÃªs: ${mes}`);
                    }
                  }
                });
              } else {
                filtros.push(`${f.field}: ${f.value}`);
              }
            });
          }
          if (filtros.length > 0) {
            filtrosTemaInfo.innerHTML = `ğŸ” Filtros: ${filtros.join(', ')}`;
            filtrosTemaInfo.classList.remove('hidden');
          } else {
            filtrosTemaInfo.innerHTML = '';
            filtrosTemaInfo.classList.add('hidden');
          }
        }
      }

      async function loadAssunto() {
        const data = await fetchJSONWithFilter('/api/aggregate/by-subject');
        
        // Limitar grÃ¡fico "Top Assuntos" para Top 15 para melhor legibilidade
        // A lista completa abaixo mostra todos os assuntos
        const topAssuntos = data.slice(0, 15);
        const labels = topAssuntos.map(x => {
          // Truncar labels muito longos (mÃ¡ximo 50 caracteres)
          const label = x.assunto || 'NÃ£o informado';
          return label.length > 50 ? label.substring(0, 47) + '...' : label;
        });
        const labelsFull = topAssuntos.map(x => x.assunto || 'NÃ£o informado'); // Labels completos para tooltip
        const values = topAssuntos.map(x => x.quantidade);
        
        // GrÃ¡fico de assuntos (Top 15)
        const canvasAssunto = document.getElementById('chartAssunto');
        if (!canvasAssunto) {
          console.warn('Canvas chartAssunto nÃ£o encontrado');
          return;
        }
        
        // Destruir grÃ¡fico anterior se existir
        if (window.chartAssunto instanceof Chart) {
          try {
            window.chartAssunto.destroy();
          } catch (e) {
            console.warn('Erro ao destruir grÃ¡fico anterior:', e);
          }
          window.chartAssunto = null;
        }
        
        // Aguardar um frame para garantir que o canvas estÃ¡ livre
        await new Promise(resolve => setTimeout(resolve, 50));
        
        const ctx = canvasAssunto.getContext('2d');
        window.chartAssunto = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: values,
              backgroundColor: 'rgba(34,211,238,0.7)',
              borderColor: 'rgba(34,211,238,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const fullLabel = labelsFull[context.dataIndex];
                    const value = context.parsed.x;
                    return `${fullLabel}: ${value.toLocaleString('pt-BR')}`;
                  }
                }
              },
              datalabels: {
                ...createDataLabelsConfig(),
                anchor: 'start',
                align: 'end',
                display: function(context) {
                  // Mostrar apenas se houver espaÃ§o suficiente
                  return context.dataIndex < 10;
                }
              }
            },
            scales: {
              x: { 
                beginAtZero: true, 
                ticks: { color: '#94a3b8', font: { size: 11 } }, 
                grid: { color: 'rgba(255,255,255,0.05)' } 
              },
              y: { 
                ticks: { 
                  color: '#94a3b8',
                  font: { size: 10 },
                  maxRotation: 0,
                  minRotation: 0,
                  callback: function(value, index) {
                    // Garantir que labels truncados sejam mostrados
                    return labels[index] || '';
                  }
                }, 
                grid: { color: 'rgba(255,255,255,0.05)' }
              }
            },
            layout: {
              padding: {
                left: 10,
                right: 10,
                top: 10,
                bottom: 10
              }
            }
          }
        });
        addChartClickHandler(window.chartAssunto, (label, value) => showClickFeedback(null, label, value), 'chartAssunto');
        
        // Status geral
        const status = await fetchJSONWithFilter('/api/stats/status-overview');
        if (window.chartStatusAssunto instanceof Chart) window.chartStatusAssunto.destroy();
        const ctxStatus = document.getElementById('chartStatusAssunto').getContext('2d');
          window.chartStatusAssunto = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
              labels: ['ConcluÃ­da', 'Em atendimento'],
              datasets: [{
              data: [status.concluida.percentual, status.emAtendimento.percentual],
                backgroundColor: ['#38bdf8', '#fbbf24']
              }]
            },
            options: { responsive: true }
          });
        document.getElementById('statusAssuntoInfo').innerHTML = `
          <div class="text-cyan-300">ConcluÃ­da: ${status.concluida.percentual}%</div>
          <div class="text-amber-300">Em atendimento: ${status.emAtendimento.percentual}%</div>
        `;
        
        // Lista completa de assuntos
        const listaAssuntos = document.getElementById('listaAssuntos');
        if (listaAssuntos) {
          const maxQuantidade = Math.max(...data.map(d => d.quantidade), 1);
          listaAssuntos.innerHTML = data.map((item, idx) => {
            const width = (item.quantidade / maxQuantidade) * 100;
          return `
            <div class="flex items-center gap-3 py-2 border-b border-white/5">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 min-w-0">
                  <div class="text-sm text-slate-300 truncate font-medium">${item.assunto}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-violet-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-cyan-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        }
        
        // GrÃ¡fico mensal
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month').catch(() => []);
        if (dataMensal && dataMensal.length > 0) {
          const labelsMes = dataMensal.map(x => {
            const [year, month] = (x.ym || x.month || '').split('-');
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : (x.ym || x.month || '');
          });
          const valuesMes = dataMensal.map(x => x.count || 0);
          
          if (window.chartAssuntoMes instanceof Chart) window.chartAssuntoMes.destroy();
          const ctxMes = document.getElementById('chartAssuntoMes')?.getContext('2d');
          if (ctxMes) {
            window.chartAssuntoMes = new Chart(ctxMes, {
              type: 'bar',
              data: {
                labels: labelsMes,
                datasets: [{
                  label: 'ManifestaÃ§Ãµes',
                  data: valuesMes,
                  backgroundColor: 'rgba(34,211,238,0.7)',
                  borderColor: 'rgba(34,211,238,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: { 
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', false)
                },
                scales: {
                  y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
        }
      }

      // Sistema de filtro global unificado
      if (!window.globalFilters) {
        window.globalFilters = {
          filters: [],
          activeField: null,
          activeValue: null,
          cadastranteFilter: null // { type: 'servidor'|'unidadeCadastro', value: string }
        };
      }
      
      // FunÃ§Ã£o helper para adicionar filtros Ã s URLs
      function addFilterToUrl(url) {
        if (!window.globalFilters || !window.globalFilters.cadastranteFilter) return url;
        const filter = window.globalFilters.cadastranteFilter;
        const separator = url.includes('?') ? '&' : '?';
        return `${url}${separator}${filter.type}=${encodeURIComponent(filter.value)}`;
      }
      
      // FunÃ§Ã£o helper para fazer fetch com filtros aplicados (removida - agora Ã© alias de fetchJSONWithFilters)
      
      // FunÃ§Ã£o para aplicar filtro global de cadastrante
      window.applyGlobalCadastranteFilter = async function(filter) {
        window.globalFilters.cadastranteFilter = filter;
        
        // Atualizar indicador global
        updateGlobalFilterIndicator();
        
        // Recarregar todos os dados de todas as pÃ¡ginas
        await reloadAllDataWithCadastranteFilter();
      };
      
      // FunÃ§Ã£o para limpar filtro global
      window.clearGlobalCadastranteFilter = function() {
        window.globalFilters.cadastranteFilter = null;
        updateGlobalFilterIndicator();
        reloadAllDataWithCadastranteFilter();
      };
      
      // FunÃ§Ã£o para atualizar indicador global de filtro
      function updateGlobalFilterIndicator() {
        const indicator = document.getElementById('filterIndicator');
        if (!indicator) return;
        
        const filter = window.globalFilters.cadastranteFilter;
        if (filter) {
          const filterText = filter.type === 'servidor' ? `Servidor: ${filter.value}` : `Unidade: ${filter.value}`;
          indicator.innerHTML = `
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-cyan-500/20 border border-cyan-500/30 shadow-lg">
              <span class="text-cyan-300 text-sm font-semibold">ğŸ” Filtro Global Ativo:</span>
              <span class="text-slate-200 text-sm">${filterText}</span>
              <button onclick="clearGlobalCadastranteFilter()" class="ml-2 text-cyan-300 hover:text-cyan-100 text-xs px-3 py-1 rounded bg-cyan-500/30 font-bold">Limpar Filtro</button>
            </div>
          `;
          indicator.classList.remove('hidden');
        } else {
          indicator.classList.add('hidden');
        }
        
        // Atualizar tambÃ©m os filtros na pÃ¡gina de cadastrante
        updateCadastranteFiltersDisplay();
      }
      
      // FunÃ§Ã£o para atualizar exibiÃ§Ã£o de filtros na pÃ¡gina de cadastrante
      function updateCadastranteFiltersDisplay() {
        const filtrosCadastranteInfo = document.getElementById('filtrosCadastranteInfo');
        if (!filtrosCadastranteInfo) return;
        
        const filtros = [];
        
        // Filtro de cadastrante/unidade
        if (window.globalFilters?.cadastranteFilter) {
          const filter = window.globalFilters.cadastranteFilter;
          const filterText = filter.type === 'servidor' ? `Servidor: ${filter.value}` : `Unidade: ${filter.value}`;
          filtros.push(filterText);
        }
        
        // Filtros de mÃªs/data
        if (window.globalFilters?.filters && window.globalFilters.filters.length > 0) {
          window.globalFilters.filters.forEach(f => {
            if (f.field === 'Data' || f.field === 'MÃªs') {
              const meses = Array.isArray(f.value) ? f.value : [f.value];
              meses.forEach(mes => {
                if (mes && typeof mes === 'string') {
                  const parts = mes.split('-');
                  if (parts.length >= 2) {
                    const [year, month] = parts;
                    const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                    filtros.push(`MÃªs: ${monthNames[parseInt(month) - 1]}/${year}`);
                  } else {
                    filtros.push(`MÃªs: ${mes}`);
                  }
                }
              });
            }
          });
        }
        
        if (filtros.length > 0) {
          filtrosCadastranteInfo.innerHTML = `ğŸ” Filtros aplicados: ${filtros.join(' â€¢ ')}`;
          filtrosCadastranteInfo.classList.remove('hidden');
        } else {
          filtrosCadastranteInfo.innerHTML = '';
          filtrosCadastranteInfo.classList.add('hidden');
        }
      }
      
      // FunÃ§Ã£o para recarregar todos os dados quando filtro muda
      async function reloadAllDataWithCadastranteFilter() {
        const currentPage = document.querySelector('[data-page].active')?.getAttribute('data-page') || 'main';
        
        // Recarregar pÃ¡gina atual
        if (currentPage === 'main') await loadOverview();
        else if (currentPage === 'orgao-mes') await loadOrgaoMes();
        else if (currentPage === 'tempo-medio') await loadTempoMedio();
        else if (currentPage === 'tema') await loadTema();
        else if (currentPage === 'assunto') await loadAssunto();
        else if (currentPage === 'cadastrante') await loadCadastrante();
        else if (currentPage === 'reclamacoes') await loadReclamacoes();
        else if (currentPage === 'projecao-2026') await loadProjecao2026();
        else if (currentPage === 'secretaria') await loadSecretaria();
        else if (currentPage === 'secretarias-distritos') await loadSecretariasDistritos();
        else if (currentPage === 'tipo') await loadTipo();
        else if (currentPage === 'setor') await loadSetor();
        else if (currentPage === 'categoria') await loadCategoria();
        else if (currentPage === 'status') await loadStatusPage();
        else if (currentPage === 'bairro') await loadBairro();
        else if (currentPage === 'uac') await loadUAC();
        else if (currentPage === 'responsavel') await loadResponsavel();
        else if (currentPage === 'canal') await loadCanal();
        else if (currentPage === 'prioridade') await loadPrioridade();
      }
      
      // FunÃ§Ã£o para atualizar todos os grÃ¡ficos com dados filtrados (mantida para compatibilidade)
      window.updateCadastranteCharts = async function(filter) {
        await window.applyGlobalCadastranteFilter(filter);
        
        if (!filter) {
          // Sem filtro, recarregar pÃ¡gina completa
          await loadCadastrante();
          return;
        }
        
        // Buscar dados filtrados
        const url = `/api/aggregate/filtered?${filter.type}=${encodeURIComponent(filter.value)}`;
        const filteredData = await fetchJSON(url);
        
        // Atualizar grÃ¡fico mensal
        const labelsMes = filteredData.byMonth.map(x => {
          const ym = x.ym || x.month || '';
          if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
          const parts = ym.split('-');
          if (parts.length < 2) return ym;
          const [year, month] = parts;
          const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
          return `${monthNames[parseInt(month) - 1]}. de ${year}`;
        });
        const valuesMes = filteredData.byMonth.map(x => x.count);
        
        if (window.chartCadastranteMes instanceof Chart) {
          window.chartCadastranteMes.data.labels = labelsMes;
          window.chartCadastranteMes.data.datasets[0].data = valuesMes;
          window.chartCadastranteMes.update();
        }
        
        // Atualizar total
        document.getElementById('totalCadastrante').textContent = (filteredData.total || 0).toLocaleString('pt-BR');
        
        // Atualizar destaque visual nas listas
        document.querySelectorAll('.servidor-item').forEach(item => {
          const servidor = item.getAttribute('data-servidor');
          const isActive = filter.type === 'servidor' && filter.value === servidor;
          if (isActive) {
            item.classList.add('bg-cyan-500/20', 'border-cyan-500/30', 'border-l-4');
            item.classList.remove('border-b');
          } else {
            item.classList.remove('bg-cyan-500/20', 'border-cyan-500/30', 'border-l-4');
            item.classList.add('border-b');
          }
        });
        
        document.querySelectorAll('.unidade-item').forEach(item => {
          const unidade = item.getAttribute('data-unidade');
          const isActive = filter.type === 'unidadeCadastro' && filter.value === unidade;
          if (isActive) {
            item.classList.add('bg-violet-500/20', 'border-violet-500/30', 'border-l-4');
            item.classList.remove('border-b');
          } else {
            item.classList.remove('bg-violet-500/20', 'border-violet-500/30', 'border-l-4');
            item.classList.add('border-b');
          }
        });
        
        // Mostrar/ocultar seÃ§Ã£o de grÃ¡ficos filtrados
        const graficosFiltrados = document.getElementById('graficosFiltrados');
        if (filter && filteredData) {
          graficosFiltrados.style.display = 'grid';
          
          // GrÃ¡fico por Tema
          if (filteredData.byTheme && filteredData.byTheme.length > 0) {
            const ctxTema = document.getElementById('chartCadastranteTema').getContext('2d');
            if (window.chartCadastranteTema instanceof Chart) window.chartCadastranteTema.destroy();
            window.chartCadastranteTema = new Chart(ctxTema, {
              type: 'bar',
              data: {
                labels: filteredData.byTheme.map(t => t.tema || 'NÃ£o informado'),
                datasets: [{
                  label: 'Quantidade',
                  data: filteredData.byTheme.map(t => t.quantidade),
                  backgroundColor: 'rgba(251, 191, 36, 0.7)',
                  borderColor: 'rgba(251, 191, 36, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', true)
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 0 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
          
          // GrÃ¡fico por Assunto
          if (filteredData.bySubject && filteredData.bySubject.length > 0) {
            const ctxAssunto = document.getElementById('chartCadastranteAssunto').getContext('2d');
            if (window.chartCadastranteAssunto instanceof Chart) window.chartCadastranteAssunto.destroy();
            window.chartCadastranteAssunto = new Chart(ctxAssunto, {
              type: 'bar',
              data: {
                labels: filteredData.bySubject.map(a => a.assunto || 'NÃ£o informado'),
                datasets: [{
                  label: 'Quantidade',
                  data: filteredData.bySubject.map(a => a.quantidade),
                  backgroundColor: 'rgba(236, 72, 153, 0.7)',
                  borderColor: 'rgba(236, 72, 153, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(false, 'bar', true)
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 0 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
              }
            });
          }
          
          // GrÃ¡fico por Status (doughnut)
          if (filteredData.byStatus && filteredData.byStatus.length > 0) {
            const ctxStatus = document.getElementById('chartCadastranteStatus').getContext('2d');
            if (window.chartCadastranteStatus instanceof Chart) window.chartCadastranteStatus.destroy();
            const colors = ['#22d3ee', '#a78bfa', '#34d399', '#f59e0b', '#fb7185', '#f472b6', '#8b5cf6', '#06b6d4'];
            window.chartCadastranteStatus = new Chart(ctxStatus, {
              type: 'doughnut',
              data: {
                labels: filteredData.byStatus.map(s => s.status || 'NÃ£o informado'),
                datasets: [{
                  data: filteredData.byStatus.map(s => s.quantidade),
                  backgroundColor: filteredData.byStatus.map((s, idx) => colors[idx % colors.length])
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: true, position: 'right', labels: { color: '#94a3b8', font: { size: 11 } } },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(true, 'doughnut')
                }
              }
            });
          }
          
          // Se filtro for por servidor, mostrar unidades cadastradas
          if (filter.type === 'servidor' && filteredData.unidadesCadastradas && filteredData.unidadesCadastradas.length > 0) {
            // Criar ou atualizar seÃ§Ã£o de unidades cadastradas
            let unidadesSection = document.getElementById('unidadesCadastradasSection');
            if (!unidadesSection) {
              unidadesSection = document.createElement('div');
              unidadesSection.id = 'unidadesCadastradasSection';
              unidadesSection.className = 'col-span-12 glass rounded-2xl p-5';
              unidadesSection.innerHTML = '<h3 class="font-semibold mb-4 text-emerald-400">Unidades Cadastradas por este Servidor</h3><div id="listaUnidadesCadastradas" class="space-y-2 max-h-[400px] overflow-y-auto"></div>';
              const grid = document.querySelector('#page-cadastrante .grid');
              grid.appendChild(unidadesSection);
            }
            
            const maxCount = Math.max(...filteredData.unidadesCadastradas.map(d => d.quantidade), 1);
            document.getElementById('listaUnidadesCadastradas').innerHTML = filteredData.unidadesCadastradas.map((item, idx) => {
              const width = (item.quantidade / maxCount) * 100;
              return `
                <div class="flex items-center gap-3 py-2 border-b border-white/5">
                  <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm text-slate-300 truncate">${item.unidade}</div>
                    <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500" style="width: ${width}%"></div>
                    </div>
                  </div>
                  <div class="text-lg font-bold text-emerald-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
                </div>
              `;
            }).join('');
          } else {
            const unidadesSection = document.getElementById('unidadesCadastradasSection');
            if (unidadesSection) unidadesSection.remove();
          }
        } else {
          graficosFiltrados.style.display = 'none';
          const unidadesSection = document.getElementById('unidadesCadastradasSection');
          if (unidadesSection) unidadesSection.remove();
        }
        
        // Atualizar exibiÃ§Ã£o de filtros
        updateCadastranteFiltersDisplay();
      }
      
      // FunÃ§Ã£o para limpar filtro (compatibilidade)
      window.clearCadastranteFilter = function() {
        window.clearGlobalCadastranteFilter();
      };
      
      async function loadCadastrante() {
        // Servidores
        const servidores = await fetchJSONWithFilter('/api/aggregate/by-server');
        const listaServidores = document.getElementById('listaServidores');
        listaServidores.innerHTML = servidores.map((item, idx) => {
          const width = (item.quantidade / Math.max(...servidores.map(d => d.quantidade), 1)) * 100;
          const isActive = window.globalFilters?.cadastranteFilter?.type === 'servidor' && window.globalFilters.cadastranteFilter.value === item.servidor;
          return `
            <div class="servidor-item flex items-center gap-3 py-2 border-b border-white/5 cursor-pointer hover:bg-white/5 transition-all ${isActive ? 'bg-cyan-500/20 border-cyan-500/30 border-l-4' : ''}" 
                 data-servidor="${item.servidor.replace(/"/g, '&quot;')}">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-slate-300 truncate font-medium">${item.servidor}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-violet-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-cyan-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        
        // Adicionar event listeners aos servidores
        listaServidores.querySelectorAll('.servidor-item').forEach(item => {
          item.addEventListener('click', function() {
            const servidor = this.getAttribute('data-servidor');
            updateCadastranteCharts({ type: 'servidor', value: servidor });
          });
        });
        
        // Unidades de Cadastro (UAC)
        const uacs = await fetchJSONWithFilter('/api/aggregate/count-by?field=UAC');
        const listaUnidades = document.getElementById('listaUnidadesCadastro');
        listaUnidades.innerHTML = uacs.map((item, idx) => {
          const width = (item.count / Math.max(...uacs.map(d => d.count), 1)) * 100;
          const isActive = window.globalFilters?.cadastranteFilter?.type === 'unidadeCadastro' && window.globalFilters.cadastranteFilter.value === item.key;
          return `
            <div class="unidade-item flex items-center gap-3 py-2 border-b border-white/5 cursor-pointer hover:bg-white/5 transition-all ${isActive ? 'bg-violet-500/20 border-violet-500/30 border-l-4' : ''}" 
                 data-unidade="${item.key.replace(/"/g, '&quot;')}">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-slate-300 truncate font-medium">${item.key}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-violet-500 to-cyan-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-violet-300 min-w-[80px] text-right">${item.count.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        
        // Adicionar event listeners Ã s unidades
        listaUnidades.querySelectorAll('.unidade-item').forEach(item => {
          item.addEventListener('click', function() {
            const unidade = this.getAttribute('data-unidade');
            updateCadastranteCharts({ type: 'unidadeCadastro', value: unidade });
          });
        });
        
        // GrÃ¡fico mensal (com filtro se houver)
        const dataMensal = await fetchJSONWithFilter('/api/aggregate/by-month');
        const labelsMes = dataMensal.map(x => {
          const ym = x.ym || x.month || '';
          if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
          const parts = ym.split('-');
          if (parts.length < 2) return ym;
          const [year, month] = parts;
          if (!year || !month) return ym;
          const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
          const monthIndex = parseInt(month) - 1;
          return monthIndex >= 0 && monthIndex < 12 ? `${monthNames[monthIndex]}. de ${year}` : ym;
        });
        const valuesMes = dataMensal.map(x => x.count);
        
        if (window.chartCadastranteMes instanceof Chart) window.chartCadastranteMes.destroy();
        const ctxMes = document.getElementById('chartCadastranteMes').getContext('2d');
        window.chartCadastranteMes = new Chart(ctxMes, {
          type: 'bar',
          data: {
            labels: labelsMes,
            datasets: [{
              label: 'Quantidade',
              data: valuesMes,
              backgroundColor: 'rgba(167,139,250,0.7)',
              borderColor: 'rgba(167,139,250,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', false)
            },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        
        // Total (com filtro se houver)
        const summary = await fetchJSONWithFilter('/api/summary');
        document.getElementById('totalCadastrante').textContent = (summary.total || 0).toLocaleString('pt-BR');
        
        // Atualizar exibiÃ§Ã£o de filtros
        updateCadastranteFiltersDisplay();
        
        // Se jÃ¡ houver filtro ativo, atualizar grÃ¡ficos adicionais
        if (window.globalFilters?.cadastranteFilter) {
          await updateCadastranteCharts(window.globalFilters.cadastranteFilter);
        }
      }

      async function loadReclamacoes() {
        const [data, dataMensal] = await Promise.all([
          fetchJSONWithFilter('/api/complaints-denunciations'),
          fetchJSONWithFilter('/api/aggregate/by-month').catch(() => [])
        ]);
        
        const assuntos = data.assuntos || [];
        const tipos = data.tipos || [];
        
        // Lista de assuntos
        document.getElementById('listaReclamacoes').innerHTML = assuntos.map((item, idx) => {
          const width = assuntos.length > 0 ? (item.quantidade / Math.max(...assuntos.map(d => d.quantidade), 1)) * 100 : 0;
          return `
            <div class="flex items-center gap-3 py-2 border-b border-white/5">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-slate-300 truncate font-medium">${item.assunto}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-rose-500 to-pink-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-rose-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        
        // GrÃ¡fico de tipos de aÃ§Ã£o
        const labels = tipos.map(t => t.tipo);
        const values = tipos.map(t => t.quantidade);
        
        if (window.chartReclamacoesTipo instanceof Chart) window.chartReclamacoesTipo.destroy();
        const ctx = document.getElementById('chartReclamacoesTipo').getContext('2d');
        window.chartReclamacoesTipo = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: values,
              backgroundColor: 'rgba(239,68,68,0.7)',
              borderColor: 'rgba(239,68,68,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', true)
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
        
        // GrÃ¡fico por mÃªs
        if (dataMensal && dataMensal.length > 0) {
          const labelsMes = dataMensal.map(x => {
            const ym = x.ym || x.month || '';
            if (!ym || typeof ym !== 'string') return ym || 'Data invÃ¡lida';
            const parts = ym.split('-');
            if (parts.length < 2) return ym;
            const [year, month] = parts;
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : ym;
          });
          const valuesMes = dataMensal.map(x => x.count);
          
          if (window.chartReclamacoesMes instanceof Chart) window.chartReclamacoesMes.destroy();
          const ctxMes = document.getElementById('chartReclamacoesMes').getContext('2d');
          window.chartReclamacoesMes = new Chart(ctxMes, {
            type: 'bar',
            data: {
              labels: labelsMes,
              datasets: [{
                label: 'Quantidade',
                data: valuesMes,
                backgroundColor: 'rgba(239,68,68,0.7)',
                borderColor: 'rgba(239,68,68,1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: { 
                legend: { display: false },
                tooltip: createEnhancedTooltip(),
                datalabels: createDataLabelsConfig(false, 'bar', false)
              },
              scales: {
                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
              }
            }
          });
        }
      }

      async function loadProjecao2026() {
        try {
          // Carregar dados histÃ³ricos
          const [byMonth, temas, status] = await Promise.all([
            fetchJSONWithFilter('/api/aggregate/by-month'),
            fetchJSONWithFilter('/api/aggregate/by-theme'),
            fetchJSONWithFilter('/api/stats/status-overview')
          ]);
          
          // Processar dados mensais histÃ³ricos
          const historico = byMonth.map(x => {
            const ym = x.ym || x.month || '';
            if (!ym || typeof ym !== 'string') {
              return {
                label: ym || 'Data invÃ¡lida',
                value: x.count || 0,
                year: 0,
                month: 0
              };
            }
            const parts = ym.split('-');
            if (parts.length < 2) {
              return {
                label: ym,
                value: x.count || 0,
                year: 0,
                month: 0
              };
            }
            const [year, month] = parts;
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return {
              label: month ? `${monthNames[parseInt(month) - 1]}. de ${year}` : ym,
              value: x.count || 0,
              year: parseInt(year) || 0,
              month: parseInt(month) || 0
            };
          });
          
          // Calcular mÃ©dia mensal dos Ãºltimos 12 meses
          const ultimos12Meses = historico.slice(-12);
          const mediaMensal = ultimos12Meses.reduce((sum, item) => sum + item.value, 0) / ultimos12Meses.length;
          
          // Gerar projeÃ§Ã£o para 2026 (12 meses)
          const projecao2026 = [];
          for (let mes = 1; mes <= 12; mes++) {
            const monthNames = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            projecao2026.push({
              label: `${monthNames[mes - 1]}. de 2026`,
              value: Math.round(mediaMensal * (1 + (Math.random() * 0.2 - 0.1))) // VariaÃ§Ã£o de Â±10%
            });
          }
          
          // Combinar histÃ³rico e projeÃ§Ã£o
          const todosLabels = [...historico.map(h => h.label), ...projecao2026.map(p => p.label)];
          const todosValores = [...historico.map(h => h.value), ...projecao2026.map(p => p.value)];
          const pontoDivisao = historico.length;
          
          // GrÃ¡fico de tendÃªncia mensal com projeÃ§Ã£o
          if (window.chartProjecaoMensal instanceof Chart) window.chartProjecaoMensal.destroy();
          const ctxMensal = document.getElementById('chartProjecaoMensal')?.getContext('2d');
          if (ctxMensal) {
            window.chartProjecaoMensal = new Chart(ctxMensal, {
              type: 'line',
              data: {
                labels: todosLabels,
                datasets: [
                  {
                    label: 'HistÃ³rico',
                    data: [...historico.map(h => h.value), ...Array(12).fill(null)],
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34,211,238,0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                  },
                  {
                    label: 'ProjeÃ§Ã£o 2026',
                    data: [...Array(historico.length).fill(null), ...projecao2026.map(p => p.value)],
                    borderColor: '#a78bfa',
                    backgroundColor: 'rgba(167,139,250,0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: true,
                    tension: 0.4
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: true, position: 'top', labels: { color: '#94a3b8' } },
                  tooltip: createEnhancedTooltip(),
                  datalabels: { display: false }
                },
                scales: {
                  x: { ticks: { color: '#94a3b8', maxRotation: 45 } },
                  y: { ticks: { color: '#94a3b8' }, beginAtZero: true }
                }
              }
            });
          }
          
          // GrÃ¡fico de temas (top 10)
          const topTemas = temas.slice(0, 10);
          const labelsTemas = topTemas.map(t => t.tema || 'NÃ£o informado');
          const valoresTemas = topTemas.map(t => t.quantidade || 0);
          
          if (window.chartProjecaoTema instanceof Chart) window.chartProjecaoTema.destroy();
          const ctxTema = document.getElementById('chartProjecaoTema')?.getContext('2d');
          if (ctxTema) {
            window.chartProjecaoTema = new Chart(ctxTema, {
              type: 'bar',
              data: {
                labels: labelsTemas,
                datasets: [{
                  label: 'Quantidade',
                  data: valoresTemas,
                  backgroundColor: 'rgba(167,139,250,0.7)',
                  borderColor: 'rgba(167,139,250,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                indexAxis: 'y',
                plugins: {
                  legend: { display: false },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig()
                },
                scales: {
                  x: { beginAtZero: true, ticks: { color: '#94a3b8' } },
                  y: { ticks: { color: '#94a3b8' } }
                }
              }
            });
          }
          
          // GrÃ¡fico de status
          if (window.chartProjecaoStatus instanceof Chart) window.chartProjecaoStatus.destroy();
          const ctxStatus = document.getElementById('chartProjecaoStatus')?.getContext('2d');
          if (ctxStatus) {
            window.chartProjecaoStatus = new Chart(ctxStatus, {
              type: 'doughnut',
              data: {
                labels: ['ConcluÃ­da', 'Em atendimento'],
                datasets: [{
                  data: [status.concluida?.percentual || 0, status.emAtendimento?.percentual || 0],
                  backgroundColor: ['#38bdf8', '#fbbf24']
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: true, position: 'right', labels: { color: '#94a3b8' } },
                  tooltip: createEnhancedTooltip(),
                  datalabels: createDataLabelsConfig(true, 'doughnut')
                }
              }
            });
          }
          
          document.getElementById('projecaoStatusInfo').innerHTML = `
            <div class="text-cyan-300">ConcluÃ­da: ${status.concluida?.percentual || 0}%</div>
            <div class="text-amber-300">Em atendimento: ${status.emAtendimento?.percentual || 0}%</div>
          `;
          
          // Resumo de projeÃ§Ãµes
          const totalProjetado = projecao2026.reduce((sum, item) => sum + item.value, 0);
          const totalHistorico = historico.reduce((sum, item) => sum + item.value, 0);
          const crescimento = ((totalProjetado - totalHistorico) / totalHistorico * 100).toFixed(1);
          
          document.getElementById('resumoProjecao').innerHTML = `
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Total Projetado 2026</div>
              <div class="text-2xl font-bold text-cyan-300">${totalProjetado.toLocaleString('pt-BR')}</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">MÃ©dia Mensal</div>
              <div class="text-2xl font-bold text-violet-300">${Math.round(mediaMensal).toLocaleString('pt-BR')}</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Crescimento Estimado</div>
              <div class="text-2xl font-bold ${crescimento >= 0 ? 'text-emerald-300' : 'text-rose-300'}">${crescimento >= 0 ? '+' : ''}${crescimento}%</div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="text-slate-400 text-sm mb-1">Total HistÃ³rico</div>
              <div class="text-2xl font-bold text-amber-300">${totalHistorico.toLocaleString('pt-BR')}</div>
            </div>
          `;
        } catch (error) {
          console.error('âŒ Erro ao carregar projeÃ§Ã£o 2026:', error);
        }
      }

      async function loadUnit(unitName) {
        // Mapear nomes das unidades para os nomes no banco
        const unitMap = {
          'adao': 'ADÃƒO',
          'cer iv': 'CER IV',
          'hospital olho': 'Hospital do Olho',
          'hospital duque': 'Hospital Duque',
          'hospital infantil': 'Hospital Infantil',
          'hospital moacyr': 'Hospital Moacyr',
          'maternidade santa cruz': 'Maternidade Santa Cruz',
          'upa beira mar': 'UPA Beira Mar',
          'uph pilar': 'UPH Pilar',
          'uph saracuruna': 'UPH Saracuruna',
          'uph xerem': 'UPH XerÃ©m',
          'hospital veterinario': 'Hospital VeterinÃ¡rio',
          'upa walter garcia': 'UPA Walter Garcia',
          'uph campos eliseos': 'UPH Campos ElÃ­seos',
          'uph parque equitativa': 'UPH Parque Equitativa',
          'ubs antonio granja': 'UBS Antonio Granja',
          'upa sarapui': 'UPA SarapuÃ­',
          'uph imbarie': 'UPH ImbariÃª'
        };
        
        const searchName = unitMap[unitName.toLowerCase()] || unitName;
        const data = await fetchJSON(`/api/unit/${encodeURIComponent(searchName)}`);
        
        // Encontrar a seÃ§Ã£o da unidade
        const pageId = `page-unit-${unitName.replace(/\s+/g, '-').toLowerCase()}`;
        const section = document.getElementById(pageId);
        if (!section) return;
        
        const assuntosContainer = section.querySelector('.unit-assuntos');
        const tiposCanvas = section.querySelector('.unit-tipos');
        
        // Lista de assuntos
        const assuntos = data.assuntos || [];
        assuntosContainer.innerHTML = assuntos.map((item, idx) => {
          const width = assuntos.length > 0 ? (item.quantidade / Math.max(...assuntos.map(d => d.quantidade), 1)) * 100 : 0;
          return `
            <div class="flex items-center gap-3 py-2 border-b border-white/5">
              <div class="text-sm text-slate-400 w-8">${idx + 1}Âº</div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-slate-300 truncate">${item.assunto}</div>
                <div class="mt-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-violet-500" style="width: ${width}%"></div>
                </div>
              </div>
              <div class="text-lg font-bold text-cyan-300 min-w-[80px] text-right">${item.quantidade.toLocaleString('pt-BR')}</div>
            </div>
          `;
        }).join('');
        
        // GrÃ¡fico de tipos de aÃ§Ã£o
        const tipos = data.tipos || [];
        const labels = tipos.map(t => t.tipo);
        const values = tipos.map(t => t.quantidade);
        
        // Destruir grÃ¡fico anterior se existir
        const chartId = `chartUnit${unitName.replace(/\s+/g, '')}`;
        if (window[chartId] instanceof Chart) window[chartId].destroy();
        
        const ctx = tiposCanvas.getContext('2d');
        window[chartId] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: values,
              backgroundColor: 'rgba(34,211,238,0.7)',
              borderColor: 'rgba(34,211,238,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { 
              legend: { display: false },
              tooltip: createEnhancedTooltip(),
              datalabels: createDataLabelsConfig(false, 'bar', true)
            },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      }
    </script>
  </body>
  </html>



